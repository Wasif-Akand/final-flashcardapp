<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MonoFlash</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAXul0bzX2-X9qj3t51u6EjhZFFE7mi1ac",
            authDomain: "flashcards-fb9ab.firebaseapp.com",
            projectId: "flashcards-fb9ab",
            storageBucket: "flashcards-fb9ab.firebasestorage.app",
            messagingSenderId: "975345059409",
            appId: "1:975345059409:web:fb9048868da5afe6f45a70"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code === 'failed-precondition') {
                console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            } else if (err.code === 'unimplemented') {
                console.warn('The current browser does not support offline persistence');
            }
        });
        
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseReady = true;
    </script>
    
    <style>
        /* --- GOTHIC THEME VARIABLES --- */
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --surface-elevated: #121212;
            --border: #1a1a1a;
            --border-bright: #333333;
            --text: #ffffff;
            --text-dim: #666666;
            --text-dimmer: #444444;
            --accent: #ffffff;
            --success: #2ecc71;
            --error: #e74c3c;
            --warning: #f39c12;
            
            /* Gothic shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.8);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.9);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.95);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 1);
            
            /* Transitions */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            height: 100vh;
            height: 100dvh;
            display: flex;
            overflow: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Gothic texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.01) 2px,
                    rgba(255, 255, 255, 0.01) 4px
                );
            pointer-events: none;
            opacity: 0.3;
            z-index: 9999;
        }

        /* --- SIDEBAR (DRAWER) --- */
        #sidebar {
            width: 280px;
            background: var(--surface);
            border-right: 1px solid var(--border-bright);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: -280px;
            top: 0;
            bottom: 0;
            transition: left var(--transition-normal), box-shadow var(--transition-normal);
            z-index: 1000;
            box-shadow: var(--shadow-xl);
        }
        
        #sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-bright);
            background: linear-gradient(180deg, var(--surface-elevated) 0%, var(--surface) 100%);
        }
        
        .sidebar-header-title {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar-subtitle {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-weight: 400;
            letter-spacing: 0.5px;
            line-height: 1.4;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px 8px;
        }
        
        .sidebar-content::-webkit-scrollbar {
            width: 4px;
        }
        
        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--border-bright);
            border-radius: 2px;
        }
        
        .subject-item {
            margin-bottom: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--surface-elevated);
            transition: all var(--transition-fast);
        }
        
        .subject-item:hover {
            border-color: var(--border-bright);
            box-shadow: var(--shadow-sm);
        }
        
        .subject-title {
            font-weight: 700;
            padding: 14px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all var(--transition-fast);
            user-select: none;
        }
        
        .subject-title:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .subject-title:active {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .subject-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .chevron {
            font-size: 0.7rem;
            transition: transform var(--transition-normal);
            color: var(--text-dim);
        }
        
        .subject-item.expanded .chevron {
            transform: rotate(180deg);
        }
        
        .delete-icon {
            font-size: 1.2rem;
            color: var(--text-dimmer);
            transition: color var(--transition-fast);
            padding: 4px;
            cursor: pointer;
        }
        
        .delete-icon:hover {
            color: var(--error);
        }
        
        .sub-subject-list {
            border-left: 2px solid var(--border-bright);
            margin-left: 12px;
            display: none;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .sub-subject-list.show {
            display: block;
            animation: slideDown var(--transition-normal);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
        
        .sub-item {
            padding: 12px 16px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            transition: all var(--transition-fast);
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            position: relative;
        }
        
        .sub-item:last-child {
            border-bottom: none;
        }
        
        .sub-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            transform: scaleY(0);
            transition: transform var(--transition-fast);
        }
        
        .sub-item:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
            padding-left: 20px;
        }
        
        .sub-item:hover::before {
            transform: scaleY(1);
        }
        
        .sub-item.active {
            color: var(--text);
            background: rgba(255, 255, 255, 0.08);
            font-weight: 600;
            padding-left: 20px;
        }
        
        .sub-item.active::before {
            transform: scaleY(1);
        }
        
        .card-count {
            font-size: 0.7rem;
            color: var(--text-dimmer);
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            min-width: 32px;
            text-align: center;
        }

        .sync-btn-container {
            padding: 12px;
            border-top: 1px solid var(--border-bright);
            background: var(--surface-elevated);
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.5);
        }
        
        .sync-btn {
            width: 100%;
            padding: 12px;
            background: var(--surface);
            color: white;
            border: 1px solid var(--border-bright);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all var(--transition-fast);
            text-transform: uppercase;
        }
        
        .sync-btn:hover {
            background: var(--surface-elevated);
            border-color: var(--accent);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        .sync-btn:active {
            transform: translateY(0);
        }
        
        .sync-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: all var(--transition-fast);
        }
        
        .sync-status-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success), 0 0 16px rgba(46, 204, 113, 0.3);
            animation: pulse 2s infinite;
        }
        
        .sync-status-dot.offline {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }
        
        .sync-status-dot.error {
            background: var(--error);
            box-shadow: 0 0 8px var(--error);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }
        
        .device-id-display {
            font-size: 0.65rem;
            color: var(--text-dimmer);
            margin-top: 8px;
            text-align: center;
            font-family: 'Courier New', monospace;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            word-break: break-all;
        }
        
        .sync-help-text {
            font-size: 0.65rem;
            color: var(--text-dimmer);
            text-align: center;
            margin-top: 6px;
            line-height: 1.3;
        }

        .add-btn {
            padding: 12px;
            border: 1px dashed var(--border-bright);
            text-align: center;
            margin: 8px 8px 12px 8px;
            cursor: pointer;
            color: var(--text-dim);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all var(--transition-fast);
            text-transform: uppercase;
        }
        
        .add-btn:hover {
            color: var(--text);
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.03);
        }
        
        .add-btn:active {
            background: rgba(255, 255, 255, 0.05);
        }

        /* --- MAIN CONTENT --- */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            transition: opacity var(--transition-normal);
        }
        
        header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-bright);
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--surface);
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 10;
        }
        
        .menu-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            transition: all var(--transition-fast);
            padding: 8px;
            margin: -8px;
            user-select: none;
        }
        
        .menu-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }
        
        .menu-btn:active {
            transform: scale(0.95);
        }
        
        #header-title {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #content-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            position: relative;
        }
        
        #content-area::-webkit-scrollbar {
            width: 6px;
        }
        
        #content-area::-webkit-scrollbar-track {
            background: var(--surface);
        }
        
        #content-area::-webkit-scrollbar-thumb {
            background: var(--border-bright);
            border-radius: 3px;
        }
        
        /* --- TABS --- */
        .tab-view {
            display: none;
            height: 100%;
            animation: fadeIn var(--transition-normal);
        }
        
        .tab-view.active {
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- FLASHCARD STYLES --- */
        .flashcard-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1600px;
            padding: 20px 0;
        }
        
        .card {
            width: 100%;
            max-width: 380px;
            height: 280px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform var(--transition-slow), box-shadow var(--transition-normal);
            cursor: pointer;
            box-shadow: var(--shadow-lg);
        }
        
        .card:hover {
            box-shadow: var(--shadow-xl);
        }
        
        .card.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            border: 2px solid var(--border-bright);
            border-radius: 16px;
            background: var(--surface-elevated);
            padding: 32px 24px;
            font-size: 1.3rem;
            font-weight: 500;
            line-height: 1.5;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }
        
        .card-face::-webkit-scrollbar {
            width: 4px;
        }
        
        .card-face::-webkit-scrollbar-thumb {
            background: var(--border-bright);
            border-radius: 2px;
        }
        
        .card-back {
            transform: rotateY(180deg);
            background: #050505;
            border-color: var(--accent);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8), 0 0 24px rgba(255, 255, 255, 0.1);
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            padding: 0 20px;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 10px;
            border: 1px solid var(--border-bright);
            background: var(--surface);
            color: white;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: var(--shadow-sm);
            user-select: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            background: var(--surface-elevated);
            box-shadow: var(--shadow-md);
            border-color: var(--accent);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ffffff 0%, #cccccc 100%);
            color: black;
            border: none;
            box-shadow: var(--shadow-md), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #f5f5f5 0%, #bbbbbb 100%);
            box-shadow: var(--shadow-lg), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 4px;
        }

        /* --- DATABASE STYLES --- */
        textarea {
            width: 100%;
            min-height: 120px;
            background: var(--surface-elevated);
            color: var(--text);
            border: 1px solid var(--border-bright);
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            resize: vertical;
            transition: all var(--transition-fast);
            line-height: 1.6;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }
        
        textarea::placeholder {
            color: var(--text-dimmer);
        }
        
        .db-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-bright);
        }
        
        .db-subtitle {
            color: var(--text-dim);
            font-size: 0.75rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .db-button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .db-button-group .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            font-size: 0.8rem;
        }
        
        .db-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            margin-top: 32px;
        }
        
        .db-list-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .db-item {
            padding: 16px;
            border: 1px solid var(--border);
            background: var(--surface-elevated);
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            transition: all var(--transition-fast);
        }
        
        .db-item:hover {
            border-color: var(--border-bright);
            box-shadow: var(--shadow-sm);
        }
        
        .db-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .db-key {
            font-weight: 700;
            margin-bottom: 6px;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        
        .db-value {
            color: var(--text-dim);
            font-size: 0.85rem;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* --- PERFORMANCE STYLES --- */
        .stat-box {
            border: 1px solid var(--border-bright);
            padding: 24px;
            margin-bottom: 12px;
            border-radius: 12px;
            text-align: center;
            background: var(--surface-elevated);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }
        
        .stat-box:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .stat-box.highlight {
            border-color: var(--accent);
            box-shadow: 0 0 16px rgba(255, 255, 255, 0.1);
        }
        
        .stat-num {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .container-stat {
            border: 1px solid var(--border);
            padding: 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: var(--surface-elevated);
            transition: all var(--transition-fast);
        }
        
        .container-stat:hover {
            border-color: var(--border-bright);
            box-shadow: var(--shadow-sm);
        }
        
        .container-stat-header {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        
        .container-stat-detail {
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        /* --- CONTAINER SELECTOR --- */
        .container-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 10px;
            border: 1px solid var(--border-bright);
            border-radius: 10px;
            background: var(--surface-elevated);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .container-btn {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            transition: all var(--transition-fast);
            white-space: nowrap;
            text-transform: uppercase;
            user-select: none;
        }
        
        .container-btn:hover {
            background: var(--surface-elevated);
            color: var(--text);
            border-color: var(--border-bright);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .container-btn.active {
            background: linear-gradient(135deg, #ffffff 0%, #cccccc 100%);
            color: black;
            border-color: var(--accent);
            box-shadow: var(--shadow-sm), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .container-info {
            font-size: 0.7rem;
            color: var(--text-dimmer);
            margin-top: 8px;
            width: 100%;
            text-align: center;
            letter-spacing: 0.3px;
        }

        /* --- BOTTOM NAV --- */
        nav {
            display: flex;
            border-top: 1px solid var(--border-bright);
            padding-bottom: env(safe-area-inset-bottom);
            background: var(--surface);
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 10;
        }
        
        .nav-item {
            flex: 1;
            padding: 16px 12px;
            text-align: center;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            border-top: 2px solid transparent;
            transition: all var(--transition-fast);
            text-transform: uppercase;
            user-select: none;
            position: relative;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 60%;
            height: 2px;
            background: var(--accent);
            transition: transform var(--transition-normal);
        }
        
        .nav-item:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.03);
        }
        
        .nav-item.active {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        /* --- OVERLAY --- */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 900;
            display: none;
            transition: opacity var(--transition-normal);
        }
        
        #overlay.show {
            display: block;
            animation: fadeIn var(--transition-normal);
        }

        /* --- LOADING STATE --- */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-bright);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- RESPONSIVE TWEAKS --- */
        @media (max-width: 480px) {
            .sidebar-header {
                padding: 20px 16px;
            }
            
            .sidebar-header-title {
                font-size: 1.2rem;
                letter-spacing: 1.5px;
            }
            
            #sidebar {
                width: 260px;
                left: -260px;
            }
            
            header {
                padding: 14px 16px;
            }
            
            #header-title {
                font-size: 0.9rem;
            }
            
            #content-area {
                padding: 16px;
            }
            
            .flashcard-container {
                padding: 12px 0;
            }
            
            .card {
                max-width: 100%;
                height: 240px;
            }
            
            .card-face {
                font-size: 1.1rem;
                padding: 24px 20px;
            }
            
            .controls {
                gap: 10px;
                margin-top: 16px;
                padding: 0 12px;
            }
            
            .btn {
                flex: 1;
                padding: 12px 20px;
                font-size: 0.8rem;
                max-width: 160px;
            }
            
            .container-selector {
                padding: 8px;
                gap: 5px;
                margin-bottom: 12px;
            }
            
            .container-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
            
            .container-info {
                font-size: 0.65rem;
                margin-top: 6px;
            }
            
            .stat-box {
                padding: 20px;
            }
            
            .stat-num {
                font-size: 2rem;
            }
            
            .db-button-group {
                flex-direction: column;
            }
            
            .db-button-group .btn {
                width: 100%;
            }
            
            nav {
                padding-bottom: max(env(safe-area-inset-bottom), 8px);
            }
            
            .nav-item {
                padding: 14px 8px;
                font-size: 0.7rem;
            }
        }
        
        /* iPhone 6s specific (375x667) */
        @media (max-width: 375px) {
            .sidebar-header-title {
                font-size: 1.1rem;
            }
            
            .card {
                height: 220px;
            }
            
            .card-face {
                font-size: 1rem;
                padding: 20px 16px;
            }
            
            .stat-num {
                font-size: 1.8rem;
            }
        }
        
        /* Landscape mode */
        @media (max-height: 500px) and (orientation: landscape) {
            .card {
                height: 180px;
                max-width: 320px;
            }
            
            .card-face {
                font-size: 0.95rem;
                padding: 16px;
            }
            
            .controls {
                margin-top: 12px;
            }
            
            .flashcard-container {
                padding: 8px 0;
            }
        }
    </style>
</head>
<body>

    <div id="overlay" onclick="toggleSidebar()"></div>
    
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-title">MonoFlash</div>
            <div class="sidebar-subtitle">ðŸ“¦ Cards sync across devices<br>ðŸ“Š Progress stays local</div>
        </div>
        <div class="sidebar-content" id="subject-list">
            <!-- Subjects load here -->
        </div>
        
        <div class="add-btn" onclick="addNewSubject()">+ Add Subject</div>
        
        <div class="sync-btn-container">
            <button class="sync-btn" onclick="manualSync()">
                <div class="sync-status-dot" id="sync-dot"></div>
                <span id="sync-text">Sync Cards</span>
            </button>
            <button class="sync-btn" onclick="changeSyncId()">
                <span>ðŸ”— Link Device</span>
            </button>
            <div class="device-id-display">
                ID: <span id="current-device-id">...</span>
            </div>
            <div class="sync-help-text" id="sync-help">Checking connection...</div>
        </div>
    </aside>

    <main id="main">
        <header>
            <div class="menu-btn" onclick="toggleSidebar()" aria-label="Menu">â˜°</div>
            <h1 id="header-title">Select a Subject</h1>
        </header>

        <section id="content-area">
            
            <div id="tab-flashcard" class="tab-view active">
                <div class="container-selector" id="container-selector" style="display: none;"></div>
                
                <div class="flashcard-container">
                    <div class="card" onclick="flipCard()" id="active-card">
                        <div class="card-face card-front" id="card-front">Select a topic to begin</div>
                        <div class="card-face card-back" id="card-back">Your journey starts here</div>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn" onclick="nextCard(false)">Missed</button>
                    <button class="btn btn-primary" onclick="nextCard(true)">Got it</button>
                </div>
            </div>

            <div id="tab-performance" class="tab-view">
                <div class="stat-box">
                    <div class="stat-num" id="stat-total">0</div>
                    <div class="stat-label">Cards Reviewed</div>
                </div>
                <div class="stat-box highlight">
                    <div class="stat-num" id="stat-score">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="stat-due">-</div>
                    <div class="stat-label">Cards Due Today</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="stat-mastered">-</div>
                    <div class="stat-label">Mastered (7+ days)</div>
                </div>
                
                <div id="container-stats" style="margin-top: 24px;"></div>
            </div>

            <div id="tab-database" class="tab-view">
                <h3 class="db-section-title">Add Data</h3>
                <p class="db-subtitle">Format: Question -!- Answer (one per line)<br>OR JSON: [{"q":"Front", "a":"Back"}]</p>
                <textarea id="json-input" placeholder='What is gravity? -!- Force that attracts objects
What is speed? -!- Distance over time'></textarea>
                <input id="file-input" type="file" accept="application/json,.json" style="display:none" onchange="importJsonFile(event)">
                <div class="db-button-group">
                    <button class="btn btn-primary" onclick="importJson()">Import Data</button>
                    <button class="btn" onclick="exportJson()">Export JSON</button>
                    <button class="btn" onclick="document.getElementById('file-input').click()">Import File</button>
                </div>
                
                <div class="db-list-header">
                    <h3>Current Entries</h3>
                    <button class="btn" onclick="clearAllCards()" style="padding: 8px 16px; font-size: 0.75rem;">Clear All</button>
                </div>
                <div id="db-list"></div>
            </div>

        </section>

        <nav>
            <div class="nav-item active" onclick="switchTab('flashcard', this)">Cards</div>
            <div class="nav-item" onclick="switchTab('performance', this)">Stats</div>
            <div class="nav-item" onclick="switchTab('database', this)">Data</div>
        </nav>
    </main>

    <script>
        // ==================== DEVICE ID & FIREBASE SYNC ====================
        
        console.log('ðŸŽ‰ MonoFlash initialized!');
        console.log('ðŸ“¦ Card content syncs to Firebase');
        console.log('ðŸ“Š SRS progress stays local');
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('monoFlashDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('monoFlashDeviceId', deviceId);
            }
            return deviceId;
        }
        
        const DEVICE_ID = getDeviceId();
        console.log('ðŸ”‘ Device ID:', DEVICE_ID);
        document.getElementById('current-device-id').textContent = DEVICE_ID;
        
        function changeSyncId() {
            const newId = prompt("Enter a Sync Name (e.g. 'my-flashcards').\n\nIMPORTANT: Use the EXACT same name on your other devices to sync data.", DEVICE_ID);
            if (newId && newId.trim() !== "") {
                const cleanId = newId.trim();
                localStorage.setItem('monoFlashDeviceId', cleanId);
                alert("Device Linked! The page will reload to sync data.");
                location.reload();
            }
        }

        let syncInProgress = false;
        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');
        const syncHelp = document.getElementById('sync-help');
        
        // ==================== DATA STRUCTURE ====================
        
        let cardContent = JSON.parse(localStorage.getItem('monoFlashCardContent')) || {};
        let srsData = JSON.parse(localStorage.getItem('monoFlashSRSData')) || {};
        
        let currentSubject = null;
        let currentSub = null;
        let cardIndex = 0;
        let sessionStats = { total: 0, correct: 0 };
        let shuffledCards = [];
        let dueCards = [];
        
        const CARDS_PER_CONTAINER = 20;
        let currentContainer = 'all';
        let reviewMissedMode = false;
        let missedCardsThisSession = new Set();

        // ==================== SRS FUNCTIONS ====================
        
        function createDefaultSRS() {
            return {
                interval: 0,
                easiness: 2.5,
                repetitions: 0,
                nextReview: Date.now(),
                lastReviewed: null
            };
        }

        function initializeSRS(srsObj) {
            if (!srsObj || typeof srsObj !== 'object') {
                return createDefaultSRS();
            }
            if (!srsObj.interval) srsObj.interval = 0;
            if (!srsObj.easiness) srsObj.easiness = 2.5;
            if (!srsObj.repetitions) srsObj.repetitions = 0;
            if (!srsObj.nextReview) srsObj.nextReview = Date.now();
            return srsObj;
        }

        function updateSRS(srsObj, quality) {
            const now = Date.now();
            srsObj.lastReviewed = now;
            
            if (quality === 0) {
                srsObj.repetitions = 0;
                srsObj.interval = 1;
            } else {
                srsObj.repetitions += 1;
                
                if (srsObj.repetitions === 1) {
                    srsObj.interval = 1;
                } else if (srsObj.repetitions === 2) {
                    srsObj.interval = 6;
                } else {
                    srsObj.interval = Math.round(srsObj.interval * srsObj.easiness);
                }
                
                srsObj.easiness = Math.max(1.3, srsObj.easiness + (0.1 - (1 - quality) * 0.2));
            }
            
            srsObj.nextReview = now + (srsObj.interval * 24 * 60 * 60 * 1000);
            return srsObj;
        }

        function isDue(srsObj) {
            if (!srsObj || !srsObj.nextReview) return true;
            return Date.now() >= srsObj.nextReview;
        }

        // ==================== DATA MANAGEMENT ====================
        
        function ensureSRSDataExists() {
            for (let subject in cardContent) {
                if (!srsData[subject]) srsData[subject] = {};
                
                for (let sub in cardContent[subject]) {
                    if (!srsData[subject][sub]) srsData[subject][sub] = [];
                    
                    const cardCount = cardContent[subject][sub].length;
                    const srsCount = srsData[subject][sub].length;
                    
                    if (srsCount < cardCount) {
                        for (let i = srsCount; i < cardCount; i++) {
                            srsData[subject][sub].push(createDefaultSRS());
                        }
                    }
                }
            }
        }

        function saveData() {
            ensureSRSDataExists();
            localStorage.setItem('monoFlashCardContent', JSON.stringify(cardContent));
            localStorage.setItem('monoFlashSRSData', JSON.stringify(srsData));
        }

        // ==================== FIREBASE SYNC ====================
        
        async function syncToCloud() {
            if (syncInProgress) return;
            
            if (!window.firebaseReady || !window.firebaseDB) {
                console.log('âš ï¸ Firebase not ready, skipping sync');
                syncDot.className = 'sync-status-dot offline';
                syncText.textContent = "Offline Mode";
                syncHelp.textContent = "Working locally. Sync when online.";
                return;
            }
            
            try {
                syncInProgress = true;
                syncDot.className = 'sync-status-dot';
                syncText.innerHTML = '<span class="loading-spinner"></span> Syncing...';
                syncHelp.textContent = 'Uploading to cloud...';
                
                const docRef = window.firebaseDoc(window.firebaseDB, 'flashcards', DEVICE_ID);
                
                // Use merge option to avoid overwriting
                await window.firebaseSetDoc(docRef, {
                    cardContent: cardContent,
                    lastSync: Date.now(),
                    deviceId: DEVICE_ID
                }, { merge: true });
                
                console.log('âœ… Synced card content to cloud');
                syncDot.className = 'sync-status-dot online';
                syncText.textContent = "Synced âœ“";
                syncHelp.textContent = "All data backed up to cloud";
                
                setTimeout(() => {
                    if (syncText.textContent === "Synced âœ“") {
                        syncText.textContent = "Sync Cards";
                    }
                }, 2000);
            } catch (error) {
                console.error('âŒ Sync error:', error);
                syncDot.className = 'sync-status-dot error';
                syncText.textContent = "Sync Failed";
                
                if (error.code === 'permission-denied') {
                    syncHelp.textContent = "Permission denied. Check Firebase rules.";
                    console.error('ðŸ”’ FIREBASE PERMISSION ERROR - See instructions below');
                } else if (error.code === 'unavailable') {
                    syncDot.className = 'sync-status-dot offline';
                    syncHelp.textContent = "No internet. Working offline.";
                } else {
                    syncHelp.textContent = error.message || "Sync error occurred";
                }
                
                setTimeout(() => {
                    syncText.textContent = "Sync Cards";
                }, 3000);
            } finally {
                syncInProgress = false;
            }
        }
        
        async function loadFromCloud() {
            if (!window.firebaseReady || !window.firebaseDB) {
                console.log('âš ï¸ Firebase not ready, using localStorage only');
                syncDot.className = 'sync-status-dot offline';
                syncHelp.textContent = "Offline mode - data stored locally";
                return;
            }
            
            try {
                syncHelp.textContent = 'Checking for cloud data...';
                
                const docRef = window.firebaseDoc(window.firebaseDB, 'flashcards', DEVICE_ID);
                const docSnap = await window.firebaseGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    
                    if (cloudData.cardContent) {
                        const localTimestamp = JSON.parse(localStorage.getItem('monoFlashCardContent_timestamp') || '0');
                        const cloudTimestamp = cloudData.lastSync || 0;
                        
                        if (cloudTimestamp > localTimestamp) {
                            cardContent = cloudData.cardContent;
                            localStorage.setItem('monoFlashCardContent', JSON.stringify(cardContent));
                            localStorage.setItem('monoFlashCardContent_timestamp', JSON.stringify(cloudTimestamp));
                            console.log('ðŸ“¥ Loaded newer card content from cloud');
                            syncHelp.textContent = "Loaded data from cloud";
                        } else {
                            console.log('ðŸ“¦ Local card content is up to date');
                            syncHelp.textContent = "Local data is current";
                        }
                    }
                    
                    ensureSRSDataExists();
                    saveData();
                    renderSidebar();
                    
                    syncDot.className = 'sync-status-dot online';
                } else {
                    console.log('ðŸ“¤ No cloud data found, will sync local data');
                    syncHelp.textContent = "Ready to sync";
                    syncToCloud();
                }
            } catch (error) {
                console.error('âš ï¸ Error loading from cloud:', error);
                
                if (error.code === 'unavailable' || error.message.includes('offline')) {
                    syncDot.className = 'sync-status-dot offline';
                    syncHelp.textContent = "No internet. Working offline.";
                } else if (error.code === 'permission-denied') {
                    syncDot.className = 'sync-status-dot error';
                    syncHelp.textContent = "Permission denied. Check Firebase rules.";
                } else {
                    syncDot.className = 'sync-status-dot error';
                    syncHelp.textContent = "Connection error. Using local data.";
                }
            }
        }

        function manualSync() {
            syncToCloud();
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function safeId(name) {
            return String(name || '').trim().toLowerCase().replace(/[^a-z0-9_-]+/g, '-');
        }

        function isValidCardArray(arr) {
            if (!Array.isArray(arr)) return false;
            return arr.every(c => c && typeof c === 'object' && typeof c.q === 'string' && typeof c.a === 'string');
        }

        function parseTextFormat(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const cards = [];
            for (let line of lines) {
                if (line.includes('-!-')) {
                    const parts = line.split('-!-');
                    if (parts.length >= 2) {
                        const q = parts[0].trim();
                        const a = parts.slice(1).join('-!-').trim();
                        if (q && a) {
                            cards.push({q, a});
                        }
                    }
                }
            }
            return cards;
        }

        // ==================== SIDEBAR FUNCTIONS ====================
        
        function renderSidebar() {
            const list = document.getElementById('subject-list');
            list.innerHTML = '';
            
            for (let subject in cardContent) {
                const item = document.createElement('div');
                item.className = 'subject-item';
                
                const title = document.createElement('div');
                title.className = 'subject-title';
                
                const titleText = document.createElement('span');
                titleText.textContent = subject;
                titleText.onclick = () => toggleSubject(subject);
                title.appendChild(titleText);
                
                const actions = document.createElement('div');
                actions.className = 'subject-actions';
                
                const chevron = document.createElement('span');
                chevron.className = 'chevron';
                chevron.textContent = 'â–¼';
                chevron.onclick = () => toggleSubject(subject);
                actions.appendChild(chevron);
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-icon';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteSubject(subject);
                };
                actions.appendChild(deleteBtn);
                
                title.appendChild(actions);
                item.appendChild(title);
                
                const subList = document.createElement('div');
                subList.className = 'sub-subject-list';
                subList.id = 'sub-' + safeId(subject);
                
                for (let sub in cardContent[subject]) {
                    const subItem = document.createElement('div');
                    subItem.className = 'sub-item';
                    
                    const cardCount = cardContent[subject][sub].length;
                    
                    const subText = document.createElement('span');
                    subText.innerHTML = `${sub} <span class="card-count">${cardCount}</span>`;
                    subText.onclick = () => loadTopic(subject, sub);
                    subItem.appendChild(subText);
                    
                    const subDeleteBtn = document.createElement('span');
                    subDeleteBtn.className = 'delete-icon';
                    subDeleteBtn.textContent = 'Ã—';
                    subDeleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSub(subject, sub);
                    };
                    subItem.appendChild(subDeleteBtn);
                    
                    subList.appendChild(subItem);
                }
                
                const addSubBtn = document.createElement('div');
                addSubBtn.className = 'add-btn';
                addSubBtn.textContent = '+ Add Topic';
                addSubBtn.style.margin = '8px';
                addSubBtn.onclick = () => addNewSub(subject);
                subList.appendChild(addSubBtn);
                
                item.appendChild(subList);
                list.appendChild(item);
            }
        }

        function toggleSubject(subject) {
            const subList = document.getElementById('sub-' + safeId(subject));
            const item = subList?.parentElement;
            if (subList && item) {
                subList.classList.toggle('show');
                item.classList.toggle('expanded');
                saveSidebarState();
            }
        }

        function saveSidebarState() {
            const openSubjects = [];
            document.querySelectorAll('.sub-subject-list.show').forEach(el => {
                const id = el.id.replace('sub-', '');
                openSubjects.push(id);
            });
            localStorage.setItem('monoFlashSidebarState', JSON.stringify(openSubjects));
        }

        function loadSidebarState() {
            const saved = localStorage.getItem('monoFlashSidebarState');
            if (saved) {
                try {
                    const openSubjects = JSON.parse(saved);
                    openSubjects.forEach(id => {
                        const el = document.getElementById('sub-' + id);
                        if (el) {
                            el.classList.add('show');
                            el.parentElement?.classList.add('expanded');
                        }
                    });
                } catch (e) {
                    console.error('Error loading sidebar state:', e);
                }
            }
        }

        function addNewSubject() {
            const name = prompt("Enter new Subject name:");
            if (name && name.trim() !== "") {
                const trimmed = name.trim();
                if (!cardContent[trimmed]) {
                    cardContent[trimmed] = {};
                    saveData();
                    syncToCloud();
                    renderSidebar();
                    loadSidebarState();
                }
            }
        }

        function addNewSub(subject) {
            const name = prompt("Enter new Topic name for " + subject + ":");
            if (name && name.trim() !== "") {
                const trimmed = name.trim();
                if (!cardContent[subject][trimmed]) {
                    cardContent[subject][trimmed] = [];
                    saveData();
                    syncToCloud();
                    renderSidebar();
                    loadSidebarState();
                }
            }
        }

        function deleteSubject(subject) {
            if (confirm("Delete entire subject '" + subject + "'? This will delete all topics and cards inside it.")) {
                delete cardContent[subject];
                delete srsData[subject];
                if (currentSubject === subject) {
                    currentSubject = null;
                    currentSub = null;
                    document.getElementById('header-title').textContent = 'Select a Subject';
                    renderCard();
                }
                saveData();
                syncToCloud();
                renderSidebar();
                renderDbList();
            }
        }

        function deleteSub(subject, sub) {
            if (confirm("Delete topic '" + sub + "' and all its cards?")) {
                delete cardContent[subject][sub];
                if (srsData[subject]) delete srsData[subject][sub];
                if (currentSubject === subject && currentSub === sub) {
                    currentSub = null;
                    document.getElementById('header-title').textContent = subject;
                    renderCard();
                }
                saveData();
                syncToCloud();
                renderSidebar();
                renderDbList();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        }

        // ==================== FLASHCARD FUNCTIONS ====================
        
        function loadTopic(subject, sub) {
            currentSubject = subject;
            currentSub = sub;
            currentContainer = 'all';
            reviewMissedMode = false;
            missedCardsThisSession.clear();
            cardIndex = 0;
            sessionStats = { total: 0, correct: 0 };
            
            document.getElementById('header-title').textContent = subject + " â€º " + sub;
            
            ensureSRSDataExists();
            
            if (cardContent[subject] && cardContent[subject][sub]) {
                const cards = cardContent[subject][sub];
                const srs = srsData[subject][sub];
                
                const cardsWithSRS = cards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[i],
                    _index: i
                }));
                
                dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
            } else {
                shuffledCards = [];
            }
            
            renderCard();
            updateStats();
            renderDbList();
            renderContainerSelector();
            
            document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.sub-item')?.classList.add('active');
            
            toggleSidebar();
        }

        function renderCard() {
            const front = document.getElementById('card-front');
            const back = document.getElementById('card-back');
            const card = document.getElementById('active-card');
            
            card.classList.remove('flipped');
            
            if (shuffledCards.length === 0 || cardIndex >= shuffledCards.length) {
                front.textContent = currentSubject && currentSub ? "No cards available" : "Select a topic to begin";
                back.textContent = currentSubject && currentSub ? "Add some cards in the Data tab" : "Your journey starts here";
                return;
            }
            
            const current = shuffledCards[cardIndex];
            front.textContent = current.q;
            back.textContent = current.a;
        }

        function flipCard() {
            if (shuffledCards.length === 0 || cardIndex >= shuffledCards.length) return;
            document.getElementById('active-card').classList.toggle('flipped');
        }

        function nextCard(isCorrect) {
            if (!currentSubject || !currentSub || shuffledCards.length === 0 || cardIndex >= shuffledCards.length) return;
            
            const current = shuffledCards[cardIndex];
            const originalIndex = current._index;
            
            updateSRS(current.srs, isCorrect ? 1 : 0);
            
            if (!isCorrect) {
                missedCardsThisSession.add(originalIndex);
            }
            
            saveData();
            
            sessionStats.total++;
            if (isCorrect) sessionStats.correct++;
            updateStats();
            renderContainerSelector();
            
            cardIndex++;
            renderCard();
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = sessionStats.total;
            const percentage = sessionStats.total === 0 ? 0 : Math.round((sessionStats.correct / sessionStats.total) * 100);
            document.getElementById('stat-score').innerText = percentage + "%";
            
            if (currentSubject && currentSub && cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                const cards = cardContent[currentSubject][currentSub];
                const srs = srsData[currentSubject][currentSub];
                
                const dueCount = srs.filter(s => isDue(s)).length;
                const masteredCount = srs.filter(s => s.interval >= 7).length;
                
                document.getElementById('stat-due').innerText = dueCount;
                document.getElementById('stat-mastered').innerText = masteredCount;
                renderContainerStats(cards);
            } else {
                document.getElementById('stat-due').innerText = '-';
                document.getElementById('stat-mastered').innerText = '-';
                document.getElementById('container-stats').innerHTML = '';
            }
        }

        // ==================== DATABASE FUNCTIONS ====================
        
        function importJson() {
            if (!currentSubject || !currentSub) {
                alert("Please select a Subject and Topic from the sidebar first.");
                return;
            }

            const input = document.getElementById('json-input').value.trim();
            if (!input) {
                alert("Please enter some data first.");
                return;
            }
            
            let newCards = [];
            if (input.includes('-!-')) {
                newCards = parseTextFormat(input);
                if (newCards.length === 0) {
                    alert('No valid cards found. Make sure to use format: Question -!- Answer');
                    return;
                }
            } else {
                try {
                    newCards = JSON.parse(input);
                    if (!isValidCardArray(newCards)) {
                        alert('Invalid JSON format. Use: [{"q":"Question", "a":"Answer"}] OR text format: Question -!- Answer');
                        return;
                    }
                } catch (e) {
                    alert("Invalid format. Use either:\n\nText: Question -!- Answer\nor\nJSON: [{\"q\":\"Question\", \"a\":\"Answer\"}]");
                    return;
                }
            }

            if (!Array.isArray(cardContent[currentSubject][currentSub])) {
                cardContent[currentSubject][currentSub] = [];
            }

            const existingCards = cardContent[currentSubject][currentSub];
            let addedCount = 0;
            let duplicateCount = 0;
            
            newCards.forEach(newCard => {
                const isDuplicate = existingCards.some(existing => 
                    existing.q.trim().toLowerCase() === newCard.q.trim().toLowerCase()
                );
                
                if (!isDuplicate) {
                    existingCards.push(newCard);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            });

            ensureSRSDataExists();
            saveData();
            syncToCloud();
            
            let message = `Added ${addedCount} card${addedCount !== 1 ? 's' : ''}!`;
            if (duplicateCount > 0) {
                message += `\n${duplicateCount} duplicate${duplicateCount !== 1 ? 's' : ''} skipped.`;
            }
            alert(message);
            
            if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                const cards = cardContent[currentSubject][currentSub];
                const srs = srsData[currentSubject][currentSub];
                
                const cardsWithSRS = cards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[i],
                    _index: i
                }));
                
                dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
            }
            
            document.getElementById('json-input').value = '';
            renderDbList();
            renderCard();
            renderSidebar();
        }

        function importJsonFile(e) {
            if (!currentSubject || !currentSub) {
                alert("Please select a Subject and Topic from the sidebar first.");
                if (e && e.target) e.target.value = '';
                return;
            }
            
            const file = (e && e.target && e.target.files && e.target.files[0]) || null;
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const parsed = JSON.parse(String(ev.target.result));
                    if (!isValidCardArray(parsed)) {
                        alert('Invalid JSON shape in file. Provide an array of {q:string,a:string}.');
                        return;
                    }

                    if (!Array.isArray(cardContent[currentSubject][currentSub])) {
                        cardContent[currentSubject][currentSub] = [];
                    }
                    
                    const existingCards = cardContent[currentSubject][currentSub];
                    let addedCount = 0;
                    let duplicateCount = 0;
                    
                    parsed.forEach(newCard => {
                        const isDuplicate = existingCards.some(existing => 
                            existing.q.trim().toLowerCase() === newCard.q.trim().toLowerCase()
                        );
                        
                        if (!isDuplicate) {
                            existingCards.push(newCard);
                            addedCount++;
                        } else {
                            duplicateCount++;
                        }
                    });
                    
                    ensureSRSDataExists();
                    saveData();
                    syncToCloud();
                    
                    let message = `Imported ${addedCount} card${addedCount !== 1 ? 's' : ''} from file.`;
                    if (duplicateCount > 0) {
                        message += `\n${duplicateCount} duplicate${duplicateCount !== 1 ? 's' : ''} skipped.`;
                    }
                    alert(message);
                    
                    if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                        const cards = cardContent[currentSubject][currentSub];
                        const srs = srsData[currentSubject][currentSub];
                        
                        const cardsWithSRS = cards.map((card, i) => ({
                            q: card.q,
                            a: card.a,
                            srs: srs[i],
                            _index: i
                        }));
                        
                        dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                        shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
                    }
                    
                    renderDbList();
                    renderCard();
                    renderSidebar();
                } catch (err) {
                    alert('Unable to parse JSON file.');
                } finally {
                    if (e && e.target) e.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function exportJson() {
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !Array.isArray(cardContent[currentSubject][currentSub])) {
                alert('Select a Subject and Topic first to export.');
                return;
            }
            
            const data = cardContent[currentSubject][currentSub];
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = `${safeId(currentSubject)}-${safeId(currentSub)}.json`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function renderDbList() {
            const list = document.getElementById('db-list');
            list.innerHTML = '';
            
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !Array.isArray(cardContent[currentSubject][currentSub])) return;

            const cards = cardContent[currentSubject][currentSub];
            cards.forEach((c, idx) => {
                const item = document.createElement('div');
                item.className = 'db-item';
                
                const content = document.createElement('div');
                content.className = 'db-item-content';
                content.innerHTML = `
                    <div class="db-key">${c.q}</div>
                    <div class="db-value">${c.a}</div>
                `;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn';
                deleteBtn.style.padding = '6px 12px';
                deleteBtn.style.fontSize = '0.75rem';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteCard(idx);
                
                item.appendChild(content);
                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }

        function deleteCard(index) {
            if (!currentSubject || !currentSub) return;
            
            if (confirm("Delete this card?")) {
                cardContent[currentSubject][currentSub].splice(index, 1);
                if (srsData[currentSubject] && srsData[currentSubject][currentSub]) {
                    srsData[currentSubject][currentSub].splice(index, 1);
                }
                
                saveData();
                syncToCloud();
                renderDbList();
                renderSidebar();
                
                if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                    const cards = cardContent[currentSubject][currentSub];
                    const srs = srsData[currentSubject][currentSub];
                    
                    const cardsWithSRS = cards.map((card, i) => ({
                        q: card.q,
                        a: card.a,
                        srs: srs[i],
                        _index: i
                    }));
                    
                    dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                    shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
                }
                
                renderCard();
            }
        }

        function clearAllCards() {
            if (!currentSubject || !currentSub) {
                alert("Please select a subject and topic first.");
                return;
            }
            
            if (confirm("Clear all cards in " + currentSubject + " > " + currentSub + "?")) {
                cardContent[currentSubject][currentSub] = [];
                if (srsData[currentSubject] && srsData[currentSubject][currentSub]) {
                    srsData[currentSubject][currentSub] = [];
                }
                
                saveData();
                syncToCloud();
                renderDbList();
                renderSidebar();
                shuffledCards = [];
                renderCard();
            }
        }

        // ==================== CONTAINER FUNCTIONS ====================
        
        function getContainerForIndex(index) {
            return Math.floor(index / CARDS_PER_CONTAINER);
        }
        
        function getContainerCards(containerNum) {
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !cardContent[currentSubject][currentSub]) {
                return [];
            }
            const allCards = cardContent[currentSubject][currentSub];
            const startIdx = containerNum * CARDS_PER_CONTAINER;
            const endIdx = Math.min(startIdx + CARDS_PER_CONTAINER, allCards.length);
            return allCards.slice(startIdx, endIdx);
        }
        
        function renderContainerSelector() {
            const container = document.getElementById('container-selector');
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !cardContent[currentSubject][currentSub]) {
                container.style.display = 'none';
                return;
            }
            const allCards = cardContent[currentSubject][currentSub];
            const numContainers = Math.ceil(allCards.length / CARDS_PER_CONTAINER);
            
            if (allCards.length <= CARDS_PER_CONTAINER) {
                container.style.display = 'none';
            } else {
                container.style.display = 'flex';
                container.innerHTML = '';
                
                const missedBtn = document.createElement('button');
                missedBtn.className = 'container-btn' + (reviewMissedMode ? ' active' : '');
                missedBtn.textContent = `Missed (${missedCardsThisSession.size})`;
                missedBtn.onclick = () => toggleReviewMissed();
                missedBtn.id = 'review-missed-btn';
                container.appendChild(missedBtn);
                
                const allBtn = document.createElement('button');
                allBtn.className = 'container-btn' + (currentContainer === 'all' && !reviewMissedMode ? ' active' : '');
                allBtn.textContent = 'All';
                allBtn.onclick = () => selectContainer('all');
                container.appendChild(allBtn);
                
                for (let i = 0; i < numContainers; i++) {
                    const btn = document.createElement('button');
                    const startIdx = i * CARDS_PER_CONTAINER;
                    const endIdx = Math.min(startIdx + CARDS_PER_CONTAINER, allCards.length);
                    const count = endIdx - startIdx;
                    btn.className = 'container-btn' + (currentContainer === i && !reviewMissedMode ? ' active' : '');
                    btn.textContent = `C${i + 1} (${count})`;
                    btn.onclick = () => selectContainer(i);
                    container.appendChild(btn);
                }
                
                const info = document.createElement('div');
                info.className = 'container-info';
                info.textContent = `${allCards.length} total cards â€¢ ${CARDS_PER_CONTAINER} per container`;
                container.appendChild(info);
            }
        }
        
        function selectContainer(containerIdentifier) {
            currentContainer = containerIdentifier;
            reviewMissedMode = false;
            cardIndex = 0;
            
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !cardContent[currentSubject][currentSub]) return;
            
            const cards = cardContent[currentSubject][currentSub];
            const srs = srsData[currentSubject][currentSub];
            
            if (containerIdentifier === 'all') {
                const cardsWithSRS = cards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[i],
                    _index: i
                }));
                
                dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
            } else {
                const containerCards = getContainerCards(containerIdentifier);
                const startIdx = containerIdentifier * CARDS_PER_CONTAINER;
                
                const cardsWithSRS = containerCards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[startIdx + i],
                    _index: startIdx + i
                }));
                
                const containerDueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(containerDueCards.length > 0 ? containerDueCards : cardsWithSRS);
            }
            
            renderCard();
            renderContainerSelector();
        }
        
        function toggleReviewMissed() {
            if (missedCardsThisSession.size === 0) {
                alert('No missed cards in this session yet!');
                return;
            }
            
            reviewMissedMode = !reviewMissedMode;
            cardIndex = 0;
            
            if (reviewMissedMode) {
                const cards = cardContent[currentSubject][currentSub];
                const srs = srsData[currentSubject][currentSub];
                
                const missedCards = Array.from(missedCardsThisSession)
                    .map(idx => ({
                        q: cards[idx].q,
                        a: cards[idx].a,
                        srs: srs[idx],
                        _index: idx
                    }))
                    .filter(card => card.q);
                
                shuffledCards = shuffleArray(missedCards);
                currentContainer = 'all';
            } else {
                selectContainer(currentContainer);
            }
            
            renderCard();
            renderContainerSelector();
        }
        
        function renderContainerStats(allCards) {
            const statsContainer = document.getElementById('container-stats');
            const numContainers = Math.ceil(allCards.length / CARDS_PER_CONTAINER);
            
            if (numContainers <= 1) {
                statsContainer.innerHTML = '';
                return;
            }
            
            statsContainer.innerHTML = '<h3 class="db-section-title" style="margin-bottom: 16px;">Container Breakdown</h3>';
            
            for (let i = 0; i < numContainers; i++) {
                const startIdx = i * CARDS_PER_CONTAINER;
                const endIdx = Math.min(startIdx + CARDS_PER_CONTAINER, allCards.length);
                const containerSRS = srsData[currentSubject][currentSub].slice(startIdx, endIdx);
                
                const dueCount = containerSRS.filter(s => isDue(s)).length;
                const masteredCount = containerSRS.filter(s => s.interval >= 7).length;
                const totalCount = endIdx - startIdx;
                
                const statBox = document.createElement('div');
                statBox.className = 'container-stat';
                statBox.innerHTML = `
                    <div class="container-stat-header">Container ${i + 1} (${totalCount} cards)</div>
                    <div class="container-stat-detail">
                        ${masteredCount} mastered â€¢ ${dueCount} due today
                    </div>
                `;
                statsContainer.appendChild(statBox);
            }
        }

        // ==================== TAB SWITCHING ====================
        
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-view').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            element.classList.add('active');
            
            if (tabName === 'performance') {
                updateStats();
            }
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        
        document.addEventListener('keydown', (e) => {
            const tag = document.activeElement && document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA') return;

            const activeTab = document.querySelector('.tab-view.active');
            if (activeTab && activeTab.id === 'tab-flashcard') {
                if (e.code === 'Space' || e.code === 'Enter') {
                    e.preventDefault();
                    flipCard();
                } else if (e.code === 'ArrowRight' || e.code === 'KeyJ') {
                    e.preventDefault();
                    nextCard(true);
                } else if (e.code === 'ArrowLeft' || e.code === 'KeyF') {
                    e.preventDefault();
                    nextCard(false);
                }
            }
        });

        // ==================== INITIALIZATION ====================
        
        renderSidebar();
        loadSidebarState();
        
        // Wait for Firebase to be ready, then load from cloud
        let firebaseCheckAttempts = 0;
        const firebaseCheckInterval = setInterval(() => {
            firebaseCheckAttempts++;
            
            if (window.firebaseReady) {
                clearInterval(firebaseCheckInterval);
                loadFromCloud();
            } else if (firebaseCheckAttempts > 10) {
                // After 10 attempts (5 seconds), give up and use offline mode
                clearInterval(firebaseCheckInterval);
                console.log('âš ï¸ Firebase initialization timeout, working in offline mode');
                syncDot.className = 'sync-status-dot offline';
                syncHelp.textContent = "Offline mode - data stored locally";
            }
        }, 500);

    </script>
</body>
</html>
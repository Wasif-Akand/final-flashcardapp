<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MonoFlash</title>
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg: #000000;
            --surface: #111111;
            --border: #333333;
            --text: #ffffff;
            --text-dim: #888888;
            --accent: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- SIDEBAR (DRAWER) --- */
        #sidebar {
            width: 280px; background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            position: absolute; left: -280px; top: 0; bottom: 0;
            transition: left 0.3s ease; z-index: 1000;
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .subject-item { margin-bottom: 10px; }
        .subject-title { font-weight: bold; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .sub-subject-list { margin-left: 15px; border-left: 1px solid var(--border); display: none; }
        .sub-subject-list.show { display: block; }
        .sub-item { padding: 10px; color: var(--text-dim); cursor: pointer; }
        .sub-item:hover, .sub-item.active { color: var(--text); background: #222; }

        .add-btn { padding: 10px; border: 1px dashed var(--border); text-align: center; margin-top: 10px; cursor: pointer; color: var(--text-dim); }

        /* --- MAIN CONTENT --- */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; transition: opacity 0.3s; }
        
        /* Header */
        header { 
            padding: 15px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 15px; 
        }
        .menu-btn { font-size: 1.5rem; cursor: pointer; }

        /* Content Area */
        #content-area { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        
        /* --- TABS (Flashcard / Perf / DB) --- */
        .tab-view { display: none; height: 100%; }
        .tab-view.active { display: flex; flex-direction: column; }

        /* FLASHCARD STYLES */
        .flashcard-container { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 1400px; }
        .card {
            width: 100%; max-width: 420px; height: 320px;
            position: relative; transform-style: preserve-3d; transition: transform 0.6s, box-shadow 0.2s;
            cursor: pointer; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        .card.flipped { transform: rotateY(180deg); box-shadow: 0 18px 40px rgba(0,0,0,0.6); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center; text-align: center;
            border: 2px solid var(--border); border-radius: 15px; background: var(--surface);
            padding: 20px; font-size: 1.5rem;
        }
        .card-back { transform: rotateY(180deg); background: #000; border-color: #fff; }

        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn { padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: white; cursor: pointer; transition: transform 0.12s, filter 0.12s; }
        .btn:hover { transform: translateY(-2px); background: #1a1a1a; }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: white; color: black; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .btn-primary:hover { filter: brightness(0.96); }

        /* Visible focus ring for keyboard users */
        :focus-visible { outline: 3px solid #4D90FE; outline-offset: 3px; border-radius: 8px; }

        /* DATABASE STYLES */
        textarea { width: 100%; height: 100px; background: #070707; color: #fff; border: 1px solid var(--border); padding: 10px; margin-bottom: 10px; }
        .db-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .db-key { font-weight: bold; }

        /* PERFORMANCE STYLES */
        .stat-box { border: 1px solid var(--border); padding: 20px; margin-bottom: 10px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 2rem; font-weight: bold; }

        /* --- BOTTOM NAV --- */
        nav { display: flex; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); background: var(--bg); }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: var(--text-dim); cursor: pointer; font-size: 0.9rem; border-top: 2px solid transparent; }
        .nav-item.active { color: white; border-top-color: white; }

        /* Overlay for sidebar */
        #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
        #overlay.show { display: block; }

        /* Responsive tweaks */
        @media (max-width: 480px) {
            .card { max-width: 320px; height: 260px; font-size: 1.1rem; }
            #sidebar { width: 240px; left: -240px; }
        }

    </style>
</head>
<body>

    <div id="overlay" onclick="toggleSidebar()"></div>
    <aside id="sidebar">
        <div class="sidebar-header">SUBJECTS</div>
        <div class="sidebar-content" id="subject-list">
            </div>
        <div class="add-btn" onclick="addNewSubject()">+ Add Subject</div>
    </aside>

    <main id="main">
        <header>
            <div class="menu-btn" onclick="toggleSidebar()">☰</div>
            <h1 id="header-title" style="font-size: 1.2rem; margin:0;">Select a Subject</h1>
        </header>

        <section id="content-area">
            
            <div id="tab-flashcard" class="tab-view active">
                <div class="flashcard-container">
                    <div class="card" onclick="flipCard()" id="active-card">
                        <div class="card-face card-front" id="card-front">Select a sub-subject</div>
                        <div class="card-face card-back" id="card-back">...to start</div>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn" onclick="nextCard(false)">Missed</button>
                    <button class="btn btn-primary" onclick="nextCard(true)">Got it</button>
                </div>
            </div>

            <div id="tab-performance" class="tab-view">
                <div class="stat-box">
                    <div class="stat-num" id="stat-total">0</div>
                    <div>Cards Reviewed</div>
                </div>
                <div class="stat-box" style="border-color: #fff;">
                    <div class="stat-num" id="stat-score">0%</div>
                    <div>Accuracy</div>
                </div>
            </div>

            <div id="tab-database" class="tab-view">
                <h3>Add Data</h3>
                <p style="color:#666; font-size: 0.8rem;">Format: Question -!- Answer (one per line) OR JSON: [{"q":"Front", "a":"Back"}]</p>
                <textarea id="json-input" placeholder='What is gravity? -!- Force that attracts objects
What is speed? -!- Distance over time'></textarea>
                        <!-- file input for direct JSON import -->
                        <input id="file-input" type="file" accept="application/json,.json" style="display:none" onchange="importJsonFile(event)">
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-primary" style="flex:1" onclick="importJson()" aria-label="Import JSON">Import Data</button>
                            <button class="btn" style="width:160px" onclick="exportJson()" aria-label="Export JSON">Export JSON</button>
                            <button class="btn" style="width:170px" onclick="document.getElementById('file-input').click()" aria-label="Import JSON file">Import from file</button>
                        </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 30px;">
                    <h3 style="margin: 0;">Current Entries</h3>
                    <button class="btn" onclick="clearAllCards()" style="padding: 8px 16px; font-size: 0.9rem;">Clear All</button>
                </div>
                <div id="db-list"></div>
            </div>

        </section>

        <nav>
            <div class="nav-item active" onclick="switchTab('flashcard', this)">FLASHCARDS</div>
            <div class="nav-item" onclick="switchTab('performance', this)">STATS</div>
            <div class="nav-item" onclick="switchTab('database', this)">DATA</div>
        </nav>
    </main>

    <script>
        // --- DATA STORE ---
        // Structure: { "Physics": { "Motion": [ {q, a, stats} ] } }
        let appData = JSON.parse(localStorage.getItem('monoFlashData')) || {};
        let currentSubject = null;
        let currentSub = null;
        let cardIndex = 0;
        let sessionStats = { total: 0, correct: 0 };
        let shuffledCards = []; // Randomized order of cards

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Utility: create safe DOM ids from arbitrary names
        function safeId(name){
            return String(name || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9_-]+/g, '-');
        }

        // Validate imported JSON for card arrays: [{q: string, a: string}]
        function isValidCardArray(arr){
            if(!Array.isArray(arr)) return false;
            return arr.every(c => c && typeof c === 'object' && typeof c.q === 'string' && typeof c.a === 'string');
        }

        // NEW: Parse text format "Question -!- Answer" into JSON
        function parseTextFormat(text){
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const cards = [];
            
            for(let line of lines){
                if(line.includes('-!-')){
                    const parts = line.split('-!-');
                    if(parts.length >= 2){
                        const q = parts[0].trim();
                        const a = parts.slice(1).join('-!-').trim(); // In case answer contains -!-
                        if(q && a){
                            cards.push({q, a});
                        }
                    }
                }
            }
            
            return cards;
        }

        // --- SIDEBAR & NAV LOGIC ---
        function saveSidebarState(isOpen){
            try{ localStorage.setItem('monoSidebarOpen', isOpen ? '1' : '0'); }catch(e){}
        }

        function loadSidebarState(){
            try{
                const val = localStorage.getItem('monoSidebarOpen');
                if(val === '1'){
                    document.getElementById('sidebar').classList.add('open');
                    document.getElementById('overlay').classList.add('show');
                } else {
                    document.getElementById('sidebar').classList.remove('open');
                    document.getElementById('overlay').classList.remove('show');
                }
            }catch(e){}
        }

        function toggleSidebar(forceState){
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if(typeof forceState === 'boolean'){
                sb.classList.toggle('open', forceState);
                ov.classList.toggle('show', forceState);
                saveSidebarState(forceState);
                return;
            }
            const willOpen = !sb.classList.contains('open');
            sb.classList.toggle('open');
            ov.classList.toggle('show');
            saveSidebarState(willOpen);
        }

        function renderSidebar() {
            const container = document.getElementById('subject-list');
            container.innerHTML = '';

            Object.keys(appData).forEach(sub => {
                const subDiv = document.createElement('div');
                subDiv.className = 'subject-item';
                
                const title = document.createElement('div');
                title.className = 'subject-title';
                title.innerHTML = `${sub} <span>▾</span>`;
                const safe = safeId(sub);
                title.onclick = () => {
                    const el = document.getElementById(`list-${safe}`);
                    if(el) el.classList.toggle('show');
                };

                const list = document.createElement('div');
                list.className = 'sub-subject-list';
                list.id = `list-${safe}`;
                
                // Add "Add Sub-subject" button inside list
                const addSubBtn = document.createElement('div');
                addSubBtn.className = 'sub-item';
                addSubBtn.innerText = '+ New Topic';
                addSubBtn.style.fontStyle = 'italic';
                addSubBtn.onclick = () => addNewSubSubject(sub);
                list.appendChild(addSubBtn);

                Object.keys(appData[sub]).forEach(topic => {
                    const item = document.createElement('div');
                    item.className = 'sub-item';
                    item.innerText = topic;
                    item.onclick = () => loadTopic(sub, topic);
                    list.appendChild(item);
                });

                subDiv.appendChild(title);
                subDiv.appendChild(list);
                container.appendChild(subDiv);
            });
        }

        function addNewSubject() {
            const name = prompt("Enter Subject Name (e.g., Physics):");
            if (name && !appData[name]) {
                appData[name] = {};
                saveData();
                renderSidebar();
            }
        }

        function addNewSubSubject(subject) {
            const name = prompt(`Enter Topic for ${subject} (e.g., Motion):`);
            if (name && !appData[subject][name]) {
                appData[subject][name] = []; // Empty array for cards
                saveData();
                renderSidebar();
            }
        }

        // --- CORE FUNCTIONALITY ---
        function loadTopic(sub, topic) {
            currentSubject = sub;
            currentSub = topic;
            cardIndex = 0;
            sessionStats = { total: 0, correct: 0 };
            
            // Shuffle cards when loading topic
            if (appData[sub] && appData[sub][topic] && Array.isArray(appData[sub][topic])) {
                shuffledCards = shuffleArray(appData[sub][topic]);
            } else {
                shuffledCards = [];
            }
            
            document.getElementById('header-title').innerText = `${sub} / ${topic}`;
            toggleSidebar(); // Close sidebar
            renderCard();
            renderDbList();
            updateStats();
        }

        function switchTab(tabId, navEl) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tabId}`).classList.add('active');
            navEl.classList.add('active');
        }

        // --- FLASHCARD LOGIC ---
        function renderCard() {
            const cardEl = document.getElementById('active-card');
            const frontEl = document.getElementById('card-front');
            const backEl = document.getElementById('card-back');
            
            cardEl.classList.remove('flipped'); // Reset flip
            if (!currentSubject || !currentSub || shuffledCards.length === 0) {
                frontEl.innerText = "No cards here.";
                backEl.innerText = "Go to DATA tab to add cards.";
                return;
            }

            // Loop if we reach end
            if (cardIndex >= shuffledCards.length) cardIndex = 0;

            const card = shuffledCards[cardIndex];
            frontEl.innerText = card.q;
            backEl.innerText = card.a;
        }

        function flipCard() {
            document.getElementById('active-card').classList.toggle('flipped');
        }

        function nextCard(isCorrect) {
            if (!currentSubject) return;
            
            // Update Stats
            sessionStats.total++;
            if (isCorrect) sessionStats.correct++;
            updateStats();

            // Next card
            cardIndex++;
            renderCard();
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = sessionStats.total;
            const percentage = sessionStats.total === 0 ? 0 : Math.round((sessionStats.correct / sessionStats.total) * 100);
            document.getElementById('stat-score').innerText = percentage + "%";
        }

        // --- DATABASE LOGIC ---
        function importJson() {
            if (!currentSubject || !currentSub) {
                alert("Please select a Subject and Topic from the sidebar first.");
                return;
            }

            const input = document.getElementById('json-input').value.trim();
            if(!input){
                alert("Please enter some data first.");
                return;
            }
            
            let newCards = [];
            
            // Try parsing as text format first (Question -!- Answer)
            if(input.includes('-!-')){
                newCards = parseTextFormat(input);
                if(newCards.length === 0){
                    alert('No valid cards found. Make sure to use format: Question -!- Answer');
                    return;
                }
            } else {
                // Try parsing as JSON
                try {
                    newCards = JSON.parse(input);
                    if (!isValidCardArray(newCards)) {
                        alert('Invalid JSON format. Use: [{"q":"Question", "a":"Answer"}] OR text format: Question -!- Answer');
                        return;
                    }
                } catch (e) {
                    alert("Invalid format. Use either:\n\nText: Question -!- Answer\nor\nJSON: [{\"q\":\"Question\", \"a\":\"Answer\"}]");
                    return;
                }
            }

            // Ensure target array exists
            if(!Array.isArray(appData[currentSubject][currentSub])) appData[currentSubject][currentSub] = [];

            // Check for duplicates
            const existingCards = appData[currentSubject][currentSub];
            let addedCount = 0;
            let duplicateCount = 0;
            
            newCards.forEach(newCard => {
                // Check if card already exists (same question)
                const isDuplicate = existingCards.some(existing => 
                    existing.q.trim().toLowerCase() === newCard.q.trim().toLowerCase()
                );
                
                if (!isDuplicate) {
                    existingCards.push(newCard);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            });

            saveData();
            
            let message = `Added ${addedCount} card${addedCount !== 1 ? 's' : ''}!`;
            if (duplicateCount > 0) {
                message += `\n${duplicateCount} duplicate${duplicateCount !== 1 ? 's' : ''} skipped.`;
            }
            alert(message);
            
            // Reshuffle cards after import
            if (appData[currentSubject] && appData[currentSubject][currentSub]) {
                shuffledCards = shuffleArray(appData[currentSubject][currentSub]);
            }
            
            document.getElementById('json-input').value = ''; // Clear
            renderDbList();
            renderCard(); // Refresh current view
        }

        // Import JSON from a selected file (local file input)
        function importJsonFile(e){
            if (!currentSubject || !currentSub) {
                alert("Please select a Subject and Topic from the sidebar first.");
                // clear file input if any
                if(e && e.target) e.target.value = '';
                return;
            }
            const file = (e && e.target && e.target.files && e.target.files[0]) || null;
            if(!file){ return; }
            const reader = new FileReader();
            reader.onload = function(ev){
                try{
                    const parsed = JSON.parse(String(ev.target.result));
                    if(!isValidCardArray(parsed)){
                        alert('Invalid JSON shape in file. Provide an array of {q:string,a:string}.');
                        return;
                    }

                    if(!Array.isArray(appData[currentSubject][currentSub])) appData[currentSubject][currentSub] = [];
                    
                    // Check for duplicates
                    const existingCards = appData[currentSubject][currentSub];
                    let addedCount = 0;
                    let duplicateCount = 0;
                    
                    parsed.forEach(newCard => {
                        const isDuplicate = existingCards.some(existing => 
                            existing.q.trim().toLowerCase() === newCard.q.trim().toLowerCase()
                        );
                        
                        if (!isDuplicate) {
                            existingCards.push(newCard);
                            addedCount++;
                        } else {
                            duplicateCount++;
                        }
                    });
                    
                    saveData();
                    
                    let message = `Imported ${addedCount} card${addedCount !== 1 ? 's' : ''} from file.`;
                    if (duplicateCount > 0) {
                        message += `\n${duplicateCount} duplicate${duplicateCount !== 1 ? 's' : ''} skipped.`;
                    }
                    alert(message);
                    
                    // Reshuffle cards after import
                    if (appData[currentSubject] && appData[currentSubject][currentSub]) {
                        shuffledCards = shuffleArray(appData[currentSubject][currentSub]);
                    }
                    
                    renderDbList();
                    renderCard();
                }catch(err){
                    alert('Unable to parse JSON file.');
                } finally {
                    // reset file input so same file can be re-selected later
                    if(e && e.target) e.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        // Export current topic cards as JSON file
        function exportJson(){
            if (!currentSubject || !currentSub || !appData[currentSubject] || !Array.isArray(appData[currentSubject][currentSub])){
                alert('Select a Subject and Topic first to export.');
                return;
            }
            const data = appData[currentSubject][currentSub];
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = `${safeId(currentSubject)}-${safeId(currentSub)}.json`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Navigate to previous card
        function prevCard(){
            if (!currentSubject || !currentSub) return;
            cardIndex = Math.max(0, cardIndex - 1);
            renderCard();
        }

        // Keyboard accessibility: flip with Space/Enter, navigate with arrows
        document.addEventListener('keydown', (e) => {
            // Do nothing if focus is in a text input/textarea
            const tag = document.activeElement && document.activeElement.tagName;
            if(tag === 'INPUT' || tag === 'TEXTAREA') return;

            const activeTab = document.querySelector('.tab-view.active');
            if(activeTab && activeTab.id === 'tab-flashcard'){
                if(e.code === 'Space' || e.code === 'Enter'){
                    e.preventDefault();
                    flipCard();
                } else if(e.code === 'ArrowRight'){
                    e.preventDefault();
                    nextCard(false);
                } else if(e.code === 'ArrowLeft'){
                    e.preventDefault();
                    prevCard();
                }
            }
        });

        // Add some ARIA and keyboard focusability
        document.querySelectorAll('.menu-btn').forEach(el => {
            el.setAttribute('role','button');
            el.setAttribute('tabindex','0');
            el.setAttribute('aria-label','Toggle menu');
            el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleSidebar(); } });
        });

        // Make card keyboard-focusable
        const initCardFocus = () => {
            const card = document.getElementById('active-card');
            if(card){
                card.setAttribute('role','button');
                card.setAttribute('tabindex','0');
                card.setAttribute('aria-label','Flashcard - press space or enter to flip');
                card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); flipCard(); } });
            }
        };

        // when loading topic, focus the card for keyboard users
        const origLoadTopic = loadTopic;
        loadTopic = function(sub, topic){
            origLoadTopic(sub, topic);
            setTimeout(()=>{
                initCardFocus();
                const card = document.getElementById('active-card');
                if(card) card.focus();
            }, 50);
        };

        // initialize focusability on startup
        initCardFocus();

        function renderDbList() {
            const list = document.getElementById('db-list');
            list.innerHTML = '';
            
            if (!currentSubject || !currentSub || !appData[currentSubject] || !Array.isArray(appData[currentSubject][currentSub])) return;

            const cards = appData[currentSubject][currentSub];
            cards.forEach((c, idx) => {
                const item = document.createElement('div');
                item.className = 'db-item';
                item.innerHTML = `
                    <div>
                        <div class="db-key">Q: ${c.q}</div>
                        <div style="color:#666">A: ${c.a}</div>
                    </div>
                    <button onclick="deleteCard(${idx})" style="background:none; border:none; color:red;">✕</button>
                `;
                list.appendChild(item);
            });
        }

        function deleteCard(index) {
            if(confirm('Delete this card?')) {
                appData[currentSubject][currentSub].splice(index, 1);
                saveData();
                
                // Reshuffle after deletion
                shuffledCards = shuffleArray(appData[currentSubject][currentSub]);
                if (cardIndex >= shuffledCards.length) cardIndex = 0;
                
                renderDbList();
                renderCard();
            }
        }

        function clearAllCards() {
            if (!currentSubject || !currentSub) {
                alert('Please select a Subject and Topic first.');
                return;
            }
            
            const cardCount = appData[currentSubject][currentSub].length;
            if (cardCount === 0) {
                alert('No cards to clear.');
                return;
            }
            
            if(confirm(`Are you sure you want to delete all ${cardCount} cards from "${currentSub}"?\n\nThis action cannot be undone.`)) {
                appData[currentSubject][currentSub] = [];
                saveData();
                shuffledCards = [];
                cardIndex = 0;
                renderDbList();
                renderCard();
                alert('All cards cleared.');
            }
        }

        function saveData() {
            localStorage.setItem('monoFlashData', JSON.stringify(appData));
        }

        // --- INIT ---
        renderSidebar();
        // restore sidebar open/closed state
        loadSidebarState();

    </script>
</body>
</html>
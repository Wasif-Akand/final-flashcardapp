<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MonoFlash">
    <title>MonoFlash</title>

    <script>
        // Cloudflare Worker URL - Simple HTTP sync (no Firebase SDK)
        const WORKER_URL = 'https://monoflash.wasif-akand08.workers.dev';
    </script>

    <style>
        :root {
            --bg:#000; --surface:#0a0a0a; --surface-el:#121212;
            --border:#1a1a1a; --border-b:#333;
            --text:#fff; --dim:#666; --dimmer:#444; --accent:#fff;
            --ok:#2ecc71; --err:#e74c3c; --warn:#f39c12;
            --sh-sm:0 2px 8px rgba(0,0,0,.8); --sh-md:0 4px 16px rgba(0,0,0,.9);
            --sh-lg:0 8px 32px rgba(0,0,0,.95); --sh-xl:0 16px 48px rgba(0,0,0,1);
            --tf:.15s cubic-bezier(.4,0,.2,1); --tn:.3s cubic-bezier(.4,0,.2,1); --ts:.5s cubic-bezier(.4,0,.2,1);
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;}
        body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;height:100vh;height:100dvh;display:flex;overflow:hidden;-webkit-font-smoothing:antialiased;}
        body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.3;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.01) 2px,rgba(255,255,255,.01) 4px);}

        /* SIDEBAR */
        #sidebar{width:280px;background:var(--surface);border-right:1px solid var(--border-b);display:flex;flex-direction:column;position:fixed;left:-280px;top:0;bottom:0;transition:left .4s cubic-bezier(.4,0,.2,1),box-shadow var(--tn);z-index:1000;box-shadow:var(--sh-xl);}
        #sidebar.open{left:0;}
        .sb-head{padding:24px 20px;border-bottom:1px solid var(--border-b);background:linear-gradient(180deg,var(--surface-el) 0%,var(--surface) 100%);position:relative;overflow:hidden;}
        .sb-head::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at top right,rgba(255,255,255,.03) 0%,transparent 70%);pointer-events:none;}
        .sb-title{font-size:1.4rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .sb-sub{font-size:.7rem;color:var(--dim);line-height:1.4;}
        .sb-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 8px;}
        .sb-content::-webkit-scrollbar{width:4px;}
        .sb-content::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:2px;}

        .subject-item{margin-bottom:8px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--surface-el);transition:all .3s cubic-bezier(.4,0,.2,1);}
        .subject-item:hover{border-color:var(--border-b);box-shadow:0 4px 12px rgba(0,0,0,.8),0 0 0 1px rgba(255,255,255,.03);transform:translateX(2px);}
        .subject-title{font-weight:700;padding:14px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:.9rem;letter-spacing:1px;text-transform:uppercase;transition:all .2s cubic-bezier(.4,0,.2,1);user-select:none;}
        .subject-title:hover{background:rgba(255,255,255,.03);}
        .subject-actions{display:flex;gap:8px;align-items:center;}
        .chevron{font-size:.7rem;transition:transform .4s cubic-bezier(.4,0,.2,1);color:var(--dim);}
        .subject-item.expanded .chevron{transform:rotate(180deg);}
        .del-icon{font-size:1.2rem;color:var(--dimmer);transition:color .2s,transform .2s;padding:4px;cursor:pointer;}
        .del-icon:hover{color:var(--err);transform:scale(1.2) rotate(90deg);}
        .sub-list{border-left:2px solid var(--border-b);margin-left:12px;display:none;background:rgba(0,0,0,.3);}
        .sub-list.show{display:block;animation:slideDown .4s cubic-bezier(.4,0,.2,1);}
        @keyframes slideDown{from{opacity:0;max-height:0;transform:translateY(-10px)}to{opacity:1;max-height:500px;transform:translateY(0)}}
        .sub-item{padding:12px 16px;color:var(--dim);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:.85rem;transition:all var(--tf);border-bottom:1px solid rgba(255,255,255,.02);position:relative;}
        .sub-item:last-child{border-bottom:none;}
        .sub-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--accent);transform:scaleY(0);transition:transform var(--tf);}
        .sub-item:hover,.sub-item.active{color:var(--text);background:rgba(255,255,255,.05);padding-left:20px;}
        .sub-item:hover::before,.sub-item.active::before{transform:scaleY(1);}
        .sub-item.active{background:rgba(255,255,255,.08);font-weight:600;}
        .card-count{font-size:.7rem;color:var(--dimmer);background:rgba(255,255,255,.05);padding:2px 8px;border-radius:12px;font-weight:600;min-width:32px;text-align:center;}

        /* SYNC PANEL */
        .sync-panel{padding:12px;border-top:1px solid var(--border-b);background:var(--surface-el);box-shadow:0 -4px 16px rgba(0,0,0,.5);position:relative;}
        .sync-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);}
        .sync-btn{width:100%;padding:12px;background:var(--surface);color:#fff;border:1px solid var(--border-b);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;font-size:.85rem;font-weight:600;letter-spacing:.5px;transition:all .25s cubic-bezier(.4,0,.2,1);text-transform:uppercase;position:relative;}
        .sync-btn:hover{background:var(--surface-el);border-color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,.8),0 0 12px rgba(255,255,255,.08);transform:translateY(-1px);}
        .sync-btn:active{transform:translateY(0) scale(.98);transition:all .1s;}
        .sync-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
        .sync-btn:disabled:hover{background:var(--surface);border-color:var(--border-b);box-shadow:none;}

        /* Progress dot / ring */
        .dot-wrap{width:24px;height:24px;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .dot{width:10px;height:10px;border-radius:50%;background:var(--dim);transition:background var(--tf),box-shadow var(--tf);}
        .dot.online {background:var(--ok); box-shadow:0 0 8px var(--ok),0 0 16px rgba(46,204,113,.3);animation:dotPulse 2s infinite;}
        .dot.offline{background:var(--warn);box-shadow:0 0 8px var(--warn);}
        .dot.error  {background:var(--err); box-shadow:0 0 8px var(--err);}
        .dot.syncing{display:none;}
        @keyframes dotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.9)}}

        .pring{position:absolute;inset:0;width:24px;height:24px;display:none;}
        .pring.show{display:block;}
        .pring-track{fill:none;stroke:var(--border-b);stroke-width:2.5;}
        .pring-fill {fill:none;stroke:var(--accent);stroke-width:2.5;stroke-linecap:round;transform-origin:center;transform:rotate(-90deg);transition:stroke-dashoffset .35s ease;}

        .device-id{font-size:.65rem;color:var(--dimmer);margin-top:8px;text-align:center;font-family:monospace;padding:6px;background:rgba(0,0,0,.3);border-radius:4px;word-break:break-all;}
        .sync-help{font-size:.65rem;color:var(--dimmer);text-align:center;margin-top:6px;line-height:1.3;}
        
        .sb-home-btn-subtle{all:unset;display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:10px 8px;cursor:pointer;color:var(--text);font-size:.85rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;transition:all var(--tf);border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.03);box-shadow:0 2px 8px rgba(0,0,0,.3);user-select:none;}
        .sb-home-btn-subtle:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2);box-shadow:0 4px 12px rgba(0,0,0,.5);transform:translateY(-1px);}
        .sb-home-btn-subtle:active{transform:scale(.96);}
        
        .add-btn{padding:12px;border:1px dashed var(--border-b);text-align:center;margin:8px 8px 12px;cursor:pointer;color:var(--dim);border-radius:8px;font-size:.85rem;font-weight:600;letter-spacing:.5px;transition:all var(--tf);text-transform:uppercase;}
        .add-btn:hover{color:var(--text);border-color:var(--accent);background:rgba(255,255,255,.03);}

        /* MAIN */
        #main{flex:1;display:flex;flex-direction:column;position:relative;width:100%;}
        header{padding:16px 20px;border-bottom:1px solid var(--border-b);display:flex;align-items:center;gap:16px;background:var(--surface);box-shadow:var(--sh-md);position:relative;z-index:10;}
        .menu-btn{font-size:1.5rem;cursor:pointer;color:var(--text);transition:all .3s cubic-bezier(.4,0,.2,1);padding:8px;margin:-8px;user-select:none;}
        .menu-btn:hover{transform:scale(1.15);text-shadow:0 0 8px rgba(255,255,255,.2);}
        .menu-btn:active{transform:scale(.9);}
        #header-title{font-size:1rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        #content-area{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px;position:relative;}
        #content-area::-webkit-scrollbar{width:6px;}
        #content-area::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:3px;}
        .tab-view{display:none;height:100%;animation:fadeIn .4s cubic-bezier(.4,0,.2,1);flex-direction:column;}
        .tab-view.active{display:flex;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* FLASHCARD */
        .progress-bar-wrap{width:100%;height:6px;background:var(--border);margin-bottom:16px;border-radius:3px;overflow:hidden;opacity:.9;transition:opacity var(--tn);box-shadow:inset 0 1px 3px rgba(0,0,0,.5);}
        .progress-bar-wrap:hover{opacity:1;}
        .progress-bar{height:100%;background:linear-gradient(90deg,#fff 0%,#ddd 100%);width:0%;transition:width .4s cubic-bezier(.4,0,.2,1);box-shadow:0 0 12px rgba(255,255,255,.4),0 0 4px rgba(255,255,255,.6);}
        .progress-text{font-size:.7rem;color:var(--dim);text-align:center;margin-bottom:12px;font-weight:600;letter-spacing:.5px;}
        .bookmark-icon{position:absolute;top:12px;right:12px;font-size:1.5rem;cursor:pointer;z-index:10;transition:all .25s cubic-bezier(.4,0,.2,1);user-select:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));}
        .bookmark-icon:hover{transform:scale(1.2) rotate(-10deg);filter:drop-shadow(0 4px 8px rgba(0,0,0,.8));}
        .bookmark-icon.active{filter:drop-shadow(0 0 8px rgba(255,215,0,.6));}
        .card-container{flex:1;display:flex;justify-content:center;align-items:center;perspective:1600px;padding:20px 0;min-height:320px;}
        .card{width:100%;max-width:380px;height:280px;position:relative;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.4,0,.2,1),box-shadow var(--tn);cursor:pointer;box-shadow:var(--sh-lg);}
        .card:hover{box-shadow:0 12px 48px rgba(0,0,0,1),0 0 0 1px rgba(255,255,255,.1);transform:translateY(-4px) scale(1.01);}
        .card.flipped{transform:rotateY(180deg) scale(1.02);}
        .card.flipped:hover{transform:rotateY(180deg) translateY(-4px) scale(1.03);}
        .card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;justify-content:center;align-items:center;text-align:center;border:2px solid var(--border-b);border-radius:16px;background:var(--surface-el);padding:32px 24px;font-size:1.3rem;font-weight:500;line-height:1.5;box-shadow:inset 0 2px 8px rgba(0,0,0,.5);overflow-y:auto;transition:border-color var(--tn);}
        .card-face::-webkit-scrollbar{width:4px;}
        .card-face::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:2px;}
        .card-back{transform:rotateY(180deg);background:#050505;border-color:var(--accent);box-shadow:inset 0 2px 8px rgba(0,0,0,.8),0 0 32px rgba(255,255,255,.15),0 0 64px rgba(255,255,255,.05);}
        .controls{display:flex;gap:12px;justify-content:center;margin-top:20px;padding:0 20px;flex-shrink:0;min-height:56px;}
        .btn{padding:14px 28px;border-radius:10px;border:1px solid var(--border-b);background:var(--surface);color:#fff;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);font-size:.95rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;box-shadow:var(--sh-sm);user-select:none;position:relative;}
        .btn:hover{transform:translateY(-2px);background:var(--surface-el);box-shadow:0 6px 20px rgba(0,0,0,.9),0 0 12px rgba(255,255,255,.08);border-color:var(--accent);}
        .btn:active{transform:translateY(0) scale(.97);box-shadow:var(--sh-sm);transition:all .1s;}
        .btn-primary{background:linear-gradient(135deg,#fff 0%,#ccc 100%);color:#000;border:none;box-shadow:0 4px 16px rgba(255,255,255,.1),0 0 0 1px rgba(255,255,255,.2);}
        .btn-primary:hover{background:linear-gradient(135deg,#f5f5f5 0%,#bbb 100%);box-shadow:0 8px 24px rgba(255,255,255,.15),0 0 16px rgba(255,255,255,.12);}
        .btn-primary:active{transform:translateY(0) scale(.97);}
        :focus-visible{outline:2px solid var(--accent);outline-offset:4px;}

        /* CONTAINERS */
        .cont-selector{display:flex;flex-direction:column;gap:6px;margin-bottom:16px;padding:10px;border:1px solid var(--border-b);border-radius:10px;background:var(--surface-el);box-shadow:inset 0 2px 4px rgba(0,0,0,.3);overflow:hidden;transition:all .3s cubic-bezier(.4,0,.2,1);max-height:400px;}
        .cont-selector.collapsed{padding:0;max-height:48px;}
        .cont-header{padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:.8rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--dim);transition:all .2s;user-select:none;flex-shrink:0;}
        .cont-header:hover{color:var(--text);background:rgba(255,255,255,.03);}
        .cont-chevron{font-size:.7rem;transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .cont-selector.collapsed .cont-chevron{transform:rotate(-90deg);}
        .cont-buttons{display:flex;gap:6px;flex-wrap:wrap;width:100%;transition:all .3s cubic-bezier(.4,0,.2,1);overflow-y:auto;overflow-x:hidden;max-height:300px;padding-right:6px;}
        .cont-buttons::-webkit-scrollbar{width:4px;}
        .cont-buttons::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:2px;}
        .cont-selector.collapsed .cont-buttons{display:none;}
        .cont-btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--dim);cursor:pointer;font-size:.75rem;font-weight:700;letter-spacing:.5px;transition:all var(--tf);white-space:nowrap;text-transform:uppercase;user-select:none;}
        .cont-btn:hover{background:var(--surface-el);color:var(--text);border-color:var(--border-b);transform:translateY(-1px);}
        .cont-btn.active{background:linear-gradient(135deg,#fff 0%,#ccc 100%);color:#000;border-color:var(--accent);}
        .cont-btn.missed{background:rgba(231,76,60,.08);border-color:rgba(231,76,60,.3);color:#e74c3c;}
        .cont-btn.missed:hover{background:rgba(231,76,60,.15);border-color:rgba(231,76,60,.5);box-shadow:0 0 8px rgba(231,76,60,.2);}
        .cont-btn.missed.active{background:rgba(231,76,60,.2);border-color:#e74c3c;color:#e74c3c;box-shadow:0 0 12px rgba(231,76,60,.3);}
        .cont-btn.bookmarks{background:rgba(255,215,0,.08);border-color:rgba(255,215,0,.3);color:#ffd700;}
        .cont-btn.bookmarks:hover{background:rgba(255,215,0,.15);border-color:rgba(255,215,0,.5);box-shadow:0 0 8px rgba(255,215,0,.2);}
        .cont-btn.bookmarks.active{background:rgba(255,215,0,.2);border-color:#ffd700;color:#ffd700;box-shadow:0 0 12px rgba(255,215,0,.3);}
        .cont-info{font-size:.7rem;color:var(--dimmer);margin-top:8px;width:100%;text-align:center;}

        /* STATS */
        .stat-box{border:1px solid var(--border-b);padding:24px;margin-bottom:12px;border-radius:12px;text-align:center;background:var(--surface-el);box-shadow:var(--sh-sm);transition:all var(--tn);}
        .stat-box:hover{box-shadow:0 6px 24px rgba(0,0,0,.9),0 0 0 1px rgba(255,255,255,.05);transform:translateY(-2px);}
        .stat-box.hi{border-color:var(--accent);box-shadow:0 0 16px rgba(255,255,255,.1);}
        .stat-num{font-size:2.5rem;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;transition:transform .3s cubic-bezier(.4,0,.2,1);}
        .stat-box:hover .stat-num{transform:scale(1.05);}
        .stat-label{color:var(--dim);font-size:.85rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;}
        .cont-stat{border:1px solid var(--border);padding:16px;margin-bottom:8px;border-radius:10px;background:var(--surface-el);}
        .cont-stat-h{font-weight:700;margin-bottom:8px;font-size:.9rem;}
        .cont-stat-d{color:var(--dim);font-size:.85rem;}

        /* DATABASE */
        textarea{width:100%;min-height:120px;background:var(--surface-el);color:var(--text);border:1px solid var(--border-b);padding:14px;margin-bottom:12px;border-radius:10px;font-family:'Courier New',monospace;font-size:.85rem;resize:vertical;transition:all var(--tf);line-height:1.6;}
        textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,255,255,.1);}
        textarea::placeholder{color:var(--dimmer);}
        .db-sec-title{font-size:1.1rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border-b);}
        .db-sub{color:var(--dim);font-size:.75rem;margin-bottom:12px;line-height:1.4;}
        .db-btn-group{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap;}
        .db-btn-group .btn{flex:1;min-width:120px;padding:12px 20px;font-size:.8rem;}
        .db-list-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;margin-top:32px;}
        .db-list-head h3{margin:0;font-size:1.1rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;}
        .db-item{padding:16px;border:1px solid var(--border);background:var(--surface-el);margin-bottom:8px;border-radius:10px;display:flex;justify-content:space-between;gap:12px;transition:all var(--tf);align-items:flex-start;}
        .db-item:hover{border-color:var(--border-b);box-shadow:var(--sh-sm);}
        .db-item-content{flex:1;min-width:0;}
        .db-key{font-weight:700;margin-bottom:6px;word-wrap:break-word;font-size:.9rem;}
        .db-val{color:var(--dim);font-size:.85rem;word-wrap:break-word;line-height:1.4;}
        .db-item-actions{display:flex;gap:6px;flex-direction:column;flex-shrink:0;}
        .db-btn-edit{background:rgba(255,215,0,.08);border-color:rgba(255,215,0,.3);color:#ffd700;}
        .db-btn-edit:hover{background:rgba(255,215,0,.15);border-color:rgba(255,215,0,.5);box-shadow:0 0 8px rgba(255,215,0,.2);}
        .db-btn-delete{background:rgba(231,76,60,.08);border-color:rgba(231,76,60,.3);color:#e74c3c;}
        .db-btn-delete:hover{background:rgba(231,76,60,.15);border-color:rgba(231,76,60,.5);box-shadow:0 0 8px rgba(231,76,60,.2);}
        .db-item-edit{display:flex;gap:12px;align-items:flex-start;flex:1;}
        .db-edit-inputs{flex:1;display:flex;flex-direction:column;gap:8px;}
        .db-edit-input{width:100%;background:var(--surface);color:var(--text);border:1px solid var(--border-b);padding:10px;border-radius:6px;font-family:inherit;font-size:.85rem;transition:all var(--tf);}
        .db-edit-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,255,255,.1);}

        /* NAV */
        nav{display:flex;border-top:1px solid var(--border-b);padding-bottom:env(safe-area-inset-bottom);background:var(--surface);box-shadow:0 -4px 16px rgba(0,0,0,.5);position:relative;z-index:10;}
        .nav-item{flex:1;padding:16px 12px;text-align:center;color:var(--dim);cursor:pointer;font-size:.8rem;font-weight:700;letter-spacing:1px;transition:all var(--tf);text-transform:uppercase;user-select:none;position:relative;}
        .nav-item::before{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%) scaleX(0);width:60%;height:2px;background:var(--accent);transition:transform var(--tn);}
        .nav-item:hover{color:var(--text);background:rgba(255,255,255,.03);}
        .nav-item.active{color:#fff;background:rgba(255,255,255,.05);}
        .nav-item.active::before{transform:translateX(-50%) scaleX(1);}

        /* OVERLAY */
        #overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);z-index:900;display:none;}
        #overlay.show{display:block;animation:fadeIn var(--tn);}

        /* ONBOARDING */
        #onboarding{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
        #onboarding.show{display:flex;animation:fadeIn .5s cubic-bezier(.4,0,.2,1);}
        .onboarding-modal{background:linear-gradient(135deg,var(--surface-el) 0%,var(--surface) 100%);border:1px solid var(--border-b);border-radius:16px;padding:40px;max-width:450px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.8),0 0 40px rgba(255,255,255,.1);text-align:center;animation:slideUp .5s cubic-bezier(.4,0,.2,1);}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .onboarding-title{font-size:1.8rem;font-weight:800;margin-bottom:12px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px;}
        .onboarding-subtitle{font-size:.95rem;color:var(--dim);margin-bottom:32px;line-height:1.6;}
        .onboarding-input-group{display:flex;flex-direction:column;gap:12px;margin-bottom:24px;}
        .onboarding-label{font-size:.85rem;font-weight:600;color:var(--text);text-align:left;letter-spacing:.5px;text-transform:uppercase;}
        .onboarding-input{width:100%;padding:12px 16px;background:var(--surface);color:var(--text);border:1px solid var(--border-b);border-radius:10px;font-size:.95rem;font-family:inherit;transition:all var(--tf);}
        .onboarding-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,255,255,.1);}
        .onboarding-input::placeholder{color:var(--dimmer);}
        .onboarding-buttons{display:flex;gap:12px;flex-direction:column;}
        .onboarding-btn{padding:13px 20px;border-radius:10px;border:1px solid var(--border-b);background:var(--surface);color:#fff;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);font-size:.9rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;}
        .onboarding-btn:hover{transform:translateY(-2px);background:var(--surface-el);box-shadow:0 6px 20px rgba(0,0,0,.9);border-color:var(--accent);}
        .onboarding-btn:active{transform:translateY(0) scale(.97);}
        .onboarding-btn-primary{background:linear-gradient(135deg,#fff 0%,#ccc 100%);color:#000;border:none;box-shadow:0 4px 16px rgba(255,255,255,.1);}
        .onboarding-btn-primary:hover{background:linear-gradient(135deg,#f5f5f5 0%,#bbb 100%);box-shadow:0 8px 24px rgba(255,255,255,.15);}
        .onboarding-info{font-size:.75rem;color:var(--dimmer);margin-top:16px;line-height:1.5;}
        .onboarding-info strong{color:var(--dim);}

        /* HOME SECTION */
        .home-content{display:flex;flex-direction:column;gap:24px;padding:8px 0;}
        .home-hero{text-align:center;padding:32px 0;background:linear-gradient(135deg,rgba(255,255,255,.05) 0%,rgba(0,0,0,.3) 100%);border-radius:16px;border:1px solid var(--border-b);margin-bottom:16px;}
        .home-title{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,#fff 0%,#aaa 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;letter-spacing:-1px;}
        .home-subtitle{font-size:1rem;color:var(--dim);margin-bottom:20px;line-height:1.6;}
        .home-cta{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
        .home-btn{padding:12px 24px;border-radius:10px;border:1px solid var(--border-b);background:var(--surface);color:#fff;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);font-size:.9rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;box-shadow:var(--sh-sm);}
        .home-btn:hover{transform:translateY(-2px);background:var(--surface-el);box-shadow:0 6px 20px rgba(0,0,0,.9),0 0 12px rgba(255,255,255,.08);border-color:var(--accent);}
        .home-btn:active{transform:translateY(0) scale(.97);}
        .home-btn-primary{background:linear-gradient(135deg,#fff 0%,#ccc 100%);color:#000;border:none;box-shadow:0 4px 16px rgba(255,255,255,.1);}
        .home-btn-primary:hover{background:linear-gradient(135deg,#f5f5f5 0%,#bbb 100%);box-shadow:0 8px 24px rgba(255,255,255,.15);}
        .home-section{display:flex;flex-direction:column;gap:12px;padding:24px;background:var(--surface-el);border:1px solid var(--border);border-radius:14px;box-shadow:var(--sh-sm);}
        .home-sec-title{font-size:1.1rem;font-weight:800;color:#fff;margin-bottom:8px;letter-spacing:.5px;text-transform:uppercase;display:flex;gap:8px;align-items:center;}
        .home-sec-icon{font-size:1.3rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));}
        .home-item{padding:8px 0;color:var(--dim);font-size:.9rem;line-height:1.5;display:flex;gap:10px;align-items:flex-start;}
        .home-item-bullet{color:var(--accent);font-weight:700;flex-shrink:0;margin-top:2px;}
        .home-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:12px;}
        .home-stat-card{background:var(--surface);border:1px solid var(--border-b);border-radius:10px;padding:16px;text-align:center;}
        .home-stat-num{font-size:1.8rem;font-weight:800;color:#fff;margin-bottom:4px;}
        .home-stat-label{font-size:.7rem;color:var(--dimmer);text-transform:uppercase;letter-spacing:.5px;}
        .home-subjects{display:flex;flex-direction:column;gap:10px;margin-top:12px;max-height:300px;overflow-y:auto;}
        .home-subjects::-webkit-scrollbar{width:4px;}
        .home-subjects::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:2px;}
        .home-subject-item{padding:12px 14px;background:var(--surface);border:1px solid var(--border-b);border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
        .home-subject-name{font-weight:600;color:#fff;font-size:.9rem;}
        .home-subject-count{font-size:.75rem;color:var(--dimmer);background:rgba(255,255,255,.05);padding:2px 8px;border-radius:6px;font-weight:600;}
        .home-no-subjects{color:var(--dimmer);font-size:.9rem;padding:20px;text-align:center;}
        .home-tips{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
        .home-tip{padding:12px;background:rgba(255,255,255,.03);border-left:3px solid var(--accent);border-radius:6px;color:var(--dim);font-size:.85rem;line-height:1.5;}
        .home-tip strong{color:var(--text);font-weight:600;}


        /* NAV VISIBILITY */
        nav{display:none;}
        nav.show{display:flex;}
        
        .home-btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
        .home-btn-group .home-btn{flex:1;min-width:120px;}
        .home-db-sub{color:var(--dim);font-size:.85rem;margin-bottom:12px;line-height:1.4;}

        /* RESPONSIVE */
        @media(max-width:480px){
            #sidebar{width:260px;left:-260px;}
            .card{max-width:100%;height:240px;}
            .card-face{font-size:1.1rem;padding:24px 20px;}
            .controls{gap:10px;margin-top:16px;padding:0 12px;}
            .btn{flex:1;padding:12px 20px;font-size:.8rem;max-width:160px;}
            .db-btn-group{flex-direction:column;}
            .db-btn-group .btn{width:100%;}
            nav{padding-bottom:max(env(safe-area-inset-bottom),8px);}
            .nav-item{padding:14px 8px;font-size:.7rem;}
        }
        @media(max-width:375px){.card{height:220px;}.card-face{font-size:1rem;padding:20px 16px;}.stat-num{font-size:1.8rem;}}
        @media(max-height:500px) and (orientation:landscape){.card{height:180px;max-width:320px;}.card-face{font-size:.95rem;padding:16px;}.controls{margin-top:12px;}}
    </style>
</head>
<body>

<div id="overlay" onclick="toggleSidebar()"></div>

<div id="onboarding">
    <div class="onboarding-modal">
        <div class="onboarding-title">Welcome to MonoFlash</div>
        <div class="onboarding-subtitle">Your personal flashcard companion with cloud sync</div>
        
        <div class="onboarding-input-group">
            <label class="onboarding-label">Sync Device ID</label>
            <input type="text" id="onboarding-device-id" class="onboarding-input" placeholder="e.g., my-phone-123" maxlength="50">
            <div class="onboarding-info">Leave blank to auto-generate ‚Ä¢ Use the same ID on all your devices to sync</div>
        </div>
        
        <div class="onboarding-buttons">
            <button class="onboarding-btn onboarding-btn-primary" onclick="completeOnboarding()">Get Started</button>
        </div>
    </div>
</div>

<aside id="sidebar">
    <div class="sb-head">
        <div class="sb-title">MonoFlash</div>
        <div class="sb-sub">üì¶ Cards sync manual<br>üìä Progress stays local</div>
    </div>
    <div style="padding:8px 12px;border-bottom:1px solid var(--border-b);text-align:center;">
        <button class="sb-home-btn-subtle" onclick="switchToHome()">üè† Home</button>
    </div>
    <div class="sb-content" id="subject-list"></div>
    <div class="add-btn" onclick="addNewSubject()">+ Add Subject</div>
    <div class="sync-panel">
        <button class="sync-btn" onclick="manualSync()" id="sync-push-btn">
            <div class="dot-wrap">
                <div class="dot" id="sync-dot"></div>
                <svg class="pring" id="pring" viewBox="0 0 24 24">
                    <circle class="pring-track" cx="12" cy="12" r="9"/>
                    <circle class="pring-fill" cx="12" cy="12" r="9" id="pring-fill"
                        stroke-dasharray="56.55" stroke-dashoffset="56.55"/>
                </svg>
            </div>
            <span id="sync-text">Push to Cloud</span>
        </button>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
            <button class="sync-btn" style="margin-bottom:0;flex:1;" onclick="readDatabase()" id="read-btn">
                <span id="read-text">üìñ Read Database</span>
            </button>
            <button class="sync-btn" style="margin-bottom:0;width:48px;flex:none;font-size:1.2rem;padding:12px 0;" onclick="changeSyncId()" title="Change Device ID">üîó</button>
        </div>
        <div class="device-id">ID: <span id="current-device-id">‚Ä¶</span></div>
        <div class="sync-help" id="sync-help">Offline mode - sync loads on demand</div>
    </div>
</aside>

<main id="main">
    <header>
        <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
        <h1 id="header-title">Select a Subject</h1>
    </header>
    <section id="content-area">

        <div id="tab-home" class="tab-view active">
            <div class="home-content">
                <div class="home-hero">
                    <div class="home-title">Welcome to MonoFlash</div>
                    <div class="home-subtitle">Master knowledge with intelligent spaced repetition</div>
                    <div class="home-cta">
                        <button class="home-btn home-btn-primary" onclick="createQuickStart()">Quick Start</button>
                        <button class="home-btn" onclick="toggleSidebar()">Browse Topics</button>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">üìà</span>
                        <span>Your Progress</span>
                    </div>
                    <div class="home-stats-grid" id="home-stats-grid">
                        <div class="home-stat-card">
                            <div class="home-stat-num" id="home-stat-total-subjects">0</div>
                            <div class="home-stat-label">Subjects</div>
                        </div>
                        <div class="home-stat-card">
                            <div class="home-stat-num" id="home-stat-total-topics">0</div>
                            <div class="home-stat-label">Topics</div>
                        </div>
                        <div class="home-stat-card">
                            <div class="home-stat-num" id="home-stat-total-cards">0</div>
                            <div class="home-stat-label">Cards</div>
                        </div>
                        <div class="home-stat-card">
                            <div class="home-stat-num" id="home-stat-accuracy">-</div>
                            <div class="home-stat-label">Accuracy</div>
                        </div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">üìö</span>
                        <span>Your Subjects</span>
                    </div>
                    <div class="home-subjects" id="home-subjects-list">
                        <div class="home-no-subjects">No subjects yet. Create one to begin!</div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">üåê</span>
                        <span>Backup & Restore</span>
                    </div>
                    <p class="home-db-sub">Export or import ALL subjects, topics, and cards in one file</p>
                    <input id="full-backup-input" type="file" accept=".json" style="display:none" onchange="importFullBackup(event)">
                    <div class="home-btn-group">
                        <button class="home-btn" onclick="exportFullBackup()">üì¶ Export ALL Data</button>
                        <button class="home-btn" onclick="document.getElementById('full-backup-input').click()">üì• Import ALL Data</button>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">‚öôÔ∏è</span>
                        <span>Data Management</span>
                    </div>
                    <div class="home-btn-group">
                        <button class="home-btn" onclick="resetAllData()" style="background:rgba(231,76,60,.15);border-color:rgba(231,76,60,.5);color:#e74c3c;">üóëÔ∏è Clear All Data</button>
                        <button class="home-btn" onclick="downloadDatabaseJson()">üíæ Download JSON</button>
                    </div>
                    <p class="home-db-sub" style="margin-top:12px;color:var(--warn);">‚ö†Ô∏è "Clear All Data" will delete everything. Use "Export ALL Data" first to backup!</p>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">‚ú®</span>
                        <span>Getting Started</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">1.</span>
                        <span>Create a <strong>Subject</strong> (e.g., "Biology") using the + Add Subject button</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">2.</span>
                        <span>Add a <strong>Topic</strong> within your subject (e.g., "Cell Structure")</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">3.</span>
                        <span>Import or create <strong>Cards</strong> using the Data tab</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">4.</span>
                        <span>Review cards daily and let <strong>Spaced Repetition</strong> optimize your learning</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">5.</span>
                        <span>Use <strong>Containers</strong> to focus on specific sections or missed cards</span>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">üí°</span>
                        <span>Tips & Tricks</span>
                    </div>
                    <div class="home-tips">
                        <div class="home-tip"><strong>Keyboard Shortcuts:</strong> Space to flip ‚Ä¢ J to Got it ‚Ä¢ F to Missed ‚Ä¢ P to Pass ‚Ä¢ B for Bookmark ‚Ä¢ S for Sidebar</div>
                        <div class="home-tip"><strong>Cloud Sync:</strong> Push to Cloud button syncs your cards. Use the same Device ID on all devices to sync data</div>
                        <div class="home-tip"><strong>Spaced Repetition:</strong> Cards due today appear first. Master cards (7+ days) are shown in Stats</div>
                        <div class="home-tip"><strong>Bookmarks:</strong> Star important cards for quick review. Filter by bookmarks in the Containers menu</div>
                        <div class="home-tip"><strong>Missed Cards:</strong> Cards you missed during a session are grouped for easy review</div>
                    </div>
                </div>

                <div class="home-section">
                    <div class="home-sec-title">
                        <span class="home-sec-icon">‚ú®</span>
                        <span>Features</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Spaced Repetition (SRS)</strong> - SM-2 algorithm for optimal learning intervals</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Cloud Sync</strong> - Push/pull your cards via Cloudflare Workers</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Bookmarks</strong> - Mark important cards for focused review</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Containers</strong> - Organize cards into manageable chunks</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Analytics</strong> - Track accuracy and mastered cards</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Flexible Input</strong> - Import via text, JSON, or files</span>
                    </div>
                    <div class="home-item">
                        <span class="home-item-bullet">‚Ä¢</span>
                        <span><strong>Mobile Ready</strong> - Study on any device with offline support</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-flashcard" class="tab-view">
            <div class="progress-text" id="progress-text" style="display:none;">1 / 0</div>
            <div class="progress-bar-wrap" id="progress-wrap" style="display:none;">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="cont-selector" id="cont-selector" style="display:none;">
                <div class="cont-header" onclick="toggleContainerCollapse()">
                    <span class="cont-chevron">‚ñº</span>
                    <span>Containers</span>
                </div>
                <div class="cont-buttons" id="cont-buttons"></div>
                <div class="cont-info" id="cont-info"></div>
            </div>
            <div class="card-container">
                <div class="card" id="active-card">
                    <div class="bookmark-icon" id="bookmark-icon" onclick="toggleBookmark(event)">‚òÜ</div>
                    <div class="card-face" onclick="flipCard()" id="card-front">Select a topic to begin</div>
                    <div class="card-face card-back" onclick="flipCard()" id="card-back">Your journey starts here</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn" onclick="nextCard(false)">Missed</button>
                <button class="btn" onclick="nextCard('pass')">Pass</button>
                <button class="btn btn-primary" onclick="nextCard(true)">Got it</button>
            </div>
        </div>

        <div id="tab-performance" class="tab-view">
            <div class="stat-box"><div class="stat-num" id="stat-total">0</div><div class="stat-label">Cards Reviewed</div></div>
            <div class="stat-box hi"><div class="stat-num" id="stat-score">0%</div><div class="stat-label">Accuracy</div></div>
            <div class="stat-box"><div class="stat-num" id="stat-due">-</div><div class="stat-label">Cards Due Today</div></div>
            <div class="stat-box"><div class="stat-num" id="stat-mastered">-</div><div class="stat-label">Mastered (7+ days)</div></div>
            <div id="container-stats" style="margin-top:24px;"></div>
        </div>

        <div id="tab-database" class="tab-view">
            <h3 class="db-sec-title">‚ûï Add Cards to Current Topic</h3>
            <p class="db-sub">Format: Question -!- Answer (one per line)<br>OR JSON: [{"q":"Front","a":"Back"}]</p>
            <textarea id="json-input" placeholder='What is gravity? -!- Force that attracts objects
What is speed? -!- Distance over time'></textarea>
            <input id="file-input" type="file" accept=".json" style="display:none" onchange="importJsonFile(event)">
            <div class="db-btn-group">
                <button class="btn btn-primary" onclick="importJson()">Import Data</button>
                <button class="btn" onclick="exportJson()">Export JSON</button>
                <button class="btn" onclick="document.getElementById('file-input').click()">Import File</button>
            </div>
            <div class="db-list-head">
                <h3>Current Entries</h3>
                <button class="btn" onclick="clearAllCards()" style="padding:8px 16px;font-size:.75rem;">Clear All</button>
            </div>
            <div id="db-list"></div>
        </div>

    </section>
    <nav>
        <div class="nav-item active" onclick="switchTab('flashcard',this)">Cards</div>
        <div class="nav-item" onclick="switchTab('performance',this)">Stats</div>
        <div class="nav-item" onclick="switchTab('database',this)">Data</div>
    </nav>
</main>

<script>
// ‚îÄ‚îÄ DEVICE ID & ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hasCompletedOnboarding() {
    return localStorage.getItem('monoFlashOnboardingComplete') === 'true';
}

function showOnboarding() {
    var modal = document.getElementById('onboarding');
    if (modal) modal.classList.add('show');
}

function hideOnboarding() {
    var modal = document.getElementById('onboarding');
    if (modal) modal.classList.remove('show');
}

function completeOnboarding() {
    var input = document.getElementById('onboarding-device-id');
    var deviceId = input.value.trim();
    
    if (deviceId) {
        // User provided a custom ID
        localStorage.setItem('monoFlashDeviceId', deviceId);
    } else {
        // Auto-generate device ID
        var id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('monoFlashDeviceId', id);
    }
    
    // Mark onboarding as complete
    localStorage.setItem('monoFlashOnboardingComplete', 'true');
    
    // Reload to refresh with new device ID
    hideOnboarding();
    location.reload();
}

function getDeviceId() {
    let id = localStorage.getItem('monoFlashDeviceId');
    if (!id) { id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); localStorage.setItem('monoFlashDeviceId', id); }
    return id;
}

var DEVICE_ID = getDeviceId();
document.getElementById('current-device-id').textContent = DEVICE_ID;

function changeSyncId() {
    var n = prompt('Enter a Sync Name (same on all devices):', DEVICE_ID);
    if (n && n.trim()) { localStorage.setItem('monoFlashDeviceId', n.trim()); alert('Linked! Reloading‚Ä¶'); location.reload(); }
}

// ‚îÄ‚îÄ CLOUDFLARE SYNC (No Firebase SDK needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ SYNC UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var CIRC = 2 * Math.PI * 9;
var dotEl      = document.getElementById('sync-dot');
var pringEl    = document.getElementById('pring');
var pringFill  = document.getElementById('pring-fill');
var syncTextEl = document.getElementById('sync-text');
var syncHelpEl = document.getElementById('sync-help');

function setDot(state) {
    dotEl.className = 'dot ' + state;
    if (state === 'syncing') { pringEl.classList.add('show'); } else { pringEl.classList.remove('show'); }
}
function setRing(pct) {
    pringFill.style.strokeDashoffset = CIRC * (1 - pct / 100);
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var cardContent = JSON.parse(localStorage.getItem('monoFlashCardContent') || '{}');
var srsData     = JSON.parse(localStorage.getItem('monoFlashSRSData')     || '{}');
var bookmarks   = JSON.parse(localStorage.getItem('monoFlashBookmarks')   || '{}');
var currentSubject = null, currentSub = null;
var cardIndex = 0, sessionStats = {total:0,correct:0};
var shuffledCards = [], dueCards = [];
var CARDS_PER_CONTAINER = 20;
var currentContainer = 'all', reviewMissedMode = false, reviewBookmarksMode = false;
var missedCardsThisSession = new Set();

// ‚îÄ‚îÄ CLOUDFLARE SYNC FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pushToCloud() {
    setDot('syncing'); setRing(20);
    syncTextEl.textContent = 'Pushing...';
    syncHelpEl.textContent = 'Uploading to Cloudflare...';

    try {
        setRing(50);
        const response = await fetch(WORKER_URL + '?deviceId=' + encodeURIComponent(DEVICE_ID), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cardContent: cardContent,
                bookmarks: bookmarks
            })
        });

        setRing(70);
        const result = await response.json();
        
        if (!response.ok || !result.success) {
            throw new Error(result.error || 'Upload failed');
        }

        setRing(100); setDot('online');
        syncTextEl.textContent = 'Push to Cloud';
        syncHelpEl.textContent = '‚úÖ Uploaded successfully';
        setTimeout(function() { 
            setDot('offline'); 
            syncHelpEl.textContent = 'Ready to sync';
        }, 2000);
    } catch(err) {
        console.error('Push failed:', err);
        setDot('error');
        syncHelpEl.textContent = 'Upload failed: ' + err.message;
    }
}

function manualSync() { pushToCloud(); }

async function readDatabase() {
    var btn = document.getElementById('read-text');
    var help = document.getElementById('sync-help');
    
    btn.textContent = '‚è≥ Downloading...';
    help.textContent = 'Fetching from Cloudflare...';
    setDot('syncing'); setRing(20);

    try {
        setRing(40);
        const response = await fetch(WORKER_URL + '?deviceId=' + encodeURIComponent(DEVICE_ID), {
            method: 'GET'
        });

        setRing(60);
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Download failed');
        }

        setRing(80);

        if (result.exists && result.data) {
            // Clear local and replace with cloud data
            cardContent = result.data.cardContent || {};
            bookmarks = result.data.bookmarks || {};
            saveLocal();
            
            // Reset UI
            renderSidebar();
            loadSidebarState();
            currentSubject = null; currentSub = null;
            document.getElementById('header-title').textContent = 'Home';
            renderCard();
            updateHomeStats();
            renderHomeSubjects();

            btn.textContent = '‚úÖ Done';
            help.textContent = 'Data replaced from cloud';
            setRing(100); setDot('online');
        } else {
            help.textContent = 'No cloud data found';
            btn.textContent = '‚ùå Empty';
            setDot('offline');
        }
    } catch(err) {
        console.error('Read error:', err);
        help.textContent = 'Error: ' + err.message;
        btn.textContent = '‚ùå Error';
        setDot('error');
    }

    setTimeout(function() { 
        btn.textContent = 'üìñ Read Database'; 
        if(dotEl.className.includes('online')) {
            setDot('offline');
            help.textContent = 'Ready to sync';
        }
    }, 2000);
}

// ‚îÄ‚îÄ SRS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createSRS() { return {interval:0,easiness:2.5,repetitions:0,nextReview:Date.now(),lastReviewed:null}; }
function updateSRS(s, q) {
    s.lastReviewed = Date.now();
    if (q === 0) { s.repetitions = 0; s.interval = 1; }
    else {
        s.repetitions++;
        s.interval = s.repetitions === 1 ? 1 : s.repetitions === 2 ? 6 : Math.round(s.interval * s.easiness);
        s.easiness = Math.max(1.3, s.easiness + 0.1 - (1 - q) * 0.2);
    }
    s.nextReview = Date.now() + s.interval * 86400000;
    return s;
}
function isDue(s) { return !s || !s.nextReview || Date.now() >= s.nextReview; }
function ensureSRS() {
    for (var subj in cardContent) {
        if (!srsData[subj]) srsData[subj] = {};
        for (var sub in cardContent[subj]) {
            if (!srsData[subj][sub]) srsData[subj][sub] = [];
            var need = cardContent[subj][sub].length - srsData[subj][sub].length;
            for (var i = 0; i < need; i++) srsData[subj][sub].push(createSRS());
        }
    }
}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal() {
    ensureSRS();
    localStorage.setItem('monoFlashCardContent', JSON.stringify(cardContent));
    localStorage.setItem('monoFlashSRSData',     JSON.stringify(srsData));
    localStorage.setItem('monoFlashBookmarks',   JSON.stringify(bookmarks));
}
function saveData() { saveLocal(); }

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSidebar() {
    var list = document.getElementById('subject-list');
    list.innerHTML = '';
    for (var subj in cardContent) {
        (function(subj){
            var item = document.createElement('div'); item.className = 'subject-item';
            var title = document.createElement('div'); title.className = 'subject-title';
            var ttxt = document.createElement('span'); ttxt.textContent = subj;
            ttxt.onclick = function(){ toggleSubject(subj); };
            title.appendChild(ttxt);
            var actions = document.createElement('div'); actions.className = 'subject-actions';
            var chev = document.createElement('span'); chev.className = 'chevron'; chev.textContent = '‚ñº';
            chev.onclick = function(){ toggleSubject(subj); };
            actions.appendChild(chev);
            var del = document.createElement('span'); del.className = 'del-icon'; del.textContent = '√ó';
            del.onclick = function(e){ e.stopPropagation(); deleteSubject(subj); };
            actions.appendChild(del);
            title.appendChild(actions); item.appendChild(title);

            var subList = document.createElement('div'); subList.className = 'sub-list';
            subList.id = 'sub-' + safeId(subj);
            for (var sub in cardContent[subj]) {
                (function(sub){
                    var si = document.createElement('div'); si.className = 'sub-item';
                    var stxt = document.createElement('span');
                    stxt.innerHTML = sub + ' <span class="card-count">' + cardContent[subj][sub].length + '</span>';
                    stxt.onclick = function(){ loadTopic(subj, sub); };
                    si.appendChild(stxt);
                    var sdel = document.createElement('span'); sdel.className = 'del-icon'; sdel.textContent = '√ó';
                    sdel.onclick = function(e){ e.stopPropagation(); deleteSub(subj, sub); };
                    si.appendChild(sdel);
                    subList.appendChild(si);
                })(sub);
            }
            var addTopicBtn = document.createElement('div'); addTopicBtn.className = 'add-btn';
            addTopicBtn.textContent = '+ Add Topic'; addTopicBtn.style.margin = '8px';
            addTopicBtn.onclick = function(){ addNewSub(subj); };
            subList.appendChild(addTopicBtn);
            item.appendChild(subList); list.appendChild(item);
        })(subj);
    }
}
function toggleSubject(subj) {
    var el = document.getElementById('sub-' + safeId(subj));
    if (!el) return;
    el.classList.toggle('show'); el.parentElement.classList.toggle('expanded');
    saveSidebarState();
}
function saveSidebarState() {
    var open = [];
    document.querySelectorAll('.sub-list.show').forEach(function(el){ open.push(el.id.replace('sub-','')); });
    localStorage.setItem('monoFlashSidebarState', JSON.stringify(open));
}
function loadSidebarState() {
    try {
        var saved = JSON.parse(localStorage.getItem('monoFlashSidebarState') || '[]');
        saved.forEach(function(id){
            var el = document.getElementById('sub-' + id);
            if (el) { el.classList.add('show'); el.parentElement.classList.add('expanded'); }
        });
    } catch(e) {}
}
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show');
}
function addNewSubject() {
    var name = prompt('New Subject name:');
    if (name && name.trim()) { 
        var t = name.trim(); 
        if (!cardContent[t]) { 
            cardContent[t] = {}; 
            saveData(); 
            renderSidebar(); 
            loadSidebarState(); 
            updateHomeStats();
            renderHomeSubjects();
        } 
    }
}
function addNewSub(subj) {
    var name = prompt('New Topic name for "' + subj + '":');
    if (name && name.trim()) { 
        var t = name.trim(); 
        if (!cardContent[subj][t]) { 
            cardContent[subj][t] = []; 
            saveData(); 
            renderSidebar(); 
            loadSidebarState(); 
            updateHomeStats();
            renderHomeSubjects();
        } 
    }
}
function deleteSubject(subj) {
    if (!confirm('Delete subject "' + subj + '" and all its cards?')) return;
    delete cardContent[subj]; delete srsData[subj];
    if (currentSubject === subj) { currentSubject = null; currentSub = null; document.getElementById('header-title').textContent = 'Home'; }
    saveData(); renderSidebar(); renderDbList(); updateHomeStats(); renderHomeSubjects();
}
function deleteSub(subj, sub) {
    if (!confirm('Delete topic "' + sub + '" and all its cards?')) return;
    delete cardContent[subj][sub];
    if (srsData[subj]) delete srsData[subj][sub];
    if (currentSubject === subj && currentSub === sub) { currentSub = null; document.getElementById('header-title').textContent = subj; renderCard(); }
    saveData(); renderSidebar(); renderDbList(); updateHomeStats(); renderHomeSubjects();
}

// ‚îÄ‚îÄ BOOKMARKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleBookmark(e) {
    e.stopPropagation(); // Don't flip card when clicking bookmark
    if (!currentSubject || !currentSub || !shuffledCards.length || cardIndex >= shuffledCards.length) return;
    
    var cardIdx = shuffledCards[cardIndex]._index;
    
    // Initialize structure if needed
    if (!bookmarks[currentSubject]) bookmarks[currentSubject] = {};
    if (!bookmarks[currentSubject][currentSub]) bookmarks[currentSubject][currentSub] = [];
    
    var bookmarkList = bookmarks[currentSubject][currentSub];
    var idx = bookmarkList.indexOf(cardIdx);
    
    if (idx > -1) {
        // Remove bookmark
        bookmarkList.splice(idx, 1);
    } else {
        // Add bookmark
        bookmarkList.push(cardIdx);
    }
    
    saveLocal();
    updateBookmarkIcon();
    renderContSel(); // Update counts
}

function updateBookmarkIcon() {
    var icon = document.getElementById('bookmark-icon');
    if (!currentSubject || !currentSub || !shuffledCards.length || cardIndex >= shuffledCards.length) {
        icon.style.display = 'none';
        return;
    }
    
    icon.style.display = 'block';
    var cardIdx = shuffledCards[cardIndex]._index;
    var isBookmarked = bookmarks[currentSubject] && 
                       bookmarks[currentSubject][currentSub] && 
                       bookmarks[currentSubject][currentSub].indexOf(cardIdx) > -1;
    
    icon.textContent = isBookmarked ? '‚òÖ' : '‚òÜ';
    icon.className = isBookmarked ? 'bookmark-icon active' : 'bookmark-icon';
}

function getBookmarkCount() {
    if (!currentSubject || !currentSub) return 0;
    return (bookmarks[currentSubject] && bookmarks[currentSubject][currentSub]) ? 
           bookmarks[currentSubject][currentSub].length : 0;
}

// ‚îÄ‚îÄ FLASHCARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadTopic(subj, sub) {
    currentSubject = subj; currentSub = sub;
    currentContainer = 'all'; reviewMissedMode = false; reviewBookmarksMode = false;
    missedCardsThisSession.clear(); cardIndex = 0;
    sessionStats = {total:0,correct:0};
    document.getElementById('header-title').textContent = subj + ' ‚Ä∫ ' + sub;
    ensureSRS();
    var cards = (cardContent[subj] && cardContent[subj][sub]) || [];
    var srs   = (srsData[subj]    && srsData[subj][sub])    || [];
    var w = cards.map(function(c,i){ return {q:c.q,a:c.a,srs:srs[i],_index:i}; });
    dueCards = w.filter(function(c){ return isDue(c.srs); });
    shuffledCards = shuffle(dueCards.length ? dueCards : w);
    
    // Show nav when topic is selected
    document.querySelector('nav').classList.add('show');
    
    // Switch to flashcard tab
    document.querySelectorAll('.tab-view').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.nav-item').forEach(function(n){ n.classList.remove('active'); });
    document.getElementById('tab-flashcard').classList.add('active');
    var navItems = document.querySelectorAll('.nav-item');
    if (navItems.length > 0) navItems[0].classList.add('active'); // Flashcard tab (1st item)
    
    renderCard(); updateStats(); renderDbList(); renderContSel();
    document.querySelectorAll('.sub-item').forEach(function(el){ el.classList.remove('active'); });
    if (event && event.target) { var si = event.target.closest('.sub-item'); if (si) si.classList.add('active'); }
    toggleSidebar();
}
function renderCard() {
    var front = document.getElementById('card-front'), back = document.getElementById('card-back');
    document.getElementById('active-card').classList.remove('flipped');
    
    // Update progress bar
    var progressWrap = document.getElementById('progress-wrap');
    var progressBar = document.getElementById('progress-bar');
    var progressText = document.getElementById('progress-text');
    
    if (!shuffledCards.length || cardIndex >= shuffledCards.length) {
        front.textContent = currentSub ? 'No cards available' : 'Go to Home to select a topic';
        back.textContent  = currentSub ? 'Add cards in the Data tab' : 'Browse your subjects';
        progressWrap.style.display = 'none';
        progressText.style.display = 'none';
        document.getElementById('bookmark-icon').style.display = 'none';
        return;
    }
    
    // Show and update progress (start counting at 1)
    if (shuffledCards.length > 0) {
        progressWrap.style.display = 'block';
        progressText.style.display = 'block';
        var pct = (cardIndex / shuffledCards.length) * 100;
        progressBar.style.width = pct + '%';
        progressText.textContent = (cardIndex + 1) + ' / ' + shuffledCards.length;
    }
    
    // Safely access current card
    if (!shuffledCards[cardIndex]) return;
    front.textContent = shuffledCards[cardIndex].q;
    back.textContent  = shuffledCards[cardIndex].a;
    updateBookmarkIcon();
}
function flipCard() {
    if (!shuffledCards.length || cardIndex >= shuffledCards.length) return;
    document.getElementById('active-card').classList.toggle('flipped');
}
function nextCard(quality) {
    if (!currentSubject || !currentSub || !shuffledCards.length || cardIndex >= shuffledCards.length) return;
    var cur = shuffledCards[cardIndex];
    
    // quality: false = missed (0), 'pass' = skip (no SRS update), true = got it (1)
    if (quality !== 'pass') {
        updateSRS(cur.srs, quality ? 1 : 0);
        if (!quality) missedCardsThisSession.add(cur._index);
        saveLocal();
        sessionStats.total++; 
        if (quality) sessionStats.correct++;
    }
    // Pass doesn't affect SRS or stats - just moves to next card
    
    updateStats(); renderContSel();
    cardIndex++; renderCard();
}
function updateStats() {
    document.getElementById('stat-total').textContent = sessionStats.total;
    var pct = sessionStats.total ? Math.round(sessionStats.correct / sessionStats.total * 100) : 0;
    document.getElementById('stat-score').textContent = pct + '%';
    if (currentSubject && currentSub && cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
        var srs = (srsData[currentSubject] && srsData[currentSubject][currentSub]) || [];
        document.getElementById('stat-due').textContent      = srs.filter(function(s){ return isDue(s); }).length;
        document.getElementById('stat-mastered').textContent = srs.filter(function(s){ return s.interval >= 7; }).length;
        renderContStats(cardContent[currentSubject][currentSub]);
    } else {
        document.getElementById('stat-due').textContent = '-';
        document.getElementById('stat-mastered').textContent = '-';
        document.getElementById('container-stats').innerHTML = '';
    }
}

// ‚îÄ‚îÄ CONTAINERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderContSel() {
    var wrap = document.getElementById('cont-selector');
    var buttons = document.getElementById('cont-buttons');
    var info = document.getElementById('cont-info');
    
    if (!currentSubject || !currentSub || !(cardContent[currentSubject] && cardContent[currentSubject][currentSub])) { 
        wrap.style.display='none'; 
        return; 
    }
    
    var all = cardContent[currentSubject][currentSub];
    var num = Math.ceil(all.length / CARDS_PER_CONTAINER);
    
    if (all.length <= CARDS_PER_CONTAINER && missedCardsThisSession.size === 0 && getBookmarkCount() === 0) { 
        wrap.style.display='none'; 
        return; 
    }
    
    wrap.style.display = 'flex';
    buttons.innerHTML = '';
    
    // Bookmarks button (golden) - FIRST
    var bookmarkBtn = mkCBtn('Bookmarks (' + getBookmarkCount() + ')', reviewBookmarksMode, function(){ toggleReviewBookmarks(); });
    bookmarkBtn.classList.add('bookmarks');
    buttons.appendChild(bookmarkBtn);
    
    // Missed button (red) - SECOND
    var missedBtn = mkCBtn('Missed (' + missedCardsThisSession.size + ')', reviewMissedMode, function(){ toggleReviewMissed(); });
    missedBtn.classList.add('missed');
    buttons.appendChild(missedBtn);
    
    // All button - THIRD
    buttons.appendChild(mkCBtn('All', currentContainer === 'all' && !reviewMissedMode && !reviewBookmarksMode, function(){ selectContainer('all'); }));
    
    // Container buttons
    for (var i = 0; i < num; i++) {
        (function(i){
            var s0 = i * CARDS_PER_CONTAINER, e0 = Math.min(s0 + CARDS_PER_CONTAINER, all.length);
            buttons.appendChild(mkCBtn('C'+(i+1)+' ('+(e0-s0)+')', currentContainer === i && !reviewMissedMode && !reviewBookmarksMode, function(){ selectContainer(i); }));
        })(i);
    }
    
    info.textContent = all.length + ' total cards ¬∑ ' + CARDS_PER_CONTAINER + ' per container';
}

function toggleContainerCollapse() {
    document.getElementById('cont-selector').classList.toggle('collapsed');
}
function mkCBtn(label, active, fn) {
    var b = document.createElement('button'); b.className = 'cont-btn' + (active ? ' active' : '');
    b.textContent = label; b.onclick = fn; return b;
}
function selectContainer(id) {
    currentContainer = id; reviewMissedMode = false; reviewBookmarksMode = false; cardIndex = 0;
    if (!currentSubject || !currentSub || !(cardContent[currentSubject] && cardContent[currentSubject][currentSub])) return;
    var cards = cardContent[currentSubject][currentSub];
    var srs   = srsData[currentSubject][currentSub];
    if (id === 'all') {
        var w = cards.map(function(c,i){ return {q:c.q,a:c.a,srs:srs[i],_index:i}; });
        var due = w.filter(function(c){ return isDue(c.srs); });
        shuffledCards = shuffle(due.length ? due : w);
    } else {
        var s0 = id * CARDS_PER_CONTAINER, e0 = Math.min(s0 + CARDS_PER_CONTAINER, cards.length);
        var w2 = cards.slice(s0, e0).map(function(c,i){ return {q:c.q,a:c.a,srs:srs[s0+i],_index:s0+i}; });
        var due2 = w2.filter(function(c){ return isDue(c.srs); });
        shuffledCards = shuffle(due2.length ? due2 : w2);
    }
    renderCard(); renderContSel();
}
function toggleReviewMissed() {
    if (!missedCardsThisSession.size) { alert('No missed cards yet!'); return; }
    reviewMissedMode = !reviewMissedMode; reviewBookmarksMode = false; cardIndex = 0;
    if (reviewMissedMode) {
        var cards = cardContent[currentSubject][currentSub];
        var srs   = srsData[currentSubject][currentSub];
        shuffledCards = shuffle(Array.from(missedCardsThisSession)
            .map(function(i){ return {q:cards[i].q,a:cards[i].a,srs:srs[i],_index:i}; })
            .filter(function(c){ return c.q; }));
    } else { selectContainer(currentContainer); }
    renderCard(); renderContSel();
}
function toggleReviewBookmarks() {
    var count = getBookmarkCount();
    if (!count) { alert('No bookmarked cards yet!'); return; }
    reviewBookmarksMode = !reviewBookmarksMode; reviewMissedMode = false; cardIndex = 0;
    if (reviewBookmarksMode) {
        var cards = cardContent[currentSubject][currentSub];
        var srs   = srsData[currentSubject][currentSub];
        var bookmarkedIndices = bookmarks[currentSubject][currentSub] || [];
        shuffledCards = shuffle(bookmarkedIndices
            .map(function(i){ return {q:cards[i].q,a:cards[i].a,srs:srs[i],_index:i}; })
            .filter(function(c){ return c.q; }));
    } else { selectContainer(currentContainer); }
    renderCard(); renderContSel();
}
function renderContStats(allCards) {
    var wrap = document.getElementById('container-stats');
    var num = Math.ceil(allCards.length / CARDS_PER_CONTAINER);
    if (num <= 1) { wrap.innerHTML = ''; return; }
    wrap.innerHTML = '<h3 class="db-sec-title" style="margin-bottom:16px;">Container Breakdown</h3>';
    for (var i = 0; i < num; i++) {
        var s0 = i * CARDS_PER_CONTAINER, e0 = Math.min(s0 + CARDS_PER_CONTAINER, allCards.length);
        var csrs = srsData[currentSubject][currentSub].slice(s0, e0);
        var box = document.createElement('div'); box.className = 'cont-stat';
        box.innerHTML = '<div class="cont-stat-h">Container '+(i+1)+' ('+(e0-s0)+' cards)</div>' +
            '<div class="cont-stat-d">' + csrs.filter(function(s){ return s.interval>=7; }).length + ' mastered ¬∑ ' +
            csrs.filter(function(s){ return isDue(s); }).length + ' due today</div>';
        wrap.appendChild(box);
    }
}

// ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseText(text) {
    return text.split('\n').filter(function(l){ return l.includes('-!-'); }).map(function(l){
        var p = l.split('-!-'); return p.length >= 2 ? {q:p[0].trim(), a:p.slice(1).join('-!-').trim()} : null;
    }).filter(function(c){ return c && c.q && c.a; });
}
function validCards(arr) { return Array.isArray(arr) && arr.every(function(c){ return c && typeof c.q==='string' && typeof c.a==='string'; }); }

function importJson() {
    if (!currentSubject || !currentSub) { alert('Select a Subject and Topic first.'); return; }
    var raw = document.getElementById('json-input').value.trim();
    if (!raw) { alert('Enter some data first.'); return; }
    var cards = [];
    if (raw.includes('-!-')) { cards = parseText(raw); }
    else { try { cards = JSON.parse(raw); if (!validCards(cards)) throw 0; } catch { alert('Invalid format.'); return; } }
    if (!cards.length) { alert('No valid cards found.'); return; }
    doAddCards(cards);
    document.getElementById('json-input').value = '';
}
function importJsonFile(e) {
    if (!currentSubject || !currentSub) { alert('Select a Subject and Topic first.'); e.target.value=''; return; }
    var file = e.target.files && e.target.files[0]; if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        try { var p = JSON.parse(ev.target.result); if (!validCards(p)) throw 0; doAddCards(p); }
        catch { alert('Unable to parse file.'); }
        e.target.value = '';
    };
    reader.readAsText(file);
}
function doAddCards(newCards) {
    if (!cardContent[currentSubject][currentSub]) cardContent[currentSubject][currentSub] = [];
    var existing = cardContent[currentSubject][currentSub];
    var added = 0, dupes = 0;
    newCards.forEach(function(c) {
        if (existing.some(function(e){ return e.q.trim().toLowerCase() === c.q.trim().toLowerCase(); })) { dupes++; }
        else { existing.push(c); added++; }
    });
    ensureSRS(); saveData(); renderDbList(); renderSidebar(); updateHomeStats(); renderHomeSubjects();
    var cards = cardContent[currentSubject][currentSub];
    var srs   = srsData[currentSubject][currentSub];
    var w = cards.map(function(c,i){ return {q:c.q,a:c.a,srs:srs[i],_index:i}; });
    dueCards = w.filter(function(c){ return isDue(c.srs); });
    shuffledCards = shuffle(dueCards.length ? dueCards : w);
    renderCard();
    alert('Added ' + added + ' card' + (added!==1?'s':'') + '!' + (dupes ? '\n' + dupes + ' duplicate' + (dupes!==1?'s':'') + ' skipped.' : ''));
}
function exportJson() {
    if (!currentSubject || !currentSub) { alert('Select a Subject and Topic first.'); return; }
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(cardContent[currentSubject][currentSub],null,2)],{type:'application/json'}));
    a.download = safeId(currentSubject) + '-' + safeId(currentSub) + '.json';
    document.body.appendChild(a); a.click(); a.remove();
}
function exportFullBackup() {
    var total = 0;
    for (var s in cardContent) for (var t in cardContent[s]) total += cardContent[s][t].length;
    var backup = {version:1, exportDate:new Date().toISOString(), deviceId:DEVICE_ID, cardContent:cardContent, metadata:{totalSubjects:Object.keys(cardContent).length, totalCards:total}};
    var ts = new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(backup,null,2)],{type:'application/json'}));
    a.download = 'MonoFlash-Backup-' + ts + '.json';
    document.body.appendChild(a); a.click(); a.remove();
    alert('‚úÖ Backup created!\n\n' + backup.metadata.totalSubjects + ' subjects\n' + backup.metadata.totalCards + ' total cards');
}
function importFullBackup(e) {
    var file = e.target.files && e.target.files[0]; if (!file) return;
    if (!confirm('‚ö†Ô∏è This will REPLACE all your current data. Continue?')) { e.target.value=''; return; }
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var b = JSON.parse(ev.target.result);
            if (!b.cardContent || typeof b.cardContent !== 'object') throw new Error('Invalid backup');
            var total = 0;
            for (var s in b.cardContent) for (var t in b.cardContent[s]) total += b.cardContent[s][t].length;
            if (!confirm('üì¶ Ready to import:\n‚úì ' + Object.keys(b.cardContent).length + ' subjects\n‚úì ' + total + ' cards\n\nProceed?')) { e.target.value=''; return; }
            cardContent = b.cardContent; srsData = {};
            ensureSRS(); saveData();
            renderSidebar(); loadSidebarState(); renderDbList(); updateHomeStats(); renderHomeSubjects();
            currentSubject = null; currentSub = null;
            document.getElementById('header-title').textContent = 'Home';
            renderCard();
            alert('‚úÖ Imported! Syncing to cloud‚Ä¶');
        } catch(err) { alert('‚ùå Failed: ' + err.message); }
        e.target.value = '';
    };
    reader.readAsText(file);
}
function renderDbList() {
    var list = document.getElementById('db-list'); list.innerHTML = '';
    if (!currentSubject || !currentSub || !(cardContent[currentSubject] && cardContent[currentSubject][currentSub])) return;
    cardContent[currentSubject][currentSub].forEach(function(c, i) {
        var item = document.createElement('div'); 
        item.className = 'db-item';
        item.id = 'db-item-' + i;
        
        var content = document.createElement('div'); 
        content.className = 'db-item-content';
        content.innerHTML = '<div class="db-key">' + c.q + '</div><div class="db-val">' + c.a + '</div>';
        
        var actions = document.createElement('div');
        actions.className = 'db-item-actions';
        
        var editBtn = document.createElement('button'); 
        editBtn.className = 'btn db-btn-edit';
        editBtn.style.cssText = 'padding:6px 12px;font-size:.75rem;';
        editBtn.textContent = '‚úèÔ∏è Edit';
        editBtn.onclick = (function(idx){ return function(){ editCard(idx); }; })(i);
        
        var delBtn = document.createElement('button'); 
        delBtn.className = 'btn db-btn-delete';
        delBtn.style.cssText = 'padding:6px 12px;font-size:.75rem;';
        delBtn.textContent = 'Delete';
        delBtn.onclick = (function(idx){ return function(){ deleteCard(idx); }; })(i);
        
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        item.appendChild(content); 
        item.appendChild(actions); 
        list.appendChild(item);
    });
}
function editCard(idx) {
    var item = document.getElementById('db-item-' + idx);
    if (!item) return;
    
    var card = cardContent[currentSubject][currentSub][idx];
    
    // Create edit interface
    var editDiv = document.createElement('div');
    editDiv.className = 'db-item-edit';
    
    var inputsDiv = document.createElement('div');
    inputsDiv.className = 'db-edit-inputs';
    
    var qInput = document.createElement('input');
    qInput.className = 'db-edit-input';
    qInput.value = card.q;
    qInput.placeholder = 'Question';
    
    var aInput = document.createElement('input');
    aInput.className = 'db-edit-input';
    aInput.value = card.a;
    aInput.placeholder = 'Answer';
    
    inputsDiv.appendChild(qInput);
    inputsDiv.appendChild(aInput);
    
    var actions = document.createElement('div');
    actions.className = 'db-item-actions';
    
    var saveBtn = document.createElement('button');
    saveBtn.className = 'btn';
    saveBtn.style.cssText = 'padding:6px 12px;font-size:.75rem;background:var(--ok);border-color:var(--ok);';
    saveBtn.textContent = 'üíæ Save';
    saveBtn.onclick = function() {
        var newQ = qInput.value.trim();
        var newA = aInput.value.trim();
        if (!newQ || !newA) { alert('Question and Answer cannot be empty'); return; }
        cardContent[currentSubject][currentSub][idx] = {q: newQ, a: newA};
        saveData();
        renderDbList();
        // Update current card if it's being displayed
        if (shuffledCards[cardIndex] && shuffledCards[cardIndex]._index === idx) {
            shuffledCards[cardIndex].q = newQ;
            shuffledCards[cardIndex].a = newA;
            renderCard();
        }
    };
    
    var cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn';
    cancelBtn.style.cssText = 'padding:6px 12px;font-size:.75rem;';
    cancelBtn.textContent = '‚úï Cancel';
    cancelBtn.onclick = function() { renderDbList(); };
    
    actions.appendChild(saveBtn);
    actions.appendChild(cancelBtn);
    editDiv.appendChild(inputsDiv);
    editDiv.appendChild(actions);
    
    // Replace content
    item.innerHTML = '';
    item.appendChild(editDiv);
    qInput.focus();
}

function deleteCard(idx) {
    if (!confirm('Delete this card?')) return;
    cardContent[currentSubject][currentSub].splice(idx,1);
    if (srsData[currentSubject] && srsData[currentSubject][currentSub]) srsData[currentSubject][currentSub].splice(idx,1);
    saveData(); renderDbList(); renderSidebar();
    var cards = cardContent[currentSubject][currentSub];
    var srs   = srsData[currentSubject][currentSub];
    var w = cards.map(function(c,i){ return {q:c.q,a:c.a,srs:srs[i],_index:i}; });
    shuffledCards = shuffle(w.filter(function(c){ return isDue(c.srs); }).length ? w.filter(function(c){ return isDue(c.srs); }) : w);
    renderCard();
}
function clearAllCards() {
    if (!currentSubject || !currentSub) { alert('Select a subject and topic first.'); return; }
    if (!confirm('Clear ALL cards in ' + currentSubject + ' > ' + currentSub + '?')) return;
    cardContent[currentSubject][currentSub] = [];
    if (srsData[currentSubject]) srsData[currentSubject][currentSub] = [];
    saveData(); renderDbList(); renderSidebar(); shuffledCards = []; renderCard();
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name, el) {
    document.querySelectorAll('.tab-view').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.nav-item').forEach(function(n){ n.classList.remove('active'); });
    document.getElementById('tab-' + name).classList.add('active');
    el.classList.add('active');
    
    if (name === 'home') {
        switchToHome();
    } else {
        // Show nav for other tabs
        document.querySelector('nav').classList.add('show');
        if (name === 'flashcard') {
            document.getElementById('header-title').textContent = currentSubject && currentSub ? currentSubject + ' ‚Ä∫ ' + currentSub : 'Select a Subject';
        } else if (name === 'performance') {
            updateStats();
        } else if (name === 'database') {
            renderDbList();
        }
    }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shuffle(arr) {
    var a = arr.slice();
    for (var i = a.length-1; i > 0; i--) { var j = Math.floor(Math.random()*(i+1)); var tmp=a[i]; a[i]=a[j]; a[j]=tmp; }
    return a;
}
function safeId(s) { return String(s||'').trim().toLowerCase().replace(/[^a-z0-9_-]+/g,'-'); }

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var sidebarNavMode = false;
var sidebarNavIndex = -1;
var sidebarNavItems = [];

document.addEventListener('keydown', function(e) {
    var tag = document.activeElement && document.activeElement.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA') return;
    
    // Sidebar navigation mode
    if (sidebarNavMode) {
        handleSidebarNav(e);
        return;
    }
    
    var tab = document.querySelector('.tab-view.active');
    if (!tab || tab.id !== 'tab-flashcard') return;
    
    // Flashcard shortcuts
    if (e.code==='Space'||e.code==='Enter')       { e.preventDefault(); flipCard(); }
    else if (e.code==='ArrowRight'||e.code==='KeyJ') { e.preventDefault(); nextCard(true); }
    else if (e.code==='ArrowLeft'||e.code==='KeyF')  { e.preventDefault(); nextCard(false); }
    else if (e.code==='ArrowUp'||e.code==='KeyP')    { e.preventDefault(); nextCard('pass'); }
    else if (e.code==='KeyB') { e.preventDefault(); toggleBookmark(e); }
    else if (e.code==='Period'||e.key==='>') { e.preventDefault(); nextContainer(); }
    else if (e.code==='Comma'||e.key==='<')  { e.preventDefault(); prevContainer(); }
    else if (e.code==='KeyS') { 
        e.preventDefault(); 
        var sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('open') && sidebarNavMode) {
            exitSidebarNavMode();
            toggleSidebar();
        } else {
            enterSidebarNavMode();
        }
    }
});

function nextContainer() {
    if (!currentSubject || !currentSub) return;
    var containers = getContainerList();
    if (containers.length === 0) return;
    
    var currentIdx = getCurrentContainerIndex(containers);
    var nextIdx = (currentIdx + 1) % containers.length;
    activateContainer(containers[nextIdx]);
}

function prevContainer() {
    if (!currentSubject || !currentSub) return;
    var containers = getContainerList();
    if (containers.length === 0) return;
    
    var currentIdx = getCurrentContainerIndex(containers);
    var prevIdx = (currentIdx - 1 + containers.length) % containers.length;
    activateContainer(containers[prevIdx]);
}

function getContainerList() {
    var list = [];
    if (getBookmarkCount() > 0) list.push({type:'bookmarks'});
    if (missedCardsThisSession.size > 0) list.push({type:'missed'});
    list.push({type:'all'});
    
    if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
        var num = Math.ceil(cardContent[currentSubject][currentSub].length / CARDS_PER_CONTAINER);
        for (var i = 0; i < num; i++) {
            list.push({type:'container', id:i});
        }
    }
    return list;
}

function getCurrentContainerIndex(containers) {
    for (var i = 0; i < containers.length; i++) {
        var c = containers[i];
        if (reviewBookmarksMode && c.type === 'bookmarks') return i;
        if (reviewMissedMode && c.type === 'missed') return i;
        if (!reviewBookmarksMode && !reviewMissedMode && c.type === 'all' && currentContainer === 'all') return i;
        if (!reviewBookmarksMode && !reviewMissedMode && c.type === 'container' && currentContainer === c.id) return i;
    }
    // If no exact match found, return first container
    return containers.length > 0 ? 0 : -1;
}

function activateContainer(container) {
    if (container.type === 'bookmarks') toggleReviewBookmarks();
    else if (container.type === 'missed') toggleReviewMissed();
    else if (container.type === 'all') selectContainer('all');
    else if (container.type === 'container') selectContainer(container.id);
}

// ‚îÄ‚îÄ SIDEBAR NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enterSidebarNavMode() {
    var sidebar = document.getElementById('sidebar');
    if (!sidebar.classList.contains('open')) {
        toggleSidebar();
    }
    
    sidebarNavMode = true;
    sidebarNavIndex = 0;
    buildSidebarNavList();
    highlightSidebarItem();
}

function exitSidebarNavMode() {
    sidebarNavMode = false;
    sidebarNavIndex = -1;
    clearSidebarHighlights();
}

function buildSidebarNavList() {
    sidebarNavItems = [];
    var subjects = document.querySelectorAll('.subject-title');
    subjects.forEach(function(el) {
        sidebarNavItems.push({type:'subject', element:el});
        var parent = el.closest('.subject-item');
        if (parent && parent.classList.contains('expanded')) {
            var topics = parent.querySelectorAll('.sub-item');
            topics.forEach(function(topic) {
                sidebarNavItems.push({type:'topic', element:topic});
            });
        }
    });
}

function highlightSidebarItem() {
    clearSidebarHighlights();
    if (sidebarNavIndex >= 0 && sidebarNavIndex < sidebarNavItems.length) {
        var item = sidebarNavItems[sidebarNavIndex];
        item.element.style.outline = '2px solid #fff';
        item.element.style.outlineOffset = '2px';
        item.element.scrollIntoView({block:'nearest', behavior:'smooth'});
    }
}

function clearSidebarHighlights() {
    sidebarNavItems.forEach(function(item) {
        item.element.style.outline = '';
        item.element.style.outlineOffset = '';
    });
}

function handleSidebarNav(e) {
    if (e.code === 'Escape') {
        e.preventDefault();
        exitSidebarNavMode();
        toggleSidebar();
        return;
    }
    
    if (e.code === 'ArrowDown') {
        e.preventDefault();
        sidebarNavIndex = Math.min(sidebarNavIndex + 1, sidebarNavItems.length - 1);
        highlightSidebarItem();
    }
    else if (e.code === 'ArrowUp') {
        e.preventDefault();
        sidebarNavIndex = Math.max(sidebarNavIndex - 1, 0);
        highlightSidebarItem();
    }
    else if (e.code === 'Enter') {
        e.preventDefault();
        if (sidebarNavIndex >= 0 && sidebarNavIndex < sidebarNavItems.length) {
            var item = sidebarNavItems[sidebarNavIndex];
            if (item.type === 'subject') {
                var subjectItem = item.element.closest('.subject-item');
                if (subjectItem) {
                    var subjectText = item.element.textContent.trim().split('\n')[0];
                    toggleSubject(subjectText);
                    buildSidebarNavList(); // Rebuild list after expansion
                    highlightSidebarItem();
                }
            } else if (item.type === 'topic') {
                item.element.click(); // Load topic
                exitSidebarNavMode();
            }
        }
    }
}

// ‚îÄ‚îÄ QOL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetAllData() {
    if (!confirm('‚ö†Ô∏è THIS WILL DELETE ALL YOUR DATA!\n\nAre you absolutely sure? Use "Export ALL Data" first to backup.')) return;
    if (!confirm('üî¥ Last chance! Delete everything?')) return;
    
    // Clear all localStorage
    localStorage.removeItem('monoFlashCardContent');
    localStorage.removeItem('monoFlashSRSData');
    localStorage.removeItem('monoFlashBookmarks');
    localStorage.removeItem('monoFlashSidebarState');
    
    // Reset variables
    cardContent = {};
    srsData = {};
    bookmarks = {};
    currentSubject = null;
    currentSub = null;
    shuffledCards = [];
    
    // Update UI
    renderSidebar();
    loadSidebarState();
    switchToHome();
    updateHomeStats();
    renderHomeSubjects();
    
    alert('‚úÖ All data cleared. Starting fresh!');
}

function downloadDatabaseJson() {
    var data = {
        cardContent: cardContent,
        srsData: srsData,
        bookmarks: bookmarks,
        exportDate: new Date().toISOString()
    };
    var ts = new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}));
    a.download = 'MonoFlash-Database-' + ts + '.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Check if onboarding is needed
if (!hasCompletedOnboarding()) {
    showOnboarding();
} else {
    // Show home by default
    switchToHome();
}

renderSidebar();
loadSidebarState();

// Initial UI state
setDot('offline');
syncHelpEl.textContent = 'Offline mode - sync loads on demand';
console.log('‚úÖ MonoFlash loaded - Cloudflare sync ready');

// ‚îÄ‚îÄ HOME SECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchToHome() {
    currentSubject = null;
    currentSub = null;
    document.getElementById('header-title').textContent = 'Home';
    
    // Hide containers when not in flashcard view
    document.getElementById('cont-selector').style.display = 'none';
    document.getElementById('progress-wrap').style.display = 'none';
    document.getElementById('progress-text').style.display = 'none';
    
    // Hide nav when in home
    document.querySelector('nav').classList.remove('show');
    
    updateHomeStats();
    renderHomeSubjects();
    
    // Switch to home tab
    document.querySelectorAll('.tab-view').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.nav-item').forEach(function(n){ n.classList.remove('active'); });
    document.getElementById('tab-home').classList.add('active');
    // Don't activate any nav item since home is not in the nav bar
    
    toggleSidebar();
}

function updateHomeStats() {
    // Count subjects, topics, and cards
    var subjects = Object.keys(cardContent);
    var subjectCount = subjects.length;
    var topicCount = 0;
    var cardCount = 0;
    
    subjects.forEach(function(subj) {
        Object.keys(cardContent[subj]).forEach(function(sub) {
            topicCount++;
            cardCount += cardContent[subj][sub].length;
        });
    });
    
    // Calculate overall accuracy from SRS data
    var totalReviewed = 0;
    var totalCorrect = 0;
    
    subjects.forEach(function(subj) {
        var topics = Object.keys(cardContent[subj] || {});
        topics.forEach(function(sub) {
            var srs = srsData[subj] && srsData[subj][sub] ? srsData[subj][sub] : [];
            srs.forEach(function(s) {
                if (s.lastReviewed) {
                    totalReviewed++;
                    if (s.interval > 0) totalCorrect++;
                }
            });
        });
    });
    
    var accuracy = totalReviewed ? Math.round(totalCorrect / totalReviewed * 100) : '-';
    
    document.getElementById('home-stat-total-subjects').textContent = subjectCount;
    document.getElementById('home-stat-total-topics').textContent = topicCount;
    document.getElementById('home-stat-total-cards').textContent = cardCount;
    document.getElementById('home-stat-accuracy').textContent = accuracy === '-' ? '-' : accuracy + '%';
}

function renderHomeSubjects() {
    var list = document.getElementById('home-subjects-list');
    var subjects = Object.keys(cardContent);
    
    if (subjects.length === 0) {
        list.innerHTML = '<div class="home-no-subjects">No subjects yet. Create one to begin!</div>';
        return;
    }
    
    list.innerHTML = '';
    subjects.forEach(function(subj) {
        var topics = cardContent[subj];
        var topicCount = Object.keys(topics).length;
        var cardCount = 0;
        
        Object.keys(topics).forEach(function(topic) {
            cardCount += topics[topic].length;
        });
        
        var item = document.createElement('div');
        item.className = 'home-subject-item';
        
        var nameDiv = document.createElement('div');
        var name = document.createElement('div');
        name.className = 'home-subject-name';
        name.textContent = subj;
        var count = document.createElement('div');
        count.style.cssText = 'color:var(--dimmer);font-size:.8rem;margin-top:2px;';
        count.textContent = topicCount + ' topic' + (topicCount !== 1 ? 's' : '') + ' ‚Ä¢ ' + cardCount + ' card' + (cardCount !== 1 ? 's' : '');
        nameDiv.appendChild(name);
        nameDiv.appendChild(count);
        
        var countBadge = document.createElement('div');
        countBadge.className = 'home-subject-count';
        countBadge.textContent = cardCount;
        
        item.appendChild(nameDiv);
        item.appendChild(countBadge);
        
        item.onclick = (function(subjName) {
            return function() {
                // Find and click the subject title element
                var subjectItems = document.querySelectorAll('.subject-title');
                for (var i = 0; i < subjectItems.length; i++) {
                    if (subjectItems[i].textContent.includes(subjName)) {
                        toggleSubject(subjName);
                        break;
                    }
                }
            };
        })(subj);
        
        list.appendChild(item);
    });
}

function createQuickStart() {
    var name = prompt('Enter Subject name (e.g., Biology):');
    if (!name || !name.trim()) return;
    
    var subject = name.trim();
    if (!cardContent[subject]) {
        cardContent[subject] = {};
        saveData();
        renderSidebar();
        loadSidebarState();
        
        var topicName = prompt('Enter Topic name for "' + subject + '" (e.g., Cell Structure):');
        if (!topicName || !topicName.trim()) return;
        
        var topic = topicName.trim();
        cardContent[subject][topic] = [];
        saveData();
        renderSidebar();
        loadSidebarState();
        updateHomeStats();
        renderHomeSubjects();
        
        // Switch to database tab for adding cards
        setTimeout(function() {
            currentSubject = subject;
            currentSub = topic;
            document.querySelectorAll('.tab-view').forEach(function(t){ t.classList.remove('active'); });
            document.querySelectorAll('.nav-item').forEach(function(n){ n.classList.remove('active'); });
            document.getElementById('tab-database').classList.add('active');
            document.querySelector('nav').classList.add('show');
            var navItems = document.querySelectorAll('.nav-item');
            if (navItems.length >= 4) navItems[3].classList.add('active'); // Database tab (4th item)
            document.getElementById('header-title').textContent = subject + ' ‚Ä∫ ' + topic;
            renderDbList();
        }, 100);
    } else {
        alert('Subject already exists!');
    }
}
</script>
</body>
</html>

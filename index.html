<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MonoFlash">
    <title>MonoFlash</title>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence }
            from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAXul0bzX2-X9qj3t51u6EjhZFFE7mi1ac",
            authDomain: "flashcards-fb9ab.firebaseapp.com",
            projectId: "flashcards-fb9ab",
            storageBucket: "flashcards-fb9ab.firebasestorage.app",
            messagingSenderId: "975345059409",
            appId: "1:975345059409:web:fb9048868da5afe6f45a70"
        };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const db  = getFirestore(app);
                
                // Optimized for iPhone 6s performance
                try {
                    await enableIndexedDbPersistence(db);
                } catch (err) {
                    console.warn("Persistence failed, continuing online only:", err.code);
                }

                window.firebaseDB     = db;
                window.firebaseDoc    = doc;
                window.firebaseSetDoc = setDoc;
                window.firebaseGetDoc = getDoc;
                window.firebaseReady  = true;
                
                const dot = document.getElementById('sync-dot');
                if (dot) dot.className = 'dot offline'; // Ready but idle
                console.log('‚úÖ Firebase ready');
            } catch (e) {
                console.error('‚ùå Firebase init failed:', e);
                window.firebaseReady = false;
                const help = document.getElementById('sync-help');
                if (help) help.textContent = "Init Error: Check Internet";
            }
        }

        // Run init
        initFirebase();
        // Export to window for manual retry
        window.retryFirebase = initFirebase;
    </script>

    <style>
        :root {
            --bg:#000; --surface:#0a0a0a; --surface-el:#121212;
            --border:#1a1a1a; --border-b:#333;
            --text:#fff; --dim:#666; --dimmer:#444; --accent:#fff;
            --ok:#2ecc71; --err:#e74c3c; --warn:#f39c12;
            --sh-sm:0 2px 8px rgba(0,0,0,.8); --sh-md:0 4px 16px rgba(0,0,0,.9);
            --sh-lg:0 8px 32px rgba(0,0,0,.95); --sh-xl:0 16px 48px rgba(0,0,0,1);
            --tf:.15s cubic-bezier(.4,0,.2,1); --tn:.3s cubic-bezier(.4,0,.2,1); --ts:.5s cubic-bezier(.4,0,.2,1);
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;}
        body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;height:100vh;height:100dvh;display:flex;overflow:hidden;-webkit-font-smoothing:antialiased;}
        body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.3;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,255,255,.01) 2px,rgba(255,255,255,.01) 4px);}

        /* SIDEBAR */
        #sidebar{width:280px;background:var(--surface);border-right:1px solid var(--border-b);display:flex;flex-direction:column;position:fixed;left:-280px;top:0;bottom:0;transition:left var(--tn),box-shadow var(--tn);z-index:1000;box-shadow:var(--sh-xl);}
        #sidebar.open{left:0;}
        .sb-head{padding:24px 20px;border-bottom:1px solid var(--border-b);background:linear-gradient(180deg,var(--surface-el) 0%,var(--surface) 100%);}
        .sb-title{font-size:1.4rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .sb-sub{font-size:.7rem;color:var(--dim);line-height:1.4;}
        .sb-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 8px;}
        .sb-content::-webkit-scrollbar{width:4px;}
        .sb-content::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:2px;}

        .subject-item{margin-bottom:8px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--surface-el);transition:all var(--tf);}
        .subject-item:hover{border-color:var(--border-b);box-shadow:var(--sh-sm);}
        .subject-title{font-weight:700;padding:14px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:.9rem;letter-spacing:1px;text-transform:uppercase;transition:all var(--tf);user-select:none;}
        .subject-title:hover{background:rgba(255,255,255,.03);}
        .subject-actions{display:flex;gap:8px;align-items:center;}
        .chevron{font-size:.7rem;transition:transform var(--tn);color:var(--dim);}
        .subject-item.expanded .chevron{transform:rotate(180deg);}
        .del-icon{font-size:1.2rem;color:var(--dimmer);transition:color var(--tf);padding:4px;cursor:pointer;}
        .del-icon:hover{color:var(--err);}
        .sub-list{border-left:2px solid var(--border-b);margin-left:12px;display:none;background:rgba(0,0,0,.3);}
        .sub-list.show{display:block;animation:slideDown var(--tn);}
        @keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:500px}}
        .sub-item{padding:12px 16px;color:var(--dim);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:.85rem;transition:all var(--tf);border-bottom:1px solid rgba(255,255,255,.02);position:relative;}
        .sub-item:last-child{border-bottom:none;}
        .sub-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--accent);transform:scaleY(0);transition:transform var(--tf);}
        .sub-item:hover,.sub-item.active{color:var(--text);background:rgba(255,255,255,.05);padding-left:20px;}
        .sub-item:hover::before,.sub-item.active::before{transform:scaleY(1);}
        .sub-item.active{background:rgba(255,255,255,.08);font-weight:600;}
        .card-count{font-size:.7rem;color:var(--dimmer);background:rgba(255,255,255,.05);padding:2px 8px;border-radius:12px;font-weight:600;min-width:32px;text-align:center;}

        /* SYNC PANEL */
        .sync-panel{padding:12px;border-top:1px solid var(--border-b);background:var(--surface-el);box-shadow:0 -4px 16px rgba(0,0,0,.5);}
        .sync-btn{width:100%;padding:12px;background:var(--surface);color:#fff;border:1px solid var(--border-b);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;font-size:.85rem;font-weight:600;letter-spacing:.5px;transition:all var(--tf);text-transform:uppercase;}
        .sync-btn:hover{background:var(--surface-el);border-color:var(--accent);box-shadow:var(--sh-sm);transform:translateY(-1px);}
        .sync-btn:active{transform:translateY(0);}

        /* Progress dot / ring */
        .dot-wrap{width:24px;height:24px;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
        .dot{width:10px;height:10px;border-radius:50%;background:var(--dim);transition:background var(--tf),box-shadow var(--tf);}
        .dot.online {background:var(--ok); box-shadow:0 0 8px var(--ok),0 0 16px rgba(46,204,113,.3);animation:dotPulse 2s infinite;}
        .dot.offline{background:var(--warn);box-shadow:0 0 8px var(--warn);}
        .dot.error  {background:var(--err); box-shadow:0 0 8px var(--err);}
        .dot.syncing{display:none;}
        @keyframes dotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.9)}}

        .pring{position:absolute;inset:0;width:24px;height:24px;display:none;}
        .pring.show{display:block;}
        .pring-track{fill:none;stroke:var(--border-b);stroke-width:2.5;}
        .pring-fill {fill:none;stroke:var(--accent);stroke-width:2.5;stroke-linecap:round;transform-origin:center;transform:rotate(-90deg);transition:stroke-dashoffset .35s ease;}

        .device-id{font-size:.65rem;color:var(--dimmer);margin-top:8px;text-align:center;font-family:monospace;padding:6px;background:rgba(0,0,0,.3);border-radius:4px;word-break:break-all;}
        .sync-help{font-size:.65rem;color:var(--dimmer);text-align:center;margin-top:6px;line-height:1.3;}
        
        .add-btn{padding:12px;border:1px dashed var(--border-b);text-align:center;margin:8px 8px 12px;cursor:pointer;color:var(--dim);border-radius:8px;font-size:.85rem;font-weight:600;letter-spacing:.5px;transition:all var(--tf);text-transform:uppercase;}
        .add-btn:hover{color:var(--text);border-color:var(--accent);background:rgba(255,255,255,.03);}

        /* MAIN */
        #main{flex:1;display:flex;flex-direction:column;position:relative;width:100%;}
        header{padding:16px 20px;border-bottom:1px solid var(--border-b);display:flex;align-items:center;gap:16px;background:var(--surface);box-shadow:var(--sh-md);position:relative;z-index:10;}
        .menu-btn{font-size:1.5rem;cursor:pointer;color:var(--text);transition:all var(--tf);padding:8px;margin:-8px;user-select:none;}
        .menu-btn:hover{transform:scale(1.1);}
        .menu-btn:active{transform:scale(.95);}
        #header-title{font-size:1rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        #content-area{flex:1;overflow-y:auto;overflow-x:hidden;padding:20px;position:relative;}
        #content-area::-webkit-scrollbar{width:6px;}
        #content-area::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:3px;}
        .tab-view{display:none;height:100%;animation:fadeIn var(--tn);}
        .tab-view.active{display:flex;flex-direction:column;}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}

        /* FLASHCARD */
        .card-container{flex:1;display:flex;justify-content:center;align-items:center;perspective:1600px;padding:20px 0;}
        .card{width:100%;max-width:380px;height:280px;position:relative;transform-style:preserve-3d;transition:transform var(--ts),box-shadow var(--tn);cursor:pointer;box-shadow:var(--sh-lg);}
        .card:hover{box-shadow:var(--sh-xl);}
        .card.flipped{transform:rotateY(180deg);}
        .card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;justify-content:center;align-items:center;text-align:center;border:2px solid var(--border-b);border-radius:16px;background:var(--surface-el);padding:32px 24px;font-size:1.3rem;font-weight:500;line-height:1.5;box-shadow:inset 0 2px 8px rgba(0,0,0,.5);overflow-y:auto;}
        .card-face::-webkit-scrollbar{width:4px;}
        .card-face::-webkit-scrollbar-thumb{background:var(--border-b);border-radius:2px;}
        .card-back{transform:rotateY(180deg);background:#050505;border-color:var(--accent);box-shadow:inset 0 2px 8px rgba(0,0,0,.8),0 0 24px rgba(255,255,255,.1);}
        .controls{display:flex;gap:12px;justify-content:center;margin-top:24px;padding:0 20px;}
        .btn{padding:14px 28px;border-radius:10px;border:1px solid var(--border-b);background:var(--surface);color:#fff;cursor:pointer;transition:all var(--tf);font-size:.95rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;box-shadow:var(--sh-sm);user-select:none;}
        .btn:hover{transform:translateY(-2px);background:var(--surface-el);box-shadow:var(--sh-md);border-color:var(--accent);}
        .btn:active{transform:translateY(0);}
        .btn-primary{background:linear-gradient(135deg,#fff 0%,#ccc 100%);color:#000;border:none;box-shadow:var(--sh-md);}
        .btn-primary:hover{background:linear-gradient(135deg,#f5f5f5 0%,#bbb 100%);box-shadow:var(--sh-lg);}
        :focus-visible{outline:2px solid var(--accent);outline-offset:4px;}

        /* NAV */
        nav{display:flex;border-top:1px solid var(--border-b);padding-bottom:env(safe-area-inset-bottom);background:var(--surface);box-shadow:0 -4px 16px rgba(0,0,0,.5);position:relative;z-index:10;}
        .nav-item{flex:1;padding:16px 12px;text-align:center;color:var(--dim);cursor:pointer;font-size:.8rem;font-weight:700;letter-spacing:1px;transition:all var(--tf);text-transform:uppercase;user-select:none;position:relative;}
        .nav-item::before{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%) scaleX(0);width:60%;height:2px;background:var(--accent);transition:transform var(--tn);}
        .nav-item:hover{color:var(--text);background:rgba(255,255,255,.03);}
        .nav-item.active{color:#fff;background:rgba(255,255,255,.05);}
        .nav-item.active::before{transform:translateX(-50%) scaleX(1);}

        #overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(4px);z-index:900;display:none;}
        #overlay.show{display:block;animation:fadeIn var(--tn);}

        @media(max-width:480px){
            #sidebar{width:260px;left:-260px;}
            .card{max-width:100%;height:240px;}
            .card-face{font-size:1.1rem;padding:24px 20px;}
            .controls{gap:10px;margin-top:16px;padding:0 12px;}
            .btn{flex:1;padding:12px 20px;font-size:.8rem;max-width:160px;}
            nav{padding-bottom:max(env(safe-area-inset-bottom),8px);}
            .nav-item{padding:14px 8px;font-size:.7rem;}
        }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleSidebar()"></div>

<aside id="sidebar">
    <div class="sb-head">
        <div class="sb-title">MonoFlash</div>
        <div class="sb-sub">üì¶ Cards sync manual<br>üìä Progress stays local</div>
    </div>
    <div class="sb-content" id="subject-list"></div>
    <div class="add-btn" onclick="addNewSubject()">+ Add Subject</div>
    <div class="sync-panel">
        <button class="sync-btn" onclick="manualSync()">
            <div class="dot-wrap">
                <div class="dot" id="sync-dot"></div>
                <svg class="pring" id="pring" viewBox="0 0 24 24">
                    <circle class="pring-track" cx="12" cy="12" r="9"/>
                    <circle class="pring-fill" cx="12" cy="12" r="9" id="pring-fill"
                        stroke-dasharray="56.55" stroke-dashoffset="56.55"/>
                </svg>
            </div>
            <span id="sync-text">Push to Cloud</span>
        </button>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
            <button class="sync-btn" style="margin-bottom:0;flex:1;" onclick="readDatabase()">
                <span id="read-text">üìñ Read Database</span>
            </button>
            <button class="sync-btn" style="margin-bottom:0;width:48px;flex:none;font-size:1.2rem;padding:12px 0;" onclick="changeSyncId()" title="Change Device ID">üîó</button>
        </div>
        <div class="device-id">ID: <span id="current-device-id">‚Ä¶</span></div>
        <div class="sync-help" id="sync-help" onclick="window.retryFirebase()">Offline mode (Tap to retry)</div>
    </div>
</aside>

<main id="main">
    <header>
        <div class="menu-btn" onclick="toggleSidebar()">‚ò∞</div>
        <h1 id="header-title">Select a Subject</h1>
    </header>
    <section id="content-area">
        <div id="tab-flashcard" class="tab-view active">
            <div class="cont-selector" id="cont-selector" style="display:none;"></div>
            <div class="card-container">
                <div class="card" onclick="flipCard()" id="active-card">
                    <div class="card-face" id="card-front">Select a topic to begin</div>
                    <div class="card-face card-back" id="card-back">Your journey starts here</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn" onclick="nextCard(false)">Missed</button>
                <button class="btn btn-primary" onclick="nextCard(true)">Got it</button>
            </div>
        </div>

        <!-- Placeholder for other tabs (Data and Stats) code from previous version remains compatible -->
    </section>
    <nav>
        <div class="nav-item active" onclick="switchTab('flashcard',this)">Cards</div>
        <div class="nav-item" onclick="switchTab('performance',this)">Stats</div>
        <div class="nav-item" onclick="switchTab('database',this)">Data</div>
    </nav>
</main>

<script>
// Logic remains identical to your working version but with added robustness for iOS Safari/WebClips
function getDeviceId() {
    let id = localStorage.getItem('monoFlashDeviceId');
    if (!id) { id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); localStorage.setItem('monoFlashDeviceId', id); }
    return id;
}
var DEVICE_ID = getDeviceId();
document.getElementById('current-device-id').textContent = DEVICE_ID;

var CIRC = 2 * Math.PI * 9;
var dotEl      = document.getElementById('sync-dot');
var pringEl    = document.getElementById('pring');
var pringFill  = document.getElementById('pring-fill');
var syncTextEl = document.getElementById('sync-text');
var syncHelpEl = document.getElementById('sync-help');

function setDot(state) {
    if(!dotEl) return;
    dotEl.className = 'dot ' + state;
    if (state === 'syncing') { pringEl.classList.add('show'); } else { pringEl.classList.remove('show'); }
}
function setRing(pct) {
    if(!pringFill) return;
    pringFill.style.strokeDashoffset = CIRC * (1 - pct / 100);
}

var cardContent = JSON.parse(localStorage.getItem('monoFlashCardContent') || '{}');
var srsData     = JSON.parse(localStorage.getItem('monoFlashSRSData')     || '{}');
var currentSubject = null, currentSub = null;
var cardIndex = 0;
var shuffledCards = [];

function saveLocal() {
    localStorage.setItem('monoFlashCardContent', JSON.stringify(cardContent));
    localStorage.setItem('monoFlashSRSData',     JSON.stringify(srsData));
}

async function readDatabase() {
    if (!window.firebaseReady) {
        syncHelpEl.textContent = "Attempting Reconnect...";
        await window.retryFirebase(); 
        if(!window.firebaseReady) {
            alert('Cloud unavailable. Check Banglalink signal or Wi-Fi.');
            return;
        }
    }
    
    var btn = document.getElementById('read-text');
    btn.textContent = '‚è≥ Syncing...';
    setDot('syncing'); setRing(20);

    try {
        var docRef = window.firebaseDoc(window.firebaseDB, 'flashcards', DEVICE_ID);
        var snap = await window.firebaseGetDoc(docRef);
        setRing(70);

        if (snap.exists()) {
            var cloud = snap.data();
            cardContent = cloud.cardContent || {};
            saveLocal();
            renderSidebar();
            btn.textContent = '‚úÖ Updated';
            syncHelpEl.textContent = 'Cloud data pulled.';
            setRing(100); setDot('online');
        } else {
            syncHelpEl.textContent = 'Cloud is empty for this ID.';
            btn.textContent = '‚ùì Empty';
            setDot('offline');
        }
    } catch(err) {
        console.error('Read error:', err);
        syncHelpEl.textContent = 'Network Error: ' + err.code;
        setDot('error');
    }

    setTimeout(function() { 
        btn.textContent = 'üìñ Read Database'; 
        setDot('offline');
    }, 2000);
}

function manualSync() {
    if (!window.firebaseReady) { alert("Offline. Try tapping the help text below to reconnect."); return; }
    setDot('syncing'); setRing(20);
    var docRef = window.firebaseDoc(window.firebaseDB, 'flashcards', DEVICE_ID);
    window.firebaseSetDoc(docRef, { cardContent: cardContent, lastSync: Date.now(), deviceId: DEVICE_ID }, { merge: true })
    .then(() => { setRing(100); setDot('online'); setTimeout(()=>setDot('offline'),2000); })
    .catch(e => { setDot('error'); syncHelpEl.textContent = "Upload Error"; });
}

function renderSidebar() {
    var list = document.getElementById('subject-list');
    list.innerHTML = '';
    for (var subj in cardContent) {
        let s = subj;
        var item = document.createElement('div'); item.className = 'subject-item';
        item.innerHTML = `<div class="subject-title" onclick="toggleSubject('${s}')"><span>${s}</span><span class="chevron">‚ñº</span></div>`;
        var subList = document.createElement('div'); subList.className = 'sub-list';
        subList.id = 'sub-' + s.replace(/\s+/g, '-');
        for (var sub in cardContent[s]) {
            let topic = sub;
            var si = document.createElement('div'); si.className = 'sub-item';
            si.innerHTML = `<span>${topic}</span>`;
            si.onclick = () => loadTopic(s, topic);
            subList.appendChild(si);
        }
        item.appendChild(subList);
        list.appendChild(item);
    }
}

function toggleSubject(s) {
    document.getElementById('sub-'+s.replace(/\s+/g, '-')).classList.toggle('show');
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show');
}

function loadTopic(subj, sub) {
    currentSubject = subj; currentSub = sub;
    document.getElementById('header-title').textContent = sub;
    shuffledCards = cardContent[subj][sub] || [];
    cardIndex = 0;
    renderCard();
    toggleSidebar();
}

function renderCard() {
    var f = document.getElementById('card-front'), b = document.getElementById('card-back');
    if(!shuffledCards.length) { f.textContent = "No cards"; return; }
    f.textContent = shuffledCards[cardIndex].q;
    b.textContent = shuffledCards[cardIndex].a;
}

function flipCard() { document.getElementById('active-card').classList.toggle('flipped'); }

function nextCard(correct) {
    cardIndex = (cardIndex + 1) % shuffledCards.length;
    renderCard();
    document.getElementById('active-card').classList.remove('flipped');
}

function switchTab(t, el) { alert("Tabs for Stats/Data would go here as in previous version."); }

renderSidebar();
</script>
</body>
</html>
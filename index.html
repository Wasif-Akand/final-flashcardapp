<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MonoFlash</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAXul0bzX2-X9qj3t51u6EjhZFFE7mi1ac",
            authDomain: "flashcards-fb9ab.firebaseapp.com",
            projectId: "flashcards-fb9ab",
            storageBucket: "flashcards-fb9ab.firebasestorage.app",
            messagingSenderId: "975345059409",
            appId: "1:975345059409:web:fb9048868da5afe6f45a70"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
    </script>
    
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg: #000000;
            --surface: #111111;
            --border: #333333;
            --text: #ffffff;
            --text-dim: #888888;
            --accent: #ffffff;
            --success: #4caf50;
            --error: #f44336;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- SIDEBAR (DRAWER) --- */
        #sidebar {
            width: 280px; background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            position: absolute; left: -280px; top: 0; bottom: 0;
            transition: left 0.3s ease; z-index: 1000;
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            font-weight: bold;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sidebar-header-title { font-size: 1.1rem; }
        .sidebar-subtitle { 
            font-size: 0.7rem; 
            color: var(--text-dim); 
            font-weight: normal;
        }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .subject-item { margin-bottom: 10px; }
        .subject-title { font-weight: bold; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .sub-subject-list { margin-left: 15px; border-left: 1px solid var(--border); display: none; }
        .sub-subject-list.show { display: block; }
        .sub-item { padding: 10px; color: var(--text-dim); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .sub-item:hover, .sub-item.active { color: var(--text); background: #222; }
        .card-count { font-size: 0.75rem; color: var(--text-dim); margin-left: 8px; }

        .sync-btn-container { padding: 10px; border-top: 1px solid var(--border); background: #0a0a0a; }
        .sync-btn {
            width: 100%; padding: 10px; background: #222; color: white; border: 1px solid var(--border);
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 6px;
        }
        .sync-btn:hover { background: #2a2a2a; }
        .sync-status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-dim); }
        .sync-status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); animation: pulse 2s infinite; }
        .sync-status-dot.error { background: var(--error); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .add-btn { padding: 10px; border: 1px dashed var(--border); text-align: center; margin-top: 10px; cursor: pointer; color: var(--text-dim); }

        /* --- MAIN CONTENT --- */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; transition: opacity 0.3s; }
        
        /* Header */
        header { 
            padding: 15px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 15px; 
        }
        .menu-btn { font-size: 1.5rem; cursor: pointer; }

        /* Content Area */
        #content-area { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        
        /* --- TABS (Flashcard / Perf / DB) --- */
        .tab-view { display: none; height: 100%; }
        .tab-view.active { display: flex; flex-direction: column; }

        /* FLASHCARD STYLES */
        .flashcard-container { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 1400px; }
        .card {
            width: 100%; max-width: 420px; height: 320px;
            position: relative; transform-style: preserve-3d; transition: transform 0.6s, box-shadow 0.2s;
            cursor: pointer; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        .card.flipped { transform: rotateY(180deg); box-shadow: 0 18px 40px rgba(0,0,0,0.6); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center; text-align: center;
            border: 2px solid var(--border); border-radius: 15px; background: var(--surface);
            padding: 20px; font-size: 1.5rem;
        }
        .card-back { transform: rotateY(180deg); background: #000; border-color: #fff; }

        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn { padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: white; cursor: pointer; transition: transform 0.12s, filter 0.12s; }
        .btn:hover { transform: translateY(-2px); background: #1a1a1a; }
        .btn:active { transform: translateY(0); }
        .btn-primary { background: white; color: black; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .btn-primary:hover { filter: brightness(0.96); }

        /* Visible focus ring for keyboard users */
        :focus-visible { outline: 3px solid #4D90FE; outline-offset: 3px; border-radius: 8px; }

        /* DATABASE STYLES */
        textarea { width: 100%; height: 100px; background: #070707; color: #fff; border: 1px solid var(--border); padding: 10px; margin-bottom: 10px; border-radius: 6px; font-family: inherit; }
        .db-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .db-key { font-weight: bold; }

        /* PERFORMANCE STYLES */
        .stat-box { border: 1px solid var(--border); padding: 20px; margin-bottom: 10px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 2rem; font-weight: bold; }
        .container-stat { border: 1px solid var(--border); padding: 15px; margin-bottom: 8px; border-radius: 6px; }
        .container-stat-header { font-weight: bold; margin-bottom: 8px; }
        .container-stat-detail { color: var(--text-dim); font-size: 0.9rem; }

        /* CONTAINER SELECTOR */
        .container-selector { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; }
        .container-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); color: var(--text-dim); cursor: pointer; font-size: 0.8rem; transition: all 0.2s; white-space: nowrap; }
        .container-btn:hover { background: #1a1a1a; color: var(--text); }
        .container-btn.active { background: white; color: black; border-color: white; font-weight: bold; }
        .container-info { font-size: 0.75rem; color: var(--text-dim); margin-top: 6px; width: 100%; }

        /* --- BOTTOM NAV --- */
        nav { display: flex; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); background: var(--bg); }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: var(--text-dim); cursor: pointer; font-size: 0.9rem; border-top: 2px solid transparent; }
        .nav-item.active { color: white; border-top-color: white; }

        /* Overlay for sidebar */
        #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 900; display: none; }
        #overlay.show { display: block; }

        /* Responsive tweaks */
        @media (max-width: 480px) {
            .card { max-width: 300px; height: 220px; font-size: 1rem; }
            #sidebar { width: 240px; left: -240px; }
            
            /* Container selector - much more compact */
            .container-selector { padding: 5px; gap: 4px; margin-bottom: 8px; }
            .container-btn { padding: 5px 8px; font-size: 0.7rem; min-width: auto; }
            .container-info { font-size: 0.65rem; margin-top: 4px; }
            
            /* Flashcard controls - more spacing */
            .controls { gap: 15px; margin-top: 15px; padding: 0 10px; }
            .btn { padding: 10px 20px; font-size: 0.9rem; flex: 1; max-width: 150px; }
            
            /* Flashcard container - less height to fit controls */
            .flashcard-container { flex: 0.8; }
        }

    </style>
</head>
<body>

    <div id="overlay" onclick="toggleSidebar()"></div>
    <aside id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-title">SUBJECTS</div>
            <div class="sidebar-subtitle">ðŸ“¦ Cards sync â€¢ ðŸ“Š Progress stays local</div>
        </div>
        <div class="sidebar-content" id="subject-list">
            <!-- Subjects load here -->
        </div>
        
        <div class="add-btn" onclick="addNewSubject()">+ Add Subject</div>
        
        <!-- SYNC SETTINGS -->
        <div class="sync-btn-container">
            <button class="sync-btn" onclick="manualSync()">
                <div class="sync-status-dot" id="sync-dot"></div>
                <span id="sync-text">Sync Cards</span>
            </button>
            <button class="sync-btn" onclick="changeSyncId()">
                <span>ðŸ”— Link Device</span>
            </button>
            <div style="font-size:0.65rem; color:#666; margin-top:5px; text-align:center; font-family: monospace;">
                ID: <span id="current-device-id">...</span>
            </div>
        </div>
    </aside>

    <main id="main">
        <header>
            <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
            <h1 id="header-title" style="font-size: 1.2rem; margin:0;">Select a Subject</h1>
        </header>

        <section id="content-area">
            
            <div id="tab-flashcard" class="tab-view active">
                <!-- Container Selector (includes Review Missed button) -->
                <div class="container-selector" id="container-selector" style="display: none;">
                    <!-- Buttons will be added here dynamically -->
                </div>
                
                <div class="flashcard-container">
                    <div class="card" onclick="flipCard()" id="active-card">
                        <div class="card-face card-front" id="card-front">Select a sub-subject</div>
                        <div class="card-face card-back" id="card-back">...to start</div>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn" onclick="nextCard(false)">Missed</button>
                    <button class="btn btn-primary" onclick="nextCard(true)">Got it</button>
                </div>
            </div>

            <div id="tab-performance" class="tab-view">
                <div class="stat-box">
                    <div class="stat-num" id="stat-total">0</div>
                    <div>Cards Reviewed (This Session)</div>
                </div>
                <div class="stat-box" style="border-color: #fff;">
                    <div class="stat-num" id="stat-score">0%</div>
                    <div>Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="stat-due">-</div>
                    <div>Cards Due Today</div>
                </div>
                <div class="stat-box">
                    <div class="stat-num" id="stat-mastered">-</div>
                    <div>Cards Mastered (7+ days)</div>
                </div>
                
                <!-- Container-specific stats -->
                <div id="container-stats" style="margin-top: 20px;">
                    <!-- Container stats will be added here dynamically -->
                </div>
            </div>

            <div id="tab-database" class="tab-view">
                <h3>Add Data</h3>
                <p style="color:#666; font-size: 0.8rem;">Format: Question -!- Answer (one per line) OR JSON: [{"q":"Front", "a":"Back"}]</p>
                <textarea id="json-input" placeholder='What is gravity? -!- Force that attracts objects
What is speed? -!- Distance over time'></textarea>
                <!-- file input for direct JSON import -->
                <input id="file-input" type="file" accept="application/json,.json" style="display:none" onchange="importJsonFile(event)">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" style="flex:1" onclick="importJson()" aria-label="Import JSON">Import Data</button>
                    <button class="btn" style="width:160px" onclick="exportJson()" aria-label="Export JSON">Export JSON</button>
                    <button class="btn" style="width:170px" onclick="document.getElementById('file-input').click()" aria-label="Import JSON file">Import from file</button>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 30px;">
                    <h3 style="margin: 0;">Current Entries</h3>
                    <button class="btn" onclick="clearAllCards()" style="padding: 8px 16px; font-size: 0.9rem;">Clear All</button>
                </div>
                <div id="db-list"></div>
            </div>

        </section>

        <nav>
            <div class="nav-item active" onclick="switchTab('flashcard', this)">FLASHCARDS</div>
            <div class="nav-item" onclick="switchTab('performance', this)">STATS</div>
            <div class="nav-item" onclick="switchTab('database', this)">DATA</div>
        </nav>
    </main>

    <script>
        // ==================== DEVICE ID & FIREBASE SYNC ====================
        
        console.log('ðŸŽ‰ MonoFlash initialized!');
        console.log('ðŸ“¦ Card content syncs to Firebase');
        console.log('ðŸ“Š SRS progress stays local');
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('monoFlashDeviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('monoFlashDeviceId', deviceId);
            }
            return deviceId;
        }
        
        const DEVICE_ID = getDeviceId();
        console.log('ðŸ”‘ Device ID:', DEVICE_ID);
        document.getElementById('current-device-id').textContent = DEVICE_ID;
        
        function changeSyncId() {
            const newId = prompt("Enter a Sync Name (e.g. 'my-flashcards').\n\nIMPORTANT: Use the EXACT same name on your other devices to sync data.", DEVICE_ID);
            if (newId && newId.trim() !== "") {
                const cleanId = newId.trim();
                localStorage.setItem('monoFlashDeviceId', cleanId);
                alert("Device Linked! The page will reload to sync data.");
                location.reload();
            }
        }

        let syncInProgress = false;
        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');
        
        // ==================== DATA STRUCTURE ====================
        // OPTIMIZATION: Separate card content (synced) from SRS progress (local)
        
        let cardContent = JSON.parse(localStorage.getItem('monoFlashCardContent')) || {};
        let srsData = JSON.parse(localStorage.getItem('monoFlashSRSData')) || {};
        
        let currentSubject = null;
        let currentSub = null;
        let cardIndex = 0;
        let sessionStats = { total: 0, correct: 0 };
        let shuffledCards = [];
        let dueCards = [];
        
        // --- CONTAINER & REVIEW MISSED FEATURES ---
        const CARDS_PER_CONTAINER = 20;
        let currentContainer = 'all';
        let reviewMissedMode = false;
        let missedCardsThisSession = new Set();

        // ==================== SRS FUNCTIONS ====================
        
        function createDefaultSRS() {
            return {
                interval: 0,
                easiness: 2.5,
                repetitions: 0,
                nextReview: Date.now(),
                lastReviewed: null
            };
        }

        function initializeSRS(srsObj) {
            if (!srsObj || typeof srsObj !== 'object') {
                return createDefaultSRS();
            }
            if (!srsObj.interval) srsObj.interval = 0;
            if (!srsObj.easiness) srsObj.easiness = 2.5;
            if (!srsObj.repetitions) srsObj.repetitions = 0;
            if (!srsObj.nextReview) srsObj.nextReview = Date.now();
            return srsObj;
        }

        function updateSRS(srsObj, quality) {
            const now = Date.now();
            srsObj.lastReviewed = now;
            
            if (quality === 0) {
                srsObj.repetitions = 0;
                srsObj.interval = 1;
            } else {
                srsObj.repetitions += 1;
                
                if (srsObj.repetitions === 1) {
                    srsObj.interval = 1;
                } else if (srsObj.repetitions === 2) {
                    srsObj.interval = 6;
                } else {
                    srsObj.interval = Math.round(srsObj.interval * srsObj.easiness);
                }
                
                srsObj.easiness = Math.max(1.3, srsObj.easiness + (0.1 - (1 - quality) * 0.2));
            }
            
            srsObj.nextReview = now + (srsObj.interval * 24 * 60 * 60 * 1000);
            return srsObj;
        }

        function isDue(srsObj) {
            if (!srsObj || !srsObj.nextReview) return true;
            return Date.now() >= srsObj.nextReview;
        }

        // ==================== DATA MANAGEMENT ====================
        
        function ensureSRSDataExists() {
            for (let subject in cardContent) {
                if (!srsData[subject]) srsData[subject] = {};
                
                for (let sub in cardContent[subject]) {
                    if (!srsData[subject][sub]) srsData[subject][sub] = [];
                    
                    const cardCount = cardContent[subject][sub].length;
                    const srsCount = srsData[subject][sub].length;
                    
                    if (srsCount < cardCount) {
                        for (let i = srsCount; i < cardCount; i++) {
                            srsData[subject][sub].push(createDefaultSRS());
                        }
                    }
                }
            }
        }

        function saveData() {
            ensureSRSDataExists();
            localStorage.setItem('monoFlashCardContent', JSON.stringify(cardContent));
            localStorage.setItem('monoFlashSRSData', JSON.stringify(srsData));
        }

        // ==================== FIREBASE SYNC ====================
        
        async function syncToCloud() {
            if (syncInProgress || !window.firebaseDB) return;
            
            try {
                syncInProgress = true;
                syncDot.className = 'sync-status-dot';
                syncText.textContent = "Syncing...";
                
                const docRef = window.firebaseDoc(window.firebaseDB, 'flashcards', DEVICE_ID);
                await window.firebaseSetDoc(docRef, {
                    cardContent: cardContent,
                    lastSync: Date.now(),
                    deviceId: DEVICE_ID
                });
                
                console.log('âœ… Synced card content to cloud');
                syncDot.className = 'sync-status-dot online';
                syncText.textContent = "Synced âœ“";
                
                setTimeout(() => {
                    if (syncText.textContent === "Synced âœ“") {
                        syncText.textContent = "Sync Cards";
                    }
                }, 2000);
            } catch (error) {
                console.error('âŒ Sync error:', error);
                syncDot.className = 'sync-status-dot error';
                syncText.textContent = "Sync Failed";
                
                if (error.code === 'permission-denied') {
                    alert("Sync Failed: Permission Denied.\n\nPlease check your Firebase Console > Firestore Database > Rules.");
                }
                
                setTimeout(() => {
                    syncText.textContent = "Sync Cards";
                }, 3000);
            } finally {
                syncInProgress = false;
            }
        }
        
        async function loadFromCloud() {
            if (!window.firebaseDB) {
                console.log('Firebase not ready, using localStorage');
                return;
            }
            
            try {
                const docRef = window.firebaseDoc(window.firebaseDB, 'flashcards', DEVICE_ID);
                const docSnap = await window.firebaseGetDoc(docRef);
                
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    
                    if (cloudData.cardContent) {
                        const localTimestamp = JSON.parse(localStorage.getItem('monoFlashCardContent_timestamp') || '0');
                        const cloudTimestamp = cloudData.lastSync || 0;
                        
                        if (cloudTimestamp > localTimestamp) {
                            cardContent = cloudData.cardContent;
                            localStorage.setItem('monoFlashCardContent', JSON.stringify(cardContent));
                            localStorage.setItem('monoFlashCardContent_timestamp', JSON.stringify(cloudTimestamp));
                            console.log('ðŸ“¥ Loaded newer card content from cloud');
                        } else {
                            console.log('ðŸ“¦ Local card content is up to date');
                        }
                    }
                    
                    ensureSRSDataExists();
                    saveData();
                    renderSidebar();
                    
                    syncDot.className = 'sync-status-dot online';
                } else {
                    console.log('No cloud data found, will sync local data');
                    syncToCloud();
                }
            } catch (error) {
                console.error('Error loading from cloud:', error);
                syncDot.className = 'sync-status-dot error';
            }
        }

        function manualSync() {
            syncToCloud();
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function safeId(name) {
            return String(name || '').trim().toLowerCase().replace(/[^a-z0-9_-]+/g, '-');
        }

        function isValidCardArray(arr) {
            if (!Array.isArray(arr)) return false;
            return arr.every(c => c && typeof c === 'object' && typeof c.q === 'string' && typeof c.a === 'string');
        }

        function parseTextFormat(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const cards = [];
            for (let line of lines) {
                if (line.includes('-!-')) {
                    const parts = line.split('-!-');
                    if (parts.length >= 2) {
                        const q = parts[0].trim();
                        const a = parts.slice(1).join('-!-').trim();
                        if (q && a) {
                            cards.push({q, a});
                        }
                    }
                }
            }
            return cards;
        }

        // ==================== SIDEBAR FUNCTIONS ====================
        
        function renderSidebar() {
            const list = document.getElementById('subject-list');
            list.innerHTML = '';
            
            for (let subject in cardContent) {
                const item = document.createElement('div');
                item.className = 'subject-item';
                
                const title = document.createElement('div');
                title.className = 'subject-title';
                
                const titleText = document.createElement('span');
                titleText.textContent = subject;
                titleText.onclick = () => toggleSubject(subject);
                title.appendChild(titleText);
                
                const deleteBtn = document.createElement('span');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.fontSize = '1.5rem';
                deleteBtn.style.color = '#666';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteSubject(subject);
                };
                title.appendChild(deleteBtn);
                
                item.appendChild(title);
                
                const subList = document.createElement('div');
                subList.className = 'sub-subject-list';
                subList.id = 'sub-' + safeId(subject);
                
                for (let sub in cardContent[subject]) {
                    const subItem = document.createElement('div');
                    subItem.className = 'sub-item';
                    
                    const cardCount = cardContent[subject][sub].length;
                    
                    const subText = document.createElement('span');
                    subText.innerHTML = `${sub} <span class="card-count">${cardCount}</span>`;
                    subText.onclick = () => loadTopic(subject, sub);
                    subItem.appendChild(subText);
                    
                    const subDeleteBtn = document.createElement('span');
                    subDeleteBtn.textContent = 'Ã—';
                    subDeleteBtn.style.cursor = 'pointer';
                    subDeleteBtn.style.fontSize = '1.2rem';
                    subDeleteBtn.style.color = '#666';
                    subDeleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSub(subject, sub);
                    };
                    subItem.appendChild(subDeleteBtn);
                    
                    subList.appendChild(subItem);
                }
                
                const addSubBtn = document.createElement('div');
                addSubBtn.className = 'add-btn';
                addSubBtn.textContent = '+ Add Topic';
                addSubBtn.style.margin = '5px 0';
                addSubBtn.onclick = () => addNewSub(subject);
                subList.appendChild(addSubBtn);
                
                item.appendChild(subList);
                list.appendChild(item);
            }
        }

        function toggleSubject(subject) {
            const subList = document.getElementById('sub-' + safeId(subject));
            if (subList) {
                subList.classList.toggle('show');
                saveSidebarState();
            }
        }

        function saveSidebarState() {
            const openSubjects = [];
            document.querySelectorAll('.sub-subject-list.show').forEach(el => {
                const id = el.id.replace('sub-', '');
                openSubjects.push(id);
            });
            localStorage.setItem('monoFlashSidebarState', JSON.stringify(openSubjects));
        }

        function loadSidebarState() {
            const saved = localStorage.getItem('monoFlashSidebarState');
            if (saved) {
                try {
                    const openSubjects = JSON.parse(saved);
                    openSubjects.forEach(id => {
                        const el = document.getElementById('sub-' + id);
                        if (el) el.classList.add('show');
                    });
                } catch (e) {
                    console.error('Error loading sidebar state:', e);
                }
            }
        }

        function addNewSubject() {
            const name = prompt("Enter new Subject name:");
            if (name && name.trim() !== "") {
                const trimmed = name.trim();
                if (!cardContent[trimmed]) {
                    cardContent[trimmed] = {};
                    saveData();
                    syncToCloud();
                    renderSidebar();
                    loadSidebarState();
                }
            }
        }

        function addNewSub(subject) {
            const name = prompt("Enter new Topic name for " + subject + ":");
            if (name && name.trim() !== "") {
                const trimmed = name.trim();
                if (!cardContent[subject][trimmed]) {
                    cardContent[subject][trimmed] = [];
                    saveData();
                    syncToCloud();
                    renderSidebar();
                    loadSidebarState();
                }
            }
        }

        function deleteSubject(subject) {
            if (confirm("Delete entire subject '" + subject + "'? This will delete all topics and cards inside it.")) {
                delete cardContent[subject];
                delete srsData[subject];
                if (currentSubject === subject) {
                    currentSubject = null;
                    currentSub = null;
                    document.getElementById('header-title').textContent = 'Select a Subject';
                    renderCard();
                }
                saveData();
                syncToCloud();
                renderSidebar();
                renderDbList();
            }
        }

        function deleteSub(subject, sub) {
            if (confirm("Delete topic '" + sub + "' and all its cards?")) {
                delete cardContent[subject][sub];
                if (srsData[subject]) delete srsData[subject][sub];
                if (currentSubject === subject && currentSub === sub) {
                    currentSub = null;
                    document.getElementById('header-title').textContent = subject;
                    renderCard();
                }
                saveData();
                syncToCloud();
                renderSidebar();
                renderDbList();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        }

        // ==================== FLASHCARD FUNCTIONS ====================
        
        function loadTopic(subject, sub) {
            currentSubject = subject;
            currentSub = sub;
            currentContainer = 'all';
            reviewMissedMode = false;
            missedCardsThisSession.clear();
            cardIndex = 0;
            sessionStats = { total: 0, correct: 0 };
            
            document.getElementById('header-title').textContent = subject + " > " + sub;
            
            ensureSRSDataExists();
            
            if (cardContent[subject] && cardContent[subject][sub]) {
                const cards = cardContent[subject][sub];
                const srs = srsData[subject][sub];
                
                const cardsWithSRS = cards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[i],
                    _index: i
                }));
                
                dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
            } else {
                shuffledCards = [];
            }
            
            renderCard();
            updateStats();
            renderDbList();
            renderContainerSelector();
            
            document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.sub-item')?.classList.add('active');
            
            toggleSidebar();
        }

        function renderCard() {
            const front = document.getElementById('card-front');
            const back = document.getElementById('card-back');
            const card = document.getElementById('active-card');
            
            card.classList.remove('flipped');
            
            if (shuffledCards.length === 0 || cardIndex >= shuffledCards.length) {
                front.textContent = currentSubject && currentSub ? "No cards available" : "Select a sub-subject";
                back.textContent = currentSubject && currentSub ? "Add some cards!" : "...to start";
                return;
            }
            
            const current = shuffledCards[cardIndex];
            front.textContent = current.q;
            back.textContent = current.a;
        }

        function flipCard() {
            if (shuffledCards.length === 0 || cardIndex >= shuffledCards.length) return;
            document.getElementById('active-card').classList.toggle('flipped');
        }

        function nextCard(isCorrect) {
            if (!currentSubject || !currentSub || shuffledCards.length === 0 || cardIndex >= shuffledCards.length) return;
            
            const current = shuffledCards[cardIndex];
            const originalIndex = current._index;
            
            updateSRS(current.srs, isCorrect ? 1 : 0);
            
            if (!isCorrect) {
                missedCardsThisSession.add(originalIndex);
            }
            
            saveData();
            
            sessionStats.total++;
            if (isCorrect) sessionStats.correct++;
            updateStats();
            renderContainerSelector();
            
            cardIndex++;
            renderCard();
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = sessionStats.total;
            const percentage = sessionStats.total === 0 ? 0 : Math.round((sessionStats.correct / sessionStats.total) * 100);
            document.getElementById('stat-score').innerText = percentage + "%";
            
            if (currentSubject && currentSub && cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                const cards = cardContent[currentSubject][currentSub];
                const srs = srsData[currentSubject][currentSub];
                
                const dueCount = srs.filter(s => isDue(s)).length;
                const masteredCount = srs.filter(s => s.interval >= 7).length;
                
                document.getElementById('stat-due').innerText = dueCount;
                document.getElementById('stat-mastered').innerText = masteredCount;
                renderContainerStats(cards);
            } else {
                document.getElementById('stat-due').innerText = '-';
                document.getElementById('stat-mastered').innerText = '-';
                document.getElementById('container-stats').innerHTML = '';
            }
        }

        // ==================== DATABASE FUNCTIONS ====================
        
        function importJson() {
            if (!currentSubject || !currentSub) {
                alert("Please select a Subject and Topic from the sidebar first.");
                return;
            }

            const input = document.getElementById('json-input').value.trim();
            if (!input) {
                alert("Please enter some data first.");
                return;
            }
            
            let newCards = [];
            if (input.includes('-!-')) {
                newCards = parseTextFormat(input);
                if (newCards.length === 0) {
                    alert('No valid cards found. Make sure to use format: Question -!- Answer');
                    return;
                }
            } else {
                try {
                    newCards = JSON.parse(input);
                    if (!isValidCardArray(newCards)) {
                        alert('Invalid JSON format. Use: [{"q":"Question", "a":"Answer"}] OR text format: Question -!- Answer');
                        return;
                    }
                } catch (e) {
                    alert("Invalid format. Use either:\n\nText: Question -!- Answer\nor\nJSON: [{\"q\":\"Question\", \"a\":\"Answer\"}]");
                    return;
                }
            }

            if (!Array.isArray(cardContent[currentSubject][currentSub])) {
                cardContent[currentSubject][currentSub] = [];
            }

            const existingCards = cardContent[currentSubject][currentSub];
            let addedCount = 0;
            let duplicateCount = 0;
            
            newCards.forEach(newCard => {
                const isDuplicate = existingCards.some(existing => 
                    existing.q.trim().toLowerCase() === newCard.q.trim().toLowerCase()
                );
                
                if (!isDuplicate) {
                    existingCards.push(newCard);
                    addedCount++;
                } else {
                    duplicateCount++;
                }
            });

            ensureSRSDataExists();
            saveData();
            syncToCloud();
            
            let message = `Added ${addedCount} card${addedCount !== 1 ? 's' : ''}!`;
            if (duplicateCount > 0) {
                message += `\n${duplicateCount} duplicate${duplicateCount !== 1 ? 's' : ''} skipped.`;
            }
            alert(message);
            
            if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                const cards = cardContent[currentSubject][currentSub];
                const srs = srsData[currentSubject][currentSub];
                
                const cardsWithSRS = cards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[i],
                    _index: i
                }));
                
                dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
            }
            
            document.getElementById('json-input').value = '';
            renderDbList();
            renderCard();
            renderSidebar();
        }

        function importJsonFile(e) {
            if (!currentSubject || !currentSub) {
                alert("Please select a Subject and Topic from the sidebar first.");
                if (e && e.target) e.target.value = '';
                return;
            }
            
            const file = (e && e.target && e.target.files && e.target.files[0]) || null;
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const parsed = JSON.parse(String(ev.target.result));
                    if (!isValidCardArray(parsed)) {
                        alert('Invalid JSON shape in file. Provide an array of {q:string,a:string}.');
                        return;
                    }

                    if (!Array.isArray(cardContent[currentSubject][currentSub])) {
                        cardContent[currentSubject][currentSub] = [];
                    }
                    
                    const existingCards = cardContent[currentSubject][currentSub];
                    let addedCount = 0;
                    let duplicateCount = 0;
                    
                    parsed.forEach(newCard => {
                        const isDuplicate = existingCards.some(existing => 
                            existing.q.trim().toLowerCase() === newCard.q.trim().toLowerCase()
                        );
                        
                        if (!isDuplicate) {
                            existingCards.push(newCard);
                            addedCount++;
                        } else {
                            duplicateCount++;
                        }
                    });
                    
                    ensureSRSDataExists();
                    saveData();
                    syncToCloud();
                    
                    let message = `Imported ${addedCount} card${addedCount !== 1 ? 's' : ''} from file.`;
                    if (duplicateCount > 0) {
                        message += `\n${duplicateCount} duplicate${duplicateCount !== 1 ? 's' : ''} skipped.`;
                    }
                    alert(message);
                    
                    if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                        const cards = cardContent[currentSubject][currentSub];
                        const srs = srsData[currentSubject][currentSub];
                        
                        const cardsWithSRS = cards.map((card, i) => ({
                            q: card.q,
                            a: card.a,
                            srs: srs[i],
                            _index: i
                        }));
                        
                        dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                        shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
                    }
                    
                    renderDbList();
                    renderCard();
                    renderSidebar();
                } catch (err) {
                    alert('Unable to parse JSON file.');
                } finally {
                    if (e && e.target) e.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function exportJson() {
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !Array.isArray(cardContent[currentSubject][currentSub])) {
                alert('Select a Subject and Topic first to export.');
                return;
            }
            
            const data = cardContent[currentSubject][currentSub];
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = `${safeId(currentSubject)}-${safeId(currentSub)}.json`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function renderDbList() {
            const list = document.getElementById('db-list');
            list.innerHTML = '';
            
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !Array.isArray(cardContent[currentSubject][currentSub])) return;

            const cards = cardContent[currentSubject][currentSub];
            cards.forEach((c, idx) => {
                const item = document.createElement('div');
                item.className = 'db-item';
                item.innerHTML = `
                    <div>
                        <div class="db-key">${c.q}</div>
                        <div style="color:#888">${c.a}</div>
                    </div>
                    <button class="btn" onclick="deleteCard(${idx})" style="padding: 5px 10px; font-size: 0.8rem;">Delete</button>
                `;
                list.appendChild(item);
            });
        }

        function deleteCard(index) {
            if (!currentSubject || !currentSub) return;
            
            if (confirm("Delete this card?")) {
                cardContent[currentSubject][currentSub].splice(index, 1);
                if (srsData[currentSubject] && srsData[currentSubject][currentSub]) {
                    srsData[currentSubject][currentSub].splice(index, 1);
                }
                
                saveData();
                syncToCloud();
                renderDbList();
                renderSidebar();
                
                if (cardContent[currentSubject] && cardContent[currentSubject][currentSub]) {
                    const cards = cardContent[currentSubject][currentSub];
                    const srs = srsData[currentSubject][currentSub];
                    
                    const cardsWithSRS = cards.map((card, i) => ({
                        q: card.q,
                        a: card.a,
                        srs: srs[i],
                        _index: i
                    }));
                    
                    dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                    shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
                }
                
                renderCard();
            }
        }

        function clearAllCards() {
            if (!currentSubject || !currentSub) {
                alert("Please select a subject and topic first.");
                return;
            }
            
            if (confirm("Clear all cards in " + currentSubject + " > " + currentSub + "?")) {
                cardContent[currentSubject][currentSub] = [];
                if (srsData[currentSubject] && srsData[currentSubject][currentSub]) {
                    srsData[currentSubject][currentSub] = [];
                }
                
                saveData();
                syncToCloud();
                renderDbList();
                renderSidebar();
                shuffledCards = [];
                renderCard();
            }
        }

        // ==================== CONTAINER FUNCTIONS ====================
        
        function getContainerForIndex(index) {
            return Math.floor(index / CARDS_PER_CONTAINER);
        }
        
        function getContainerCards(containerNum) {
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !cardContent[currentSubject][currentSub]) {
                return [];
            }
            const allCards = cardContent[currentSubject][currentSub];
            const startIdx = containerNum * CARDS_PER_CONTAINER;
            const endIdx = Math.min(startIdx + CARDS_PER_CONTAINER, allCards.length);
            return allCards.slice(startIdx, endIdx);
        }
        
        function renderContainerSelector() {
            const container = document.getElementById('container-selector');
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !cardContent[currentSubject][currentSub]) {
                container.style.display = 'none';
                return;
            }
            const allCards = cardContent[currentSubject][currentSub];
            const numContainers = Math.ceil(allCards.length / CARDS_PER_CONTAINER);
            
            if (allCards.length <= CARDS_PER_CONTAINER) {
                container.style.display = 'none';
            } else {
                container.style.display = 'flex';
                container.innerHTML = '';
                
                const missedBtn = document.createElement('button');
                missedBtn.className = 'container-btn' + (reviewMissedMode ? ' active' : '');
                missedBtn.textContent = `Missed (${missedCardsThisSession.size})`;
                missedBtn.onclick = () => toggleReviewMissed();
                missedBtn.id = 'review-missed-btn';
                container.appendChild(missedBtn);
                
                const allBtn = document.createElement('button');
                allBtn.className = 'container-btn' + (currentContainer === 'all' && !reviewMissedMode ? ' active' : '');
                allBtn.textContent = 'All';
                allBtn.onclick = () => selectContainer('all');
                container.appendChild(allBtn);
                
                for (let i = 0; i < numContainers; i++) {
                    const btn = document.createElement('button');
                    const startIdx = i * CARDS_PER_CONTAINER;
                    const endIdx = Math.min(startIdx + CARDS_PER_CONTAINER, allCards.length);
                    const count = endIdx - startIdx;
                    btn.className = 'container-btn' + (currentContainer === i && !reviewMissedMode ? ' active' : '');
                    btn.textContent = `C${i + 1} (${count})`;
                    btn.onclick = () => selectContainer(i);
                    container.appendChild(btn);
                }
                
                const info = document.createElement('div');
                info.className = 'container-info';
                info.textContent = `${allCards.length} total cards â€¢ ${CARDS_PER_CONTAINER} cards per container`;
                container.appendChild(info);
            }
        }
        
        function selectContainer(containerIdentifier) {
            currentContainer = containerIdentifier;
            reviewMissedMode = false;
            cardIndex = 0;
            
            if (!currentSubject || !currentSub || !cardContent[currentSubject] || !cardContent[currentSubject][currentSub]) return;
            
            const cards = cardContent[currentSubject][currentSub];
            const srs = srsData[currentSubject][currentSub];
            
            if (containerIdentifier === 'all') {
                const cardsWithSRS = cards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[i],
                    _index: i
                }));
                
                dueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(dueCards.length > 0 ? dueCards : cardsWithSRS);
            } else {
                const containerCards = getContainerCards(containerIdentifier);
                const startIdx = containerIdentifier * CARDS_PER_CONTAINER;
                
                const cardsWithSRS = containerCards.map((card, i) => ({
                    q: card.q,
                    a: card.a,
                    srs: srs[startIdx + i],
                    _index: startIdx + i
                }));
                
                const containerDueCards = cardsWithSRS.filter(card => isDue(card.srs));
                shuffledCards = shuffleArray(containerDueCards.length > 0 ? containerDueCards : cardsWithSRS);
            }
            
            renderCard();
            renderContainerSelector();
        }
        
        function toggleReviewMissed() {
            if (missedCardsThisSession.size === 0) {
                alert('No missed cards in this session yet!');
                return;
            }
            
            reviewMissedMode = !reviewMissedMode;
            cardIndex = 0;
            
            if (reviewMissedMode) {
                const cards = cardContent[currentSubject][currentSub];
                const srs = srsData[currentSubject][currentSub];
                
                const missedCards = Array.from(missedCardsThisSession)
                    .map(idx => ({
                        q: cards[idx].q,
                        a: cards[idx].a,
                        srs: srs[idx],
                        _index: idx
                    }))
                    .filter(card => card.q);
                
                shuffledCards = shuffleArray(missedCards);
                currentContainer = 'all';
            } else {
                selectContainer(currentContainer);
            }
            
            renderCard();
            renderContainerSelector();
        }
        
        function renderContainerStats(allCards) {
            const statsContainer = document.getElementById('container-stats');
            const numContainers = Math.ceil(allCards.length / CARDS_PER_CONTAINER);
            
            if (numContainers <= 1) {
                statsContainer.innerHTML = '';
                return;
            }
            
            statsContainer.innerHTML = '<h3 style="margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Container Breakdown</h3>';
            
            for (let i = 0; i < numContainers; i++) {
                const startIdx = i * CARDS_PER_CONTAINER;
                const endIdx = Math.min(startIdx + CARDS_PER_CONTAINER, allCards.length);
                const containerSRS = srsData[currentSubject][currentSub].slice(startIdx, endIdx);
                
                const dueCount = containerSRS.filter(s => isDue(s)).length;
                const masteredCount = containerSRS.filter(s => s.interval >= 7).length;
                const totalCount = endIdx - startIdx;
                
                const statBox = document.createElement('div');
                statBox.className = 'container-stat';
                statBox.innerHTML = `
                    <div class="container-stat-header">Container ${i + 1} (${totalCount} cards)</div>
                    <div class="container-stat-detail">
                        ${masteredCount} mastered â€¢ ${dueCount} due today
                    </div>
                `;
                statsContainer.appendChild(statBox);
            }
        }

        // ==================== TAB SWITCHING ====================
        
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-view').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            element.classList.add('active');
            
            if (tabName === 'performance') {
                updateStats();
            }
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        
        document.addEventListener('keydown', (e) => {
            const tag = document.activeElement && document.activeElement.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA') return;

            const activeTab = document.querySelector('.tab-view.active');
            if (activeTab && activeTab.id === 'tab-flashcard') {
                if (e.code === 'Space' || e.code === 'Enter') {
                    e.preventDefault();
                    flipCard();
                } else if (e.code === 'ArrowRight' || e.code === 'KeyJ') {
                    e.preventDefault();
                    nextCard(true);
                } else if (e.code === 'ArrowLeft' || e.code === 'KeyF') {
                    e.preventDefault();
                    nextCard(false);
                }
            }
        });

        // ==================== INITIALIZATION ====================
        
        renderSidebar();
        loadSidebarState();
        
        setTimeout(() => {
            loadFromCloud();
        }, 1000);

    </script>
</body>
</html>